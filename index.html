<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeHub v4 - Integrated Terminal</title>
    
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Memuat Font Awesome untuk ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Memuat Chart.js untuk grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Memuat jsPDF & AutoTable untuk ekspor PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Memuat html2canvas untuk konversi HTML ke gambar (diperlukan untuk PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Gaya Kustom -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        :root {
            --bg-gradient: linear-gradient(135deg, #0F0A20, #1A1033, #2E0B4D, #4A148C);
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --card-bg: rgba(15, 10, 32, 0.4);
            --card-border: rgba(255, 255, 255, 0.05);
            --sidebar-bg: rgba(26, 16, 51, 0.8);
            --sidebar-border: rgba(192, 132, 252, 0.1);
            --input-bg: rgba(15, 10, 32, 0.5);
            --input-border: rgba(192, 132, 252, 0.2);
            --input-focus-border: #c084fc;
            --active-nav-bg: rgba(192, 132, 252, 0.2);
            --active-nav-border: #c084fc;
            --hover-nav-bg: rgba(192, 132, 252, 0.1);
            --hover-nav-border: #a855f7;
            --primary-brand: #c084fc;
        }

        body.light-mode {
            --bg-gradient: linear-gradient(135deg, #f3e8ff, #faf5ff, #f5f3ff);
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --card-bg: rgba(255, 255, 255, 0.8);
            --card-border: rgba(0, 0, 0, 0.1);
            --sidebar-bg: #ffffff;
            --sidebar-border: #e5e7eb;
            --input-bg: #f9fafb;
            --input-border: #d1d5db;
            --input-focus-border: #9333ea;
            --active-nav-bg: rgba(147, 51, 234, 0.1);
            --active-nav-border: #9333ea;
            --hover-nav-bg: rgba(147, 51, 234, 0.05);
            --hover-nav-border: #a855f7;
            --primary-brand: #9333ea;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-primary);
            transition: background 0.5s, color 0.5s;
            overflow-x: hidden; /* Mencegah scroll horizontal */
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .gradient-bg {
            background-size: 400% 400%;
            animation: gradientFlow 15s ease infinite;
        }
        body.light-mode .gradient-bg {
            animation: none;
        }
        
        .glass-effect {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 12px;
            border: 1px solid var(--card-border);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        body.light-mode .glass-effect {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .glass-effect:hover {
            border-color: rgba(192, 132, 252, 0.2);
        }

        .custom-input {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            width: 100%;
            transition: all 0.3s ease;
        }
        .custom-input:focus {
            outline: none;
            border-color: var(--input-focus-border);
            box-shadow: 0 0 10px var(--input-focus-border, 0.3);
        }
        .custom-input::placeholder {
            color: var(--text-secondary);
        }

        .custom-button {
            background: linear-gradient(90deg, #9333ea, #7e22ce);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(147, 51, 234, 0.3);
            border: none;
            cursor: pointer;
        }
        .custom-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(147, 51, 234, 0.5);
        }
        .custom-button-danger {
            background: linear-gradient(90deg, #ef4444, #dc2626);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        .custom-button-danger:hover {
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
        }

        .nav-item {
            transition: all 0.3s ease; 
            cursor: pointer; 
            padding: 0.75rem 1rem;
            margin: 0.25rem 0; 
            border-radius: 0.5rem; 
            border-left: 3px solid transparent;
        }
        .nav-item:hover { 
            background-color: var(--hover-nav-bg); 
            border-left-color: var(--hover-nav-border); 
        }
        .nav-item.active { 
            background-color: var(--active-nav-bg); 
            border-left-color: var(--active-nav-border); 
            color: var(--primary-brand); 
            font-weight: 500;
        }
        body.light-mode .nav-item.active {
            color: var(--primary-brand);
        }

        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.7); 
            backdrop-filter: blur(5px);
            z-index: 1000; 
            animation: fadeIn 0.3s ease; 
        }
        .modal.show { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .modal-content {
            max-width: 90vw; 
            max-height: 90vh; 
            overflow-y: auto; 
            animation: modalAppear 0.5s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modalAppear { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        
        .income { border-left: 4px solid #4ade80; }
        .expense { border-left: 4px solid #f472b6; }
        
        .task-item.completed { opacity: 0.6; text-decoration: line-through; }

        .hidden { display: none !important; }

        /* --- PERBAIKAN LAYOUT --- */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            height: 100vh; 
            overflow-y: auto; 
            position: fixed; 
            left: -250px; 
            top: 0; 
            width: 250px;
            background-color: var(--sidebar-bg);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--sidebar-border); 
            z-index: 100; 
            transition: left 0.3s ease, opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .sidebar.open { left: 0; }
        
        .overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.5); 
            z-index: 99; 
        }
        .overlay.show { display: block; }
        
        .main-content { 
            flex-grow: 1; /* Konten utama mengisi sisa ruang */
            width: 100%;
            transition: margin-left 0.3s ease; 
        }
        
        .main-content > .p-6 {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        
        /* Layout untuk Desktop (md dan lebih besar) */
        @media (min-width: 768px) { 
            .sidebar { 
                position: relative; /* Kembali ke alur normal dokumen */
                left: 0; 
                flex-shrink: 0; /* Mencegah sidebar menyusut */
            }
            .main-content {
                width: calc(100% - 250px);
            }
            #mobileMenuBtn, .overlay {
                display: none;
            }
        }
        
        /* Layout untuk Mobile (di bawah md) */
        @media (max-width: 767px) {
            .app-container {
                display: block;
            }
        }
        /* --- AKHIR PERBAIKAN LAYOUT --- */

        #bg-video, #bg-image-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -2;
            display: none;
        }
        #bg-image-layer {
            background-size: cover;
            background-position: center;
        }

        #mobileMenuBtn {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }

        /* Gaya untuk mode pratinjau transparan */
        body.preview-mode .sidebar,
        body.preview-mode .main-content > .p-6,
        body.preview-mode #mobileMenuBtn {
            opacity: 0;
            transform: translateY(15px);
            pointer-events: none;
        }

        /* Gaya untuk tombol rentang waktu chart */
        .range-btn {
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }
        .range-btn:hover {
            background-color: var(--hover-nav-bg);
            color: var(--text-primary);
        }
        .range-btn.active {
            background-color: var(--primary-brand);
            color: white;
            box-shadow: 0 2px 10px rgba(192, 132, 252, 0.4);
        }
        body.light-mode .range-btn.active {
            color: white;
        }

        /* Gaya untuk wadah chart baru */
        .chart-container {
            height: 350px;
            position: relative;
        }

        /* --- GAYA KHUSUS UNTUK DIARYAPP (MERGED & REFINED) --- */
        #diary-section .diary-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .editor-toolbar {
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-bottom: none;
            border-radius: 0.5rem 0.5rem 0 0;
            padding: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.25rem;
        }
        .editor-toolbar button, .editor-toolbar select {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-secondary);
            min-width: 36px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0 0.5rem;
        }
        .editor-toolbar button:hover, .editor-toolbar select:hover {
            background: var(--hover-nav-bg);
            color: var(--text-primary);
        }
        .editor-toolbar select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding-right: 1.5rem;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
        .toolbar-separator {
            width: 1px;
            height: 24px;
            background-color: var(--input-border);
            margin: 0 0.5rem;
        }
        
        #editorContent {
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            min-height: 300px;
            padding: 1rem;
            border-radius: 0 0 0.5rem 0.5rem;
            color: var(--text-primary);
            outline: none;
            max-height: 400px;
            overflow-y: auto;
        }
        #editorContent:focus {
            border-color: var(--input-focus-border);
        }
        #editorContent.dragover {
            border-color: var(--primary-brand);
            box-shadow: 0 0 10px var(--primary-brand);
        }
        #editorContent[contenteditable="true"]:empty:before {
            content: attr(placeholder);
            color: var(--text-secondary);
            pointer-events: none;
            display: block;
        }
        .note-item {
            border: 1px solid var(--card-border);
            transition: background-color 0.3s ease;
        }
        .note-item:hover {
            background-color: var(--hover-nav-bg);
        }
        .tag {
            background-color: var(--primary-brand);
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
        }
    </style>
</head>
<body class="gradient-bg">
    <!-- Elemen untuk background media -->
    <div id="bg-image-layer"></div>
    <video autoplay loop muted id="bg-video"></video>

    <!-- Mobile Menu Button -->
    <button id="mobileMenuBtn" class="fixed top-4 left-4 z-50 custom-button">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Overlay for mobile -->
    <div id="overlay" class="overlay"></div>

    <div class="app-container">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar">
            <div class="p-6">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center space-x-3">
                        <div id="logo-icon" class="w-10 h-10 bg-gradient-to-br from-purple-700 to-purple-900 rounded-full flex items-center justify-center cursor-pointer" title="Masuk Mode Pratinjau">
                            <i class="fas fa-rocket text-lg text-purple-200"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-purple-300">Uranus Space</h1>
                    </div>
                    <button id="themeToggle" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-purple-500/10 text-purple-300" title="Toggle Theme">
                        <i class="fas fa-sun"></i>
                    </button>
                </div>
                
                <div class="mb-6">
                    <label for="modeSelect" class="block text-sm font-medium mb-2 text-purple-300">Mode Terminal</label>
                    <select id="modeSelect" class="custom-input">
                        <option value="personal">Pribadi</option>
                        <option value="business">Bisnis</option>
                    </select>
                </div>
                
                <nav>
                    <div class="nav-item active" data-section="dashboard"><i class="fas fa-tachometer-alt mr-3 w-5"></i>Dashboard</div>
                    <div class="nav-item" data-section="finance"><i class="fas fa-wallet mr-3 w-5"></i>Keuangan</div>
                    <div class="nav-item" data-section="tasks"><i class="fas fa-tasks mr-3 w-5"></i>Rencana & Tugas</div>
                    <div class="nav-item" data-section="split"><i class="fas fa-receipt mr-3 w-5"></i>Split Bill</div>
                    <div class="nav-item" data-section="diary"><i class="fas fa-book mr-3 w-5"></i>My Diary Elite</div>
                    <div class="nav-item" data-section="settings"><i class="fas fa-cog mr-3 w-5"></i>Pengaturan</div>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="p-6 relative z-10">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="section">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h2 class="text-3xl font-bold text-purple-300">Dashboard</h2>
                        <div id="master-range-selector" class="flex items-center gap-1 bg-purple-900/30 p-1 rounded-md glass-effect">
                            <button data-range="7d" class="range-btn active" title="7 Hari">7H</button>
                            <button data-range="1m" class="range-btn" title="1 Bulan">1B</button>
                            <button data-range="3m" class="range-btn" title="3 Bulan">3B</button>
                            <button data-range="1y" class="range-btn" title="1 Tahun">1T</button>
                            <button data-range="all" class="range-btn" title="Selamanya">∞</button>
                            <button data-range="custom" class="range-btn" title="Pilih Rentang"><i class="fas fa-calendar-alt"></i></button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold mb-2 text-pink-400">Saldo Total</h3><p class="text-2xl font-bold" id="totalBalance">Rp 0</p></div>
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold mb-2 text-pink-400">Tugas Hari Ini</h3><p class="text-2xl font-bold" id="todayTasksCount">0</p></div>
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold mb-2 text-pink-400">Tugas Tertunda</h3><p class="text-2xl font-bold" id="pendingTasks">0</p></div>
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold mb-2 text-pink-400">Mode Aktif</h3><p class="text-2xl font-bold" id="activeMode">Pribadi</p></div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold text-blue-400 mb-4">Arus Kas</h3>
                            <canvas id="cashFlowChart"></canvas>
                        </div>
                        <div class="glass-effect p-6">
                             <h3 class="text-xl font-semibold text-pink-400 mb-4">Produktivitas</h3>
                            <canvas id="productivityChart"></canvas>
                        </div>
                    </div>

                    <div class="glass-effect p-6 mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-blue-400">Aktivitas Terkini</h3>
                        <div id="recentActivities" class="space-y-2"></div>
                    </div>

                    <h2 class="text-3xl font-bold mb-6 mt-10 text-purple-300">Analisis Mendalam</h2>
                    <div class="grid grid-cols-1 gap-6">
                        <!-- Analisis Gabungan -->
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold mb-4 text-purple-400">Analisis Gabungan Fitur</h3>
                            <div class="chart-container" style="height: 450px;">
                                <canvas id="combinedAnalysisChart"></canvas>
                            </div>
                        </div>

                        <!-- Analisis Keuangan -->
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold mb-4 text-blue-400">Analisis Keuangan</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-2">
                                    <p class="text-md font-medium text-purple-300 mb-2">Pemasukan vs Pengeluaran</p>
                                    <div class="chart-container h-64">
                                        <canvas id="incomeVsExpenseChart"></canvas>
                                    </div>
                                </div>
                                <div>
                                     <p class="text-md font-medium text-purple-300 mb-2">Alokasi Pengeluaran</p>
                                    <div class="chart-container h-64">
                                        <canvas id="spendingByCategoryChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Analisis Produktivitas -->
                        <div class="glass-effect p-6">
                             <h3 class="text-xl font-semibold mb-4 text-pink-400">Analisis Produktivitas</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-2">
                                    <p class="text-md font-medium text-purple-300 mb-2">Tren Penyelesaian Tugas</p>
                                    <div class="chart-container h-64">
                                        <canvas id="taskCompletionTrendChart"></canvas>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-md font-medium text-purple-300 mb-2">Distribusi Prioritas Tugas</p>
                                    <div class="chart-container h-64">
                                        <canvas id="taskPriorityDistributionChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Analisis Split Bill -->
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold mb-4 text-green-400">Analisis Split Bill</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <p class="text-md font-medium text-purple-300 mb-2">Total Pengeluaran per Orang</p>
                                    <div class="chart-container h-64">
                                        <canvas id="splitBillByUserChart"></canvas>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-md font-medium text-purple-300 mb-2">Frekuensi Split Bill</p>
                                    <div class="chart-container h-64">
                                        <canvas id="splitBillFrequencyChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Analisis Diary -->
                        <div class="glass-effect p-6">
                             <h3 class="text-xl font-semibold mb-4 text-blue-400">Analisis Diary</h3>
                             <p class="text-md font-medium text-purple-300 mb-2">Frekuensi Entri Diary</p>
                             <div class="chart-container h-72">
                                 <canvas id="diaryEntryFrequencyChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Finance Section -->
                <div id="finance-section" class="section hidden">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h2 class="text-3xl font-bold text-purple-300">Manajemen Keuangan</h2>
                        <div class="flex gap-2">
                            <button id="addTransactionBtn" class="custom-button"><i class="fas fa-plus mr-2"></i>Tambah</button>
                            <button id="exportFinanceBtn" class="custom-button custom-button-danger"><i class="fas fa-download mr-2"></i>Export PDF</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold text-green-400 mb-2">Pemasukan</h3><p class="text-2xl font-bold" id="totalIncome">Rp 0</p></div>
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold text-pink-400 mb-2">Pengeluaran</h3><p class="text-2xl font-bold" id="totalExpense">Rp 0</p></div>
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold text-blue-400 mb-2">Saldo</h3><p class="text-2xl font-bold" id="balance">Rp 0</p></div>
                    </div>

                    <div class="glass-effect p-4 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center">
                            <input type="text" id="searchTransaction" placeholder="Cari transaksi..." class="custom-input">
                            <select id="categoryFilter" class="custom-input"></select>
                            <select id="typeFilter" class="custom-input"></select>
                            <button id="financeDateFilterBtn" class="custom-button"><i class="fas fa-calendar-alt mr-2"></i>Filter Tanggal</button>
                        </div>
                    </div>

                    <div class="glass-effect p-6">
                        <h3 class="text-xl font-semibold mb-4 text-pink-400">Daftar Transaksi</h3>
                        <div id="transactionsList" class="space-y-2"></div>
                    </div>
                </div>
                
                <!-- Tasks & Plans Section -->
                <div id="tasks-section" class="section hidden">
                    <h2 class="text-3xl font-bold mb-6 text-purple-300">Rencana & Tugas</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left Column: Add Task & Pomodoro -->
                        <div class="lg:col-span-1 space-y-6">
                            <div class="glass-effect p-6">
                                <h3 class="text-xl font-semibold mb-4 text-blue-400">Tambah Tugas</h3>
                                <form id="taskForm" class="space-y-4">
                                    <div><label class="block text-sm font-medium mb-1">Tugas</label><input type="text" id="taskTitle" class="custom-input" required></div>
                                    <div><label class="block text-sm font-medium mb-1">Tanggal & Waktu</label><input type="datetime-local" id="taskDateTime" class="custom-input" required></div>
                                    <div><label class="block text-sm font-medium mb-1">Prioritas</label><select id="taskPriority" class="custom-input"><option value="low">Rendah</option><option value="medium">Sedang</option><option value="high">Tinggi</option></select></div>
                                    <button type="submit" class="custom-button w-full">Tambah Tugas</button>
                                </form>
                            </div>
                            <div class="glass-effect p-6 text-center">
                                <h3 class="text-xl font-semibold mb-4 text-pink-400">Pomodoro Timer</h3>
                                <div id="timerDisplay" class="text-5xl font-mono my-4">25:00</div>
                                <div class="flex gap-2 justify-center">
                                    <button id="startTimerBtn" class="custom-button bg-green-600 hover:bg-green-500"><i class="fas fa-play"></i></button>
                                    <button id="pauseTimerBtn" class="custom-button bg-yellow-600 hover:bg-yellow-500"><i class="fas fa-pause"></i></button>
                                    <button id="resetTimerBtn" class="custom-button custom-button-danger"><i class="fas fa-sync"></i></button>
                                </div>
                            </div>
                        </div>
                        <!-- Right Column: Task List & Calendar -->
                        <div class="lg:col-span-2 space-y-6">
                            <div class="glass-effect p-6">
                                 <h3 class="text-xl font-semibold mb-4 text-blue-400">Daftar Tugas</h3>
                                 <div id="taskList" class="space-y-3 max-h-96 overflow-y-auto"></div>
                            </div>
                            <div class="glass-effect p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <button id="prevMonth" class="custom-button !p-3"><i class="fas fa-chevron-left"></i></button>
                                    <span id="currentMonth" class="text-xl font-semibold text-pink-400"></span>
                                    <button id="nextMonth" class="custom-button !p-3"><i class="fas fa-chevron-right"></i></button>
                                </div>
                                <div id="calendar" class="grid grid-cols-7 gap-1"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Split Bill Section -->
                <div id="split-section" class="section hidden">
                    <h2 class="text-3xl font-bold mb-6 text-purple-300">Split Bill</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <div class="glass-effect p-6 mb-6">
                                <h3 class="text-xl font-semibold mb-4 text-blue-400">Kalkulator Bill</h3>
                                <form id="splitBillForm" class="space-y-4">
                                    <div><label class="block text-sm font-medium mb-1">Total Tagihan</label><input type="number" id="totalBill" class="custom-input" required></div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Tanggal</label>
                                        <input type="date" id="splitBillDate" class="custom-input" required>
                                    </div>
                                    <div><label class="block text-sm font-medium mb-1">Nama (pisahkan koma)</label><input type="text" id="peopleNames" class="custom-input" placeholder="Zedd, Jett, Omen" required></div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Persentase (opsional, pisahkan koma)</label>
                                        <input type="text" id="splitPercentages" class="custom-input" placeholder="25, 75">
                                        <p class="text-xs text-gray-400 mt-1">Kosongkan untuk membagi rata.</p>
                                    </div>
                                    <button type="submit" class="custom-button w-full">Hitung</button>
                                </form>
                            </div>
                            <div id="splitResultCard" class="glass-effect p-6 hidden">
                                <h3 class="text-xl font-semibold mb-4 text-pink-400">Hasil Pembagian</h3>
                                <div id="splitResult"></div>
                                <button id="exportSplitBtn" class="custom-button custom-button-danger w-full mt-4">Export PDF</button>
                            </div>
                        </div>
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold mb-4 text-blue-400">Riwayat Split Bill</h3>
                            <div id="splitHistory" class="space-y-3 max-h-[600px] overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
                                <!-- Diary Section (MERGED) -->
                <div id="diary-section" class="section hidden">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                         <h2 class="text-3xl font-bold text-purple-300">My Diary Elite</h2>
                         <button id="diaryAddNewNoteBtn" class="custom-button"><i class="fas fa-plus mr-2"></i>Catatan Baru</button>
                    </div>
                    <!-- Container utama untuk diary dengan layout vertikal -->
                    <div class="diary-container">
                        
                        <!-- 1. Editor & Actions -->
                        <div id="diaryEditorSection" class="glass-effect p-4">
                            <!-- Input Judul Baru -->
                            <input type="text" id="diaryTitleInput" class="custom-input mb-4" placeholder="Judul Catatan...">
                            
                            <!-- Modern Editor Toolbar -->
                            <div class="editor-toolbar">
                                <!-- Undo/Redo -->
                                <button data-command="undo" title="Undo"><i class="fas fa-undo"></i></button>
                                <button data-command="redo" title="Redo"><i class="fas fa-redo"></i></button>
                                <div class="toolbar-separator"></div>

                                <!-- Clipboard -->
                                <button data-command="copy" title="Copy"><i class="fas fa-copy"></i></button>
                                <button data-command="cut" title="Cut"><i class="fas fa-cut"></i></button>
                                <div class="toolbar-separator"></div>

                                <!-- Style Dropdown -->
                                <select id="formatBlock" class="toolbar-select" title="Gaya Teks">
                                    <option value="p">Normal</option>
                                    <option value="h1">Heading 1</option>
                                    <option value="h2">Heading 2</option>
                                    <option value="h3">Heading 3</option>
                                    <option value="blockquote">Quote</option>
                                </select>
                                <div class="toolbar-separator"></div>

                                <!-- Basic Formatting -->
                                <button data-command="bold" title="Bold"><i class="fas fa-bold"></i></button>
                                <button data-command="italic" title="Italic"><i class="fas fa-italic"></i></button>
                                <button data-command="underline" title="Underline"><i class="fas fa-underline"></i></button>
                                <button data-command="strikeThrough" title="Strikethrough"><i class="fas fa-strikethrough"></i></button>
                                
                                <div class="toolbar-separator"></div>

                                <!-- Alignment -->
                                <button data-command="justifyLeft" title="Rata Kiri"><i class="fas fa-align-left"></i></button>
                                <button data-command="justifyCenter" title="Rata Tengah"><i class="fas fa-align-center"></i></button>
                                <button data-command="justifyRight" title="Rata Kanan"><i class="fas fa-align-right"></i></button>
                                <button data-command="justifyFull" title="Rata Kanan Kiri"><i class="fas fa-align-justify"></i></button>
                                <div class="toolbar-separator"></div>

                                <!-- Lists & Indentation -->
                                <button data-command="insertOrderedList" title="Numbered List"><i class="fas fa-list-ol"></i></button>
                                <button data-command="insertUnorderedList" title="Bullet List"><i class="fas fa-list-ul"></i></button>
                                <div class="toolbar-separator"></div>

                                <!-- Insertions -->
                                <button data-command="createLink" title="Sisipkan Tautan"><i class="fas fa-link"></i></button>
                                <button id="diaryEmbedYouTubeBtn" title="Sematkan Video YouTube"><i class="fab fa-youtube"></i></button>
                                <!-- PERUBAHAN: Tombol TikTok ditambahkan di sini -->
                                <button id="diaryEmbedTikTokBtn" title="Sematkan Video TikTok"><i class="fab fa-tiktok"></i></button>
                                <button id="diaryUploadFileBtn" title="Unggah File"><i class="fas fa-upload"></i></button>
                                <input type="file" id="diaryFileUpload" class="hidden" accept=".txt,.json,.md,.pdf,image/*,video/*">
                                <div class="toolbar-separator"></div>
                                
                                <button data-command="removeFormat" title="Clear Formatting"><i class="fas fa-eraser"></i></button>
                            </div>
                            <div id="editorContent" contenteditable="true" class="prose max-w-none" placeholder="Mulai menulis atau jatuhkan file di sini..."></div>
                            
                            <!-- Kontrol Tanggal, Mood, dan Tags -->
                            <div class="flex flex-wrap gap-4 mt-4">
                                <input type="date" id="diaryDateFilter" class="custom-input flex-1">
                                <select id="diaryMoodSelector" class="custom-input flex-1">
                                    <option value="neutral">Netral</option>
                                    <option value="happy">Senang</option>
                                    <option value="sad">Sedih</option>
                                    <option value="excited">Bersemangat</option>
                                    <option value="angry">Marah</option>
                                </select>
                                <input type="text" id="diaryTagsInput" class="custom-input flex-1" placeholder="Tags, pisahkan koma">
                            </div>

                            <div class="flex flex-wrap gap-2 mt-4">
                                <button id="diarySaveNoteBtn" class="custom-button flex-grow"><i class="fas fa-save mr-2"></i>Simpan</button>
                                <button id="exportHTMLBtn" class="custom-button flex-grow" style="background: linear-gradient(90deg, #f97316, #ea580c);"><i class="fab fa-html5 mr-2"></i>HTML</button>
                                <button id="exportPDFBtn" class="custom-button flex-grow" style="background: linear-gradient(90deg, #ef4444, #dc2626);"><i class="fas fa-file-pdf mr-2"></i>PDF</button>
                                <button id="exportJSONBtn" class="custom-button flex-grow" style="background: linear-gradient(90deg, #22c55e, #16a34a);"><i class="fas fa-file-code mr-2"></i>JSON</button>
                                <button id="diaryClearEditorBtn" class="custom-button custom-button-danger"><i class="fas fa-eraser mr-2"></i>Bersihkan</button>
                            </div>
                        </div>

                        <!-- 2. Kontrol & Filter -->
                        <div class="glass-effect p-4 space-y-4">
                            <h3 class="font-semibold text-lg text-pink-400">Kontrol & Filter</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="search" id="diarySearchInput" class="custom-input" placeholder="Cari berdasarkan judul, isi, atau tag...">
                                <select id="diaryMoodFilter" class="custom-input">
                                    <option value="">Semua Mood</option>
                                    <option value="happy">Senang</option>
                                    <option value="sad">Sedih</option>
                                    <option value="neutral">Netral</option>
                                    <option value="excited">Bersemangat</option>
                                    <option value="angry">Marah</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- 3. Daftar Catatan -->
                        <div class="glass-effect p-4">
                            <h3 class="font-semibold text-lg text-pink-400 mb-2">Daftar Catatan</h3>
                            <div id="diaryNotesList" class="space-y-2 max-h-96 overflow-y-auto"></div>
                        </div>

                    </div>
                </div>
                
                         <!-- Settings Section -->
                <div id="settings-section" class="section hidden">
                    <h2 class="text-3xl font-bold mb-6 text-purple-300">Pengaturan</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold mb-4 text-blue-400">Backup & Restore</h3>
                            <div class="space-y-4">
                                <button id="backupData" class="custom-button w-full"><i class="fas fa-download mr-2"></i>Backup Data (.txt)</button>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Restore Data (.txt)</label>
                                    <input type="file" id="restoreFile" accept=".txt" class="custom-input">
                                    <button id="restoreData" class="custom-button custom-button-danger w-full mt-2"><i class="fas fa-upload mr-2"></i>Restore Data</button>
                                </div>
                                <button id="clearAllData" class="custom-button custom-button-danger w-full"><i class="fas fa-trash mr-2"></i>Hapus Semua Data</button>
                                
                                <div class="border-t border-purple-800 pt-4 mt-4">
                                     <h4 class="text-lg font-semibold mb-2 text-blue-400">Google Drive Backup</h4>
                                     <div id="loginBtnContainer"></div>
                                     <button id="backupBtn" class="custom-button w-full mt-2" disabled><i class="fab fa-google-drive mr-2"></i>Backup ke Drive</button>
                                     <div id="status" class="text-sm text-gray-400 mt-2"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <div class="glass-effect p-6">
                                <h3 class="text-xl font-semibold mb-4 text-pink-400">Ubah Latar Belakang</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label for="bg-upload-media" class="block text-sm font-medium mb-2">Pilih File (Gambar/Video)</label>
                                        <input type="file" id="bg-upload-media" class="custom-input" accept="image/*,video/*">
                                    </div>
                                    <button id="applyBgMediaBtn" class="custom-button w-full">Terapkan Latar Belakang</button>
                                    <button id="resetBgMediaBtn" class="custom-button custom-button-danger w-full">Reset Latar Belakang</button>
                                    <button id="toggleVideoSoundBtn" class="custom-button w-full" style="background: linear-gradient(90deg, #3b82f6, #2563eb);">
                                        <i class="fas fa-volume-mute mr-2"></i> <span>Aktifkan Suara Video</span>
                                    </button>
                                </div>
                            </div>
                            <div class="glass-effect p-6">
                                <h3 class="text-xl font-semibold mb-4 text-pink-400">Informasi Aplikasi</h3>
                                <div class="space-y-2 text-sm">
                                    <p><strong>Nama:</strong> LifeHub v4</p>
                                    <p><strong>Versi:</strong> 4.8.0-Drive-Backup</p>
                                    <p><strong>Fitur:</strong> Editor Teks Modern, TikTok & YouTube Embed, Analisis Data, Keuangan, Tugas, Pomodoro, Split Bill, Custom BG, Preview Mode, Google Drive Backup</p>
                                    <p><strong>Storage:</strong> LocalStorage (Data terenkripsi di terminal Anda)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="mainModal" class="modal"><div class="modal-content glass-effect p-8 w-full max-w-2xl"></div></div>
    <div id="confirmModal" class="modal">
        <div class="modal-content glass-effect p-8 w-full max-w-sm text-center">
            <h3 id="confirmTitle" class="text-xl font-semibold mb-4 text-pink-400">Konfirmasi</h3>
            <p id="confirmMessage" class="mb-6">Apakah Anda yakin?</p>
            <div class="flex gap-4">
                <button id="confirmYes" class="custom-button flex-1">Ya</button>
                <button id="confirmNo" class="custom-button custom-button-danger flex-1">Tidak</button>
            </div>
        </div>
    </div>
    <div id="dateRangeModal" class="modal">
        <div class="modal-content glass-effect p-8 w-full max-w-md">
            <h3 class="text-xl font-semibold mb-6 text-purple-400">Pilih Rentang Tanggal</h3>
            <div class="space-y-4">
                <div>
                    <label for="startDate" class="block text-sm font-medium mb-1">Tanggal Mulai</label>
                    <input type="date" id="startDate" class="custom-input">
                </div>
                <div>
                    <label for="endDate" class="block text-sm font-medium mb-1">Tanggal Selesai</label>
                    <input type="date" id="endDate" class="custom-input">
                </div>
            </div>
            <div class="flex gap-4 mt-8">
                <button id="applyDateRange" class="custom-button flex-1">Terapkan</button>
                <button id="cancelDateRange" class="custom-button custom-button-danger flex-1">Batal</button>
            </div>
        </div>
    </div>
    
    <!-- DiaryApp Modals -->
    <div id="diaryPasswordModal" class="modal show">
        <div class="modal-content glass-effect p-8 w-full max-w-sm text-center">
            <h3 class="text-xl font-semibold mb-4 text-pink-400">Diary Terkunci</h3>
            <p class="mb-4">Masukkan kata sandi untuk membuka.</p>
            <input type="password" id="diaryPasswordInput" class="custom-input mb-4">
            <div class="flex gap-2">
                <button id="diaryCheckPasswordBtn" class="custom-button flex-1">Buka</button>
                <button id="diarySetPasswordBtn" class="custom-button custom-button-danger">Atur Sandi Baru</button>
            </div>
        </div>
    </div>
    <div id="diaryPreviewModal" class="modal">
        <div class="modal-content glass-effect p-8 w-full max-w-3xl">
            <div id="diaryPreviewContent" class="prose max-w-none"></div>
            <button id="diaryClosePreviewBtn" class="custom-button mt-6">Tutup</button>
        </div>
    </div>

    <script>
        /**
         * LifeHub v4.8.0 - Integrated Terminal with Google Drive Backup
         * Author: Uranuspace
         * Description: A comprehensive life management tool with finance, tasks, split bill,
         * and a rich-text diary, now featuring Google Drive backup functionality.
         */

        // ====== GOOGLE DRIVE API CONFIG ======
        const CLIENT_ID = "175269804015-7agb1gr0nd6ah66co5qen34dd2mvtm68.apps.googleusercontent.com";
        const SCOPES = "https://www.googleapis.com/auth/drive.file";
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        /**
         * DiaryApp Class
         * Contains all logic, state, and functions for the diary application.
         * The editor has been upgraded with richer functionality.
         */
        class DiaryApp {
            constructor() {
                this.notes = [];
                this.currentNoteId = null;
                this.isAuthenticated = false;
            }

            init() {
                this.cacheDOMElements();
                this.bindEvents();
                this.checkAuthentication();
                this.loadNotes();
                setInterval(() => this.autoSave(), 30000); // Autosave every 30 seconds
            }

            cacheDOMElements() {
                this.dom = {
                    passwordModal: document.getElementById('diaryPasswordModal'),
                    passwordInput: document.getElementById('diaryPasswordInput'),
                    checkPasswordBtn: document.getElementById('diaryCheckPasswordBtn'),
                    setPasswordBtn: document.getElementById('diarySetPasswordBtn'),
                    addNewNoteBtn: document.getElementById('diaryAddNewNoteBtn'),
                    searchInput: document.getElementById('diarySearchInput'),
                    moodFilter: document.getElementById('diaryMoodFilter'),
                    dateFilter: document.getElementById('diaryDateFilter'),
                    editorSection: document.getElementById('diaryEditorSection'),
                    titleInput: document.getElementById('diaryTitleInput'),
                    editorToolbar: document.querySelector('#diaryEditorSection .editor-toolbar'),
                    editorContent: document.getElementById('editorContent'),
                    embedYouTubeBtn: document.getElementById('diaryEmbedYouTubeBtn'),
                    embedTikTokBtn: document.getElementById('diaryEmbedTikTokBtn'),
                    uploadFileBtn: document.getElementById('diaryUploadFileBtn'),
                    fileUpload: document.getElementById('diaryFileUpload'),
                    moodSelector: document.getElementById('diaryMoodSelector'),
                    tagsInput: document.getElementById('diaryTagsInput'),
                    saveNoteBtn: document.getElementById('diarySaveNoteBtn'),
                    clearEditorBtn: document.getElementById('diaryClearEditorBtn'),
                    notesList: document.getElementById('diaryNotesList'),
                    previewModal: document.getElementById('diaryPreviewModal'),
                    previewContent: document.getElementById('diaryPreviewContent'),
                    closePreviewBtn: document.getElementById('diaryClosePreviewBtn'),
                    formatBlockSelect: document.getElementById('formatBlock'),
                    exportHTMLBtn: document.getElementById('exportHTMLBtn'),
                    exportPDFBtn: document.getElementById('exportPDFBtn'),
                    exportJSONBtn: document.getElementById('exportJSONBtn'),
                };
            }

            bindEvents() {
                this.dom.checkPasswordBtn.addEventListener('click', () => this.checkPassword());
                this.dom.setPasswordBtn.addEventListener('click', () => this.setPassword());
                this.dom.addNewNoteBtn.addEventListener('click', () => this.addNewNote());
                
                this.dom.searchInput.addEventListener('input', () => this.filterNotes());
                this.dom.moodFilter.addEventListener('change', () => this.filterNotes());
                this.dom.dateFilter.addEventListener('change', () => this.saveNote());

                // Event listener for the entire toolbar
                this.dom.editorToolbar.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (button && button.dataset.command) {
                        e.preventDefault();
                        this.handleCommand(button.dataset.command);
                    }
                });
                
                // Specific event listener for non-button elements in the toolbar
                this.dom.formatBlockSelect.addEventListener('change', (e) => this.formatText('formatBlock', e.target.value));

                this.dom.embedYouTubeBtn.addEventListener('click', () => this.embedYouTube());
                this.dom.embedTikTokBtn.addEventListener('click', () => this.embedTikTok());

                this.dom.uploadFileBtn.addEventListener('click', () => this.dom.fileUpload.click());
                this.dom.fileUpload.addEventListener('change', (e) => this.handleFileUpload(e.target.files));

                // Drag and Drop Events
                this.dom.editorContent.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.dom.editorContent.classList.add('dragover');
                });
                this.dom.editorContent.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.dom.editorContent.classList.remove('dragover');
                });
                this.dom.editorContent.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.dom.editorContent.classList.remove('dragover');
                    this.handleFileUpload(e.dataTransfer.files);
                });

                this.dom.saveNoteBtn.addEventListener('click', () => this.saveNote(true)); // Manual save
                this.dom.clearEditorBtn.addEventListener('click', () => this.clearEditor());
                this.dom.exportHTMLBtn.addEventListener('click', () => this.exportContent('html'));
                this.dom.exportPDFBtn.addEventListener('click', () => this.exportContent('pdf'));
                this.dom.exportJSONBtn.addEventListener('click', () => this.exportContent('json'));

                this.dom.notesList.addEventListener('click', (e) => {
                    const target = e.target.closest('button, .note-item-clickable');
                    if (!target) return;
                    
                    const noteId = parseInt(target.dataset.id);
                    const action = target.dataset.action;

                    if (action === 'edit' || action === 'click-to-edit') {
                        e.stopPropagation();
                        this.editNote(noteId);
                    }
                    if (action === 'delete') {
                        e.stopPropagation();
                        this.deleteNote(noteId);
                    }
                    if (action === 'preview') {
                        e.stopPropagation();
                        this.previewNote(noteId);
                    }
                });
                this.dom.closePreviewBtn.addEventListener('click', () => this.closePreview());
            }

            checkAuthentication() {
                if (localStorage.getItem('diaryPassword')) {
                    this.dom.passwordModal.classList.add('show');
                } else {
                    this.isAuthenticated = true;
                    this.dom.passwordModal.classList.remove('show');
                }
            }

            checkPassword() {
                const savedPassword = localStorage.getItem('diaryPassword');
                if (this.dom.passwordInput.value === savedPassword) {
                    this.isAuthenticated = true;
                    this.dom.passwordModal.classList.remove('show');
                    showMessage('Diary terbuka!', 'success');
                } else {
                    showMessage('Kata sandi salah!', 'error');
                }
            }

            setPassword() {
                const password = prompt('Atur kata sandi baru:');
                if (password) {
                    localStorage.setItem('diaryPassword', password);
                    this.isAuthenticated = true;
                    this.dom.passwordModal.classList.remove('show');
                    showMessage('Kata sandi berhasil diatur!', 'success');
                }
            }
            
            handleCommand(command) {
                const simpleCommands = ['bold', 'italic', 'underline', 'strikeThrough', 'justifyLeft', 'justifyCenter', 'justifyRight', 'justifyFull', 'insertOrderedList', 'insertUnorderedList', 'indent', 'outdent', 'undo', 'redo', 'removeFormat', 'copy', 'cut'];

                if (simpleCommands.includes(command)) {
                    this.formatText(command);
                } else if (command === 'createLink') {
                    const url = prompt('Masukkan URL:', 'https://');
                    if (url) this.formatText(command, url);
                }
            }

            formatText(command, value = null) {
                document.execCommand(command, false, value);
                this.dom.editorContent.focus();
            }

            embedYouTube() {
                const url = prompt("Masukkan URL video YouTube:");
                if (!url) return;

                let videoId = null;
                const regexes = [
                    /(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([^&]+)/,
                    /(?:https?:\/\/)?(?:www\.)?youtu\.be\/([^?]+)/,
                    /(?:https?:\/\/)?(?:www\.)?youtube\.com\/embed\/([^?]+)/
                ];

                for (const regex of regexes) {
                    const match = url.match(regex);
                    if (match && match[1]) {
                        videoId = match[1];
                        break;
                    }
                }

                if (videoId) {
                    const embedHTML = `<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; margin: 1rem 0;">
                        <iframe 
                            src="https://www.youtube.com/embed/${videoId}" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen 
                            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 8px;">
                        </iframe>
                    </div><p><br></p>`;
                    this.formatText('insertHTML', embedHTML);
                } else {
                    showMessage("URL YouTube tidak valid.", "error");
                }
            }

            embedTikTok() {
                const url = prompt("Masukkan URL video TikTok:");
                if (!url) return;

                const regex = /tiktok\.com\/.*\/video\/(\d+)/;
                const match = url.match(regex);
                const videoId = match && match[1] ? match[1] : null;

                if (videoId) {
                    const embedHTML = `
                        <div style="position: relative; padding-bottom: 177.78%; /* Aspect Ratio 9:16 */ height: 0; overflow: hidden; max-width: 325px; margin: 1rem auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                            <iframe 
                                src="https://www.tiktok.com/embed/v2/${videoId}" 
                                frameborder="0" 
                                allow="autoplay; encrypted-media" 
                                allowfullscreen 
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
                            </iframe>
                        </div><p><br></p>`;
                    
                    this.formatText('insertHTML', embedHTML);
                    showMessage("Video TikTok berhasil disematkan!", "success");
                } else {
                    showMessage("URL TikTok tidak valid. Pastikan URL berisi '/video/...' dan ID video.", "error");
                }
            }

            handleFileUpload(files) {
                if (!files || files.length === 0) return;
                const file = files[0];
                const reader = new FileReader();

                reader.onload = (e) => {
                    const result = e.target.result;
                    let elementHTML = '';

                    if (file.type.startsWith('image/')) {
                        elementHTML = `<img src="${result}" style="max-width: 100%; height: auto; border-radius: 8px; margin: 1rem 0;" />`;
                    } else if (file.type.startsWith('video/')) {
                        elementHTML = `<video controls src="${result}" style="max-width: 100%; border-radius: 8px; margin: 1rem 0;"></video>`;
                    } else if (file.type === 'application/pdf') {
                        elementHTML = `<embed src="${result}" type="application/pdf" width="100%" height="500px" style="border-radius: 8px; margin: 1rem 0;" />`;
                    } else if (file.type.startsWith('text/') || file.name.endsWith('.md') || file.name.endsWith('.json')) {
                        const escapedText = result.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        elementHTML = `<pre style="background: rgba(0,0,0,0.2); border: 1px solid var(--input-border); padding: 1rem; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word;"><code>${escapedText}</code></pre>`;
                    } else {
                        showMessage(`Tipe file ${file.type} tidak didukung untuk pratinjau.`, 'error');
                        return;
                    }
                    
                    this.formatText('insertHTML', elementHTML + "<p><br></p>");
                };
                
                if (file.type.startsWith('text/') || file.name.endsWith('.md') || file.name.endsWith('.json')) {
                    reader.readAsText(file);
                } else {
                    reader.readAsDataURL(file);
                }
            }

            saveNote(isManual = false) {
                if (!this.isAuthenticated) {
                    if (isManual) showMessage('Silakan buka diary terlebih dahulu!', 'error');
                    return;
                }
                const title = this.dom.titleInput.value.trim();
                const content = this.dom.editorContent.innerHTML;
                const tags = this.dom.tagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag);
                const mood = this.dom.moodSelector.value;
                const date = this.dom.dateFilter.value || new Date().toISOString().split('T')[0];

                if (!title && !content.trim()) {
                    if (isManual) showMessage('Judul atau isi tidak boleh kosong.', 'error');
                    return;
                }
                
                const note = {
                    id: this.currentNoteId || Date.now(),
                    title: title,
                    content: content,
                    tags: tags,
                    mood: mood,
                    date: new Date(date).toISOString(),
                    lastModified: new Date().toISOString(),
                    wordCount: this.countWords(content)
                };

                if (this.currentNoteId) {
                    const index = this.notes.findIndex(n => n.id === this.currentNoteId);
                    this.notes[index] = note;
                } else {
                    this.notes.unshift(note);
                    this.currentNoteId = note.id;
                }
                
                this.saveToStorage();
                this.displayNotes();
                if (isManual) showMessage('Catatan disimpan!', 'success');
            }
            
            autoSave() {
                const title = this.dom.titleInput.value.trim();
                const content = this.dom.editorContent.innerHTML;
                if ((title || content.trim()) && this.currentNoteId) {
                    this.saveNote();
                    showMessage('Tersimpan otomatis', 'info');
                }
            }

            loadNotes() {
                const saved = localStorage.getItem('diaryNotes_v4.8');
                if (saved) {
                    this.notes = JSON.parse(saved);
                    this.displayNotes();
                }
            }

            saveToStorage() {
                localStorage.setItem('diaryNotes_v4.8', JSON.stringify(this.notes));
            }

            displayNotes(filteredNotes = null) {
                const notesToShow = (filteredNotes || this.notes).sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (notesToShow.length === 0) {
                    this.dom.notesList.innerHTML = '<div class="text-center text-gray-500 py-4">Tidak ada catatan.</div>';
                    return;
                }
                
                this.dom.notesList.innerHTML = notesToShow.map(note => `
                    <div class="note-item p-3 rounded-lg mb-2 cursor-pointer note-item-clickable" data-action="click-to-edit" data-id="${note.id}">
                        <div class="flex items-start justify-between mb-1">
                            <div>
                                <strong class="text-md text-purple-300">${note.title || 'Tanpa Judul'}</strong>
                                <span class="block text-xs text-gray-400">${this.formatDate(note.date)}</span>
                            </div>
                            <div class="flex gap-2">
                                <button data-action="preview" data-id="${note.id}" class="text-green-400 hover:text-green-300"><i class="fas fa-eye"></i></button>
                                <button data-action="delete" data-id="${note.id}" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="text-sm text-gray-400">${this.truncateContent(note.content, 80)}</div>
                    </div>
                `).join('');
            }

            editNote(id) {
                const note = this.notes.find(n => n.id === id);
                if (note) {
                    this.currentNoteId = id;
                    this.dom.titleInput.value = note.title;
                    this.dom.editorContent.innerHTML = note.content;
                    this.dom.tagsInput.value = note.tags.join(', ');
                    this.dom.moodSelector.value = note.mood;
                    this.dom.dateFilter.value = note.date.split('T')[0];
                    this.dom.titleInput.focus();
                    showMessage('Catatan dimuat untuk diedit', 'info');
                }
            }

            deleteNote(id) {
                showConfirm('Hapus Catatan?', 'Yakin ingin menghapus catatan ini secara permanen?', () => {
                    this.notes = this.notes.filter(n => n.id !== id);
                    this.saveToStorage();
                    this.displayNotes();
                    if (this.currentNoteId === id) {
                        this.clearEditor();
                    }
                    showMessage('Catatan dihapus!', 'success');
                });
            }

            previewNote(id) {
                const note = this.notes.find(n => n.id === id);
                if (note) {
                    this.dom.previewContent.innerHTML = `
                        <h2 class="font-bold text-2xl mb-2 text-purple-300">${note.title || 'Tanpa Judul'}</h2>
                        <p class="text-sm text-gray-400 mb-4">${this.formatDate(note.date)}</p>
                        <div class="prose max-w-none">${note.content}</div>
                    `;
                    this.dom.previewModal.classList.add('show');
                }
            }

            closePreview() {
                this.dom.previewModal.classList.remove('show');
            }

            clearEditor() {
                this.dom.titleInput.value = '';
                this.dom.editorContent.innerHTML = '';
                this.dom.tagsInput.value = '';
                this.dom.moodSelector.value = 'neutral';
                this.dom.dateFilter.value = new Date().toISOString().split('T')[0];
                this.currentNoteId = null;
            }

            addNewNote() {
                this.clearEditor();
                this.dom.titleInput.focus();
                showMessage('Editor siap untuk catatan baru.', 'info');
            }

            filterNotes() {
                const query = this.dom.searchInput.value.toLowerCase();
                const mood = this.dom.moodFilter.value;
                
                let filtered = this.notes;

                if (query) {
                    filtered = filtered.filter(note =>
                        (note.title && note.title.toLowerCase().includes(query)) ||
                        note.content.toLowerCase().includes(query) ||
                        note.tags.some(tag => tag.toLowerCase().includes(query))
                    );
                }
                if (mood) {
                    filtered = filtered.filter(note => note.mood === mood);
                }
                
                this.displayNotes(filtered);
            }

            exportContent(format) {
                const title = this.dom.titleInput.value.trim() || "Catatan Tanpa Judul";
                const content = this.dom.editorContent.innerHTML;
                const note = this.notes.find(n => n.id === this.currentNoteId);

                if (!content.trim()) {
                    showMessage("Tidak ada konten untuk diekspor.", "error");
                    return;
                }

                const filename = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.${format === 'json' ? 'txt' : format}`;

                if (format === 'html') {
                    const htmlContent = `<!DOCTYPE html><html lang="id"><head><meta charset="UTF-8"><title>${title}</title><style>body{font-family: sans-serif; line-height: 1.6; padding: 2rem;} img, video {max-width: 100%; height: auto;}</style></head><body><h1>${title}</h1>${content}</body></html>`;
                    this.downloadFile(filename, htmlContent, 'text/html');
                } else if (format === 'json') {
                    const jsonContent = JSON.stringify({
                        title: title,
                        content: content,
                        tags: note ? note.tags : [],
                        mood: note ? note.mood : 'neutral',
                        date: note ? note.date : new Date().toISOString()
                    }, null, 2);
                    this.downloadFile(filename, jsonContent, 'application/json');
                } else if (format === 'pdf') {
                    showMessage("Membuat PDF...", "info");
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    const tempContainer = document.createElement('div');
                    tempContainer.innerHTML = `<h1>${title}</h1>${content}`;
                    Object.assign(tempContainer.style, {
                        position: 'absolute',
                        left: '-9999px',
                        width: '700px',
                        padding: '20px',
                        color: '#000',
                        background: '#fff'
                    });
                    document.body.appendChild(tempContainer);
                    
                    html2canvas(tempContainer, { scale: 2 }).then(canvas => {
                        document.body.removeChild(tempContainer);
                        const imgData = canvas.toDataURL('image/png');
                        const imgProps = doc.getImageProperties(imgData);
                        const pdfWidth = doc.internal.pageSize.getWidth();
                        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                        let heightLeft = pdfHeight;
                        let position = 0;
                        
                        doc.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                        heightLeft -= doc.internal.pageSize.getHeight();

                        while (heightLeft >= 0) {
                            position = heightLeft - pdfHeight;
                            doc.addPage();
                            doc.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                            heightLeft -= doc.internal.pageSize.getHeight();
                        }
                        doc.save(filename);
                    }).catch(err => {
                        console.error("Gagal membuat PDF:", err);
                        showMessage("Gagal membuat PDF.", "error");
                        document.body.removeChild(tempContainer);
                    });
                }
            }

            downloadFile(filename, content, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }

            countWords(html) {
                const text = html.replace(/<[^>]*>/g, '');
                return text.trim().split(/\s+/).filter(Boolean).length;
            }

            formatDate(dateString) {
                return new Date(dateString).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });
            }

            truncateContent(html, length) {
                const text = html.replace(/<[^>]*>/g, '');
                if (text.length <= length) return text;
                return text.substring(0, length) + '...';
            }
        }


        // --- GLOBAL VARIABLES & STATE MANAGEMENT ---
        let currentSection = 'dashboard';
        let currentDate = new Date();
        let currentMode = 'personal';
        let timerInterval;
        let timerMinutes = 25;
        let timerSeconds = 0;
        let isTimerRunning = false;
        let touchStartX = 0;
        let touchEndX = 0;
        let isDragging = false;
        
        let masterDateRange = '7d';
        let customDateRange = { start: null, end: null };
        
        // --- DATA STORAGE ---
        const storage = {
            get: (key, defaultValue = null) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch {
                    return defaultValue;
                }
            },
            set: (key, value) => {
                localStorage.setItem(key, JSON.stringify(value));
            },
            getAppData: () => {
                return storage.get('lifeHubData_v4.8', {
                    currentMode: 'personal',
                    isLightMode: false,
                    isVideoMuted: true,
                    personal: { transactions: [], tasks: [], splitBills: [] },
                    business: { transactions: [], tasks: [], splitBills: [] }
                });
            },
            saveAppData: (data) => {
                storage.set('lifeHubData_v4.8', data);
            }
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            
            const diaryApp = new DiaryApp();
            diaryApp.init();

            // Initialize Google Sign-In
            initializeGoogleSignIn();
        });

        function initializeApp() {
            const appData = storage.getAppData();
            currentMode = appData.currentMode || 'personal';
            document.getElementById('modeSelect').value = currentMode;
            
            if (appData.isLightMode) {
                document.body.classList.add('light-mode');
            }
            updateThemeUI(appData.isLightMode);

            document.getElementById('bg-video').muted = appData.isVideoMuted;
            updateVideoSoundUI();
            
            const splitBillDateInput = document.getElementById('splitBillDate');
            if (splitBillDateInput) {
                splitBillDateInput.value = new Date().toISOString().split('T')[0];
            }
            
            switchSection('dashboard');
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-item').forEach(item => item.addEventListener('click', () => switchSection(item.dataset.section)));
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
            document.getElementById('overlay').addEventListener('click', closeMobileMenu);
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('modeSelect').addEventListener('change', switchMode);
            document.getElementById('logo-icon').addEventListener('click', enterPreviewMode);
            document.getElementById('addTransactionBtn').addEventListener('click', () => showTransactionModal());
            document.getElementById('exportFinanceBtn').addEventListener('click', exportFinancePDF);
            document.getElementById('searchTransaction').addEventListener('input', filterAndRenderTransactions);
            document.getElementById('categoryFilter').addEventListener('change', filterAndRenderTransactions);
            document.getElementById('typeFilter').addEventListener('change', filterAndRenderTransactions);
            document.getElementById('financeDateFilterBtn').addEventListener('click', () => showDateRangeModal('finance'));
            document.getElementById('taskForm').addEventListener('submit', saveTask);
            document.getElementById('startTimerBtn').addEventListener('click', startTimer);
            document.getElementById('pauseTimerBtn').addEventListener('click', pauseTimer);
            document.getElementById('resetTimerBtn').addEventListener('click', resetTimer);
            document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
            document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));
            document.getElementById('splitBillForm').addEventListener('submit', calculateSplitBill);
            document.getElementById('backupData').addEventListener('click', backupData);
            document.getElementById('restoreData').addEventListener('click', restoreData);
            document.getElementById('clearAllData').addEventListener('click', () => {
                showConfirm('Hapus Semua Data?', 'Operasi ini tidak dapat diurungkan. Anda yakin ingin menghapus semua data personal dan bisnis?', clearAllDataConfirmed);
            });
            document.getElementById('applyBgMediaBtn').addEventListener('click', applyUploadedMedia);
            document.getElementById('resetBgMediaBtn').addEventListener('click', resetBackgroundMedia);
            document.getElementById('toggleVideoSoundBtn').addEventListener('click', toggleVideoSound);
            document.body.addEventListener('touchstart', handleTouchStart, { passive: true });
            document.body.addEventListener('touchend', handleTouchEnd);
            document.body.addEventListener('mousedown', handleMouseDown);
            document.body.addEventListener('mouseup', handleMouseUp);
            setupMasterRangeSelector();
            document.getElementById('applyDateRange').addEventListener('click', applyDateRange);
            document.getElementById('cancelDateRange').addEventListener('click', () => document.getElementById('dateRangeModal').classList.remove('show'));
            document.getElementById('backupBtn').addEventListener('click', backupToDrive);
        }

        // --- GOOGLE DRIVE INTEGRATION ---
        function initializeGoogleSignIn() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // defined later
            });
            gisInited = true;
            
            // Render the login button
            google.accounts.id.initialize({
                client_id: CLIENT_ID,
                callback: handleCredentialResponse
            });
            google.accounts.id.renderButton(
                document.getElementById("loginBtnContainer"),
                { theme: "outline", size: "large", type: "standard" }
            );
        }

        function handleCredentialResponse(response) {
            // This is for Sign In with Google, which gives an ID token.
            // For Drive API, we need an access token. We will request it when needed.
            document.getElementById("status").innerText = "Login berhasil. Siap untuk backup.";
            document.getElementById("backupBtn").disabled = false;
        }

        function backupToDrive() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                document.getElementById('status').innerText = 'Token diterima, memulai backup...';
                await performBackup(resp.access_token);
            };
        
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        async function performBackup(accessToken) {
            const allData = {
                lifeHub: storage.get('lifeHubData_v4.8'),
                diary: storage.get('diaryNotes_v4.8')
            };

            if (!allData.lifeHub && !allData.diary) {
                showMessage("Tidak ada data untuk di-backup.", "error");
                return;
            }

            const fileContent = JSON.stringify(allData, null, 2);
            const file = new Blob([fileContent], { type: "application/json" });
            const metadata = {
                'name': `Uranuspace_Backup_${new Date().toISOString().slice(0,10)}.json`,
                'mimeType': 'application/json'
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            try {
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name', {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                    body: form
                });
                const result = await response.json();
                if (result.error) {
                    throw new Error(result.error.message);
                }
                document.getElementById("status").innerText = `Backup berhasil! File: ${result.name}`;
                showMessage("Backup ke Google Drive berhasil!", "success");
            } catch (error) {
                console.error("Error backing up to Drive:", error);
                document.getElementById("status").innerText = `Error: ${error.message}`;
                showMessage("Gagal backup ke Google Drive.", "error");
            }
        }

        // --- PREVIEW MODE LOGIC ---
        function enterPreviewMode() { document.body.classList.add('preview-mode'); }
        function handleGestureEnd() {
            const swipeThreshold = 70;
            const deltaX = touchEndX - touchStartX;
            if (document.querySelector('.modal.show')) return;
            if (deltaX < -swipeThreshold) {
                document.body.classList.remove('preview-mode');
            }
        }
        function handleTouchStart(e) { touchStartX = e.changedTouches[0].screenX; }
        function handleTouchEnd(e) { touchEndX = e.changedTouches[0].screenX; handleGestureEnd(); }
        function handleMouseDown(e) {
            if (e.button !== 0 || e.target.closest('button, input, select, textarea, a, .modal')) return;
            isDragging = true;
            touchStartX = e.screenX;
        }
        function handleMouseUp(e) {
            if (!isDragging) return;
            isDragging = false;
            touchEndX = e.screenX;
            handleGestureEnd();
        }

        // --- UI, THEME & NAVIGATION ---
        function switchSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(section + '-section').classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`[data-section="${section}"]`).classList.add('active');
            currentSection = section;

            switch(section) {
                case 'dashboard': loadDashboard(); break;
                case 'finance': loadFinancePage(); break;
                case 'tasks': loadTasksPage(); break;
                case 'split': loadSplitPage(); break;
                case 'diary': /* DiaryApp handles its own loading */ break;
            }
            closeMobileMenu();
        }
        
        function switchMode(e) {
            currentMode = e.target.value;
            let appData = storage.getAppData();
            appData.currentMode = currentMode;
            storage.saveAppData(appData);
            switchSection(currentSection);
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            let appData = storage.getAppData();
            appData.isLightMode = isLight;
            storage.saveAppData(appData);
            updateThemeUI(isLight);
        }

        function updateThemeUI(isLight) {
            const icon = document.querySelector('#themeToggle i');
            icon.classList.toggle('fa-sun', !isLight);
            icon.classList.toggle('fa-moon', isLight);
            
            if (currentSection === 'dashboard') {
                refreshDashboardData();
            }
        }

        function toggleMobileMenu() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('overlay').classList.toggle('show'); }
        function closeMobileMenu() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('overlay').classList.remove('show'); }

        // --- DASHBOARD ---
        function loadDashboard() {
            const appData = storage.getAppData();
            const modeData = appData[currentMode];
            
            const balance = modeData.transactions.reduce((sum, t) => sum + (t.type === 'income' ? t.amount : -t.amount), 0);
            const today = new Date().toISOString().split('T')[0];
            const todayTasks = modeData.tasks.filter(p => p.datetime && p.datetime.startsWith(today) && !p.completed).length;
            const pendingTasks = modeData.tasks.filter(t => !t.completed).length;

            document.getElementById('totalBalance').textContent = formatCurrency(balance);
            document.getElementById('todayTasksCount').textContent = todayTasks;
            document.getElementById('pendingTasks').textContent = pendingTasks;
            document.getElementById('activeMode').textContent = currentMode === 'personal' ? 'Pribadi' : 'Bisnis';
            
            refreshDashboardData();
        }
        
        function refreshDashboardData() {
            updateDashboardCharts();
            loadAnalysisCharts();
            loadRecentActivities();
        }

        function loadRecentActivities() {
            const appData = storage.getAppData();
            const modeData = appData[currentMode];
            const activities = [];

            const filteredTransactions = filterDataByRange(modeData.transactions, masterDateRange, 'date');
            const filteredTasks = filterDataByRange(modeData.tasks, masterDateRange, 'datetime');
            const filteredSplits = filterDataByRange(modeData.splitBills, masterDateRange, 'date');
            
            filteredTransactions.forEach(t => activities.push({ type: 'transaction', icon: t.type === 'income' ? 'fa-arrow-up text-green-500' : 'fa-arrow-down text-pink-500', text: `${t.type === 'income' ? 'Pemasukan' : 'Pengeluaran'}: ${formatCurrency(t.amount)}`, time: t.date }));
            filteredTasks.forEach(p => activities.push({ type: 'task', icon: 'fa-calendar-check text-blue-500', text: `Tugas: ${p.title}`, time: p.datetime }));
            filteredSplits.forEach(s => activities.push({ type: 'split', icon: 'fa-receipt text-green-500', text: `Split Bill: ${formatCurrency(s.totalBill)}`, time: s.date }));

            activities.sort((a, b) => new Date(b.time) - new Date(a.time));
            const container = document.getElementById('recentActivities');
            container.innerHTML = activities.length > 0 ? activities.slice(0, 15).map(activity => `<div class="flex items-center justify-between p-2 hover:bg-purple-500/10 rounded"><div class="flex items-center"><i class="fas ${activity.icon} mr-3"></i><span>${activity.text}</span></div><span class="text-sm text-gray-400">${formatDate(activity.time)}</span></div>`).join('') : '<p class="text-gray-500">Tidak ada aktivitas dalam rentang waktu ini.</p>';
        }

        // --- FINANCE ---
        function loadFinancePage() {
            populateFinanceFilters();
            filterAndRenderTransactions();
            updateFinanceSummary();
        }
        
        function updateFinanceSummary() {
            const appData = storage.getAppData();
            const transactions = appData[currentMode].transactions;
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            document.getElementById('totalIncome').textContent = formatCurrency(income);
            document.getElementById('totalExpense').textContent = formatCurrency(expense);
            document.getElementById('balance').textContent = formatCurrency(income - expense);
        }

        function filterAndRenderTransactions() {
            const appData = storage.getAppData();
            let transactions = appData[currentMode].transactions;
            
            const search = document.getElementById('searchTransaction').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const type = document.getElementById('typeFilter').value;
            
            if (search) transactions = transactions.filter(t => t.description.toLowerCase().includes(search));
            if (category) transactions = transactions.filter(t => t.category === category);
            if (type) transactions = transactions.filter(t => t.type === type);
            
            if (customDateRange.start && customDateRange.end) {
                transactions = transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate >= new Date(customDateRange.start) && tDate <= new Date(customDateRange.end);
                });
            }
            
            displayTransactions(transactions);
        }

        function displayTransactions(transactions) {
            const container = document.getElementById('transactionsList');
            if (transactions.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">Belum ada transmisi data</p>';
                return;
            }
            container.innerHTML = [...transactions].reverse().map(t => `
                <div class="p-4 rounded-md flex justify-between items-center hover:bg-purple-500/10 cursor-pointer ${t.type}" onclick="showTransactionModal('${t.id}')">
                    <div class="flex items-center">
                        <i class="fas ${getTransactionIcon(t.category)} mr-4 text-xl"></i>
                        <div>
                            <h4 class="font-semibold">${t.description}</h4>
                            <p class="text-sm text-gray-400">${getCategoryName(t.category)} • ${formatDate(t.date)}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold font-mono ${t.type === 'income' ? 'text-green-500' : 'text-pink-500'}">${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}</p>
                        <button onclick="confirmDeleteTransaction('${t.id}', event)" class="text-red-500 hover:text-red-400 ml-2 text-xs"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`).join('');
        }

        function showTransactionModal(id = null) {
            const appData = storage.getAppData();
            const transaction = id ? appData[currentMode].transactions.find(t => t.id === id) : null;
            const content = `
                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold text-purple-600">${id ? 'Edit' : 'Tambah'} Transaksi</h3><button class="closeModal text-gray-400 hover:text-purple-600"><i class="fas fa-times"></i></button></div>
                <form id="transactionForm" class="space-y-4">
                    <input type="hidden" id="transactionId" value="${id || ''}">
                    <div><label class="block text-sm font-medium mb-1">Tipe</label><select id="transactionType" class="custom-input" required>${['income', 'expense'].map(o => `<option value="${o}" ${transaction?.type === o ? 'selected' : ''}>${o === 'income' ? 'Pemasukan' : 'Pengeluaran'}</option>`).join('')}</select></div>
                    <div><label class="block text-sm font-medium mb-1">Jumlah</label><input type="number" id="transactionAmount" class="custom-input" value="${transaction?.amount || ''}" required></div>
                    <div><label class="block text-sm font-medium mb-1">Kategori</label><select id="transactionCategory" class="custom-input" required>${Object.keys(getCategoryName()).map(c => `<option value="${c}" ${transaction?.category === c ? 'selected' : ''}>${getCategoryName(c)}</option>`).join('')}</select></div>
                    <div><label class="block text-sm font-medium mb-1">Deskripsi</label><input type="text" id="transactionDescription" class="custom-input" value="${transaction?.description || ''}" required></div>
                    <div><label class="block text-sm font-medium mb-1">Tanggal</label><input type="date" id="transactionDate" class="custom-input" value="${transaction?.date || new Date().toISOString().split('T')[0]}" required></div>
                    <div class="flex gap-2 mt-6"><button type="submit" class="custom-button flex-1">Simpan</button><button type="button" class="closeModal custom-button custom-button-danger">Batal</button></div>
                </form>`;
            showModal(content);
            document.getElementById('transactionForm').addEventListener('submit', saveTransaction);
        }

        function saveTransaction(e) {
            e.preventDefault();
            const id = document.getElementById('transactionId').value || generateId();
            const newTransaction = {
                id,
                type: document.getElementById('transactionType').value,
                amount: parseFloat(document.getElementById('transactionAmount').value),
                category: document.getElementById('transactionCategory').value,
                description: document.getElementById('transactionDescription').value,
                date: document.getElementById('transactionDate').value,
            };

            let appData = storage.getAppData();
            if (document.getElementById('transactionId').value) {
                const index = appData[currentMode].transactions.findIndex(t => t.id === id);
                if (index > -1) appData[currentMode].transactions[index] = newTransaction;
            } else {
                appData[currentMode].transactions.push(newTransaction);
            }
            storage.saveAppData(appData);
            loadFinancePage();
            closeModal();
            showMessage("Transaksi disimpan!", "success");
        }

        function confirmDeleteTransaction(id, event) {
            event.stopPropagation();
            showConfirm('Hapus Transaksi?', 'Yakin ingin menghapus transmisi data ini?', () => deleteTransaction(id));
        }

        function deleteTransaction(id) {
            let appData = storage.getAppData();
            appData[currentMode].transactions = appData[currentMode].transactions.filter(t => t.id !== id);
            storage.saveAppData(appData);
            loadFinancePage();
        }

        function populateFinanceFilters() {
            const appData = storage.getAppData();
            const categories = [...new Set(appData[currentMode].transactions.map(t => t.category))];
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="">Semua Kategori</option>' + categories.map(c => `<option value="${c}">${getCategoryName(c)}</option>`).join('');
            
            const typeFilter = document.getElementById('typeFilter');
            typeFilter.innerHTML = '<option value="">Semua Tipe</option><option value="income">Pemasukan</option><option value="expense">Pengeluaran</option>';
        }

        // --- TASKS & PLANS ---
        function loadTasksPage() {
            renderTasks();
            generateCalendar();
        }

        function renderTasks() {
            const appData = storage.getAppData();
            const tasks = appData[currentMode].tasks;
            const list = document.getElementById('taskList');
            list.innerHTML = '';
            
            const sortedTasks = [...tasks].sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
            
            if (sortedTasks.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center">Tidak ada tugas. Waktunya bersantai!</p>';
                return;
            }

            sortedTasks.forEach(task => {
                const item = document.createElement('div');
                item.className = `task-item p-3 rounded-lg flex justify-between items-center hover:bg-purple-500/10 ${task.completed ? 'completed' : ''}`;
                const priorityColor = { high: '#f472b6', medium: '#fbbf24', low: '#4ade80' };
                
                item.innerHTML = `
                    <div class="flex items-center">
                        <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask('${task.id}')" class="w-5 h-5 rounded bg-purple-900/50 border-purple-400 text-purple-600 focus:ring-purple-500">
                        <div class="ml-4">
                            <strong class="block">${task.title}</strong>
                            <small class="text-gray-400">${formatDateTime(task.datetime)} | <span style="color: ${priorityColor[task.priority]}">●</span> ${task.priority}</small>
                        </div>
                    </div>
                    <button onclick="confirmDeleteTask('${task.id}')" class="text-red-500 hover:text-red-400"><i class="fas fa-trash"></i></button>
                `;
                list.appendChild(item);
            });
        }

        function saveTask(e) {
            e.preventDefault();
            const task = {
                id: generateId(),
                title: document.getElementById('taskTitle').value,
                datetime: document.getElementById('taskDateTime').value,
                priority: document.getElementById('taskPriority').value,
                completed: false,
            };
            
            let appData = storage.getAppData();
            appData[currentMode].tasks.push(task);
            storage.saveAppData(appData);
            
            renderTasks();
            generateCalendar();
            document.getElementById('taskForm').reset();
            showMessage("Tugas ditambahkan!", "success");
        }

        function toggleTask(id) {
            let appData = storage.getAppData();
            const task = appData[currentMode].tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                storage.saveAppData(appData);
                renderTasks();
                generateCalendar();
            }
        }
        
        function confirmDeleteTask(id) {
            showConfirm('Hapus Tugas?', 'Yakin ingin menghapus tugas ini?', () => deleteTask(id));
        }

        function deleteTask(id) {
            let appData = storage.getAppData();
            appData[currentMode].tasks = appData[currentMode].tasks.filter(t => t.id !== id);
            storage.saveAppData(appData);
            renderTasks();
            generateCalendar();
        }

        // --- CALENDAR ---
        function generateCalendar() {
            const calendar = document.getElementById('calendar');
            document.getElementById('currentMonth').textContent = new Intl.DateTimeFormat('id-ID', { month: 'long', year: 'numeric' }).format(currentDate);
            calendar.innerHTML = '';
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const appData = storage.getAppData();
            const tasks = appData[currentMode].tasks;

            const days = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
            days.forEach(day => calendar.innerHTML += `<div class="text-center font-bold text-purple-400 text-sm">${day}</div>`);
            
            for (let i = 0; i < firstDay; i++) calendar.innerHTML += '<div></div>';
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayTasks = tasks.filter(t => t.datetime && t.datetime.startsWith(dateStr));
                const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
                
                let dayClass = 'text-center p-2 border border-transparent rounded-md transition-colors duration-300 relative';
                if (isToday) dayClass += ' border-purple-400 bg-purple-500/10';

                let priorityIndicator = '';
                if (dayTasks.length > 0) {
                    const hasHigh = dayTasks.some(t => t.priority === 'high' && !t.completed);
                    const hasMedium = dayTasks.some(t => t.priority === 'medium' && !t.completed);
                    const hasLow = dayTasks.some(t => t.priority === 'low' && !t.completed);

                    let indicatorColor = '';
                    if (hasHigh) indicatorColor = '#f472b6';
                    else if (hasMedium) indicatorColor = '#fbbf24';
                    else if (hasLow) indicatorColor = '#4ade80';
                    
                    if (indicatorColor) {
                        priorityIndicator = `<span class="absolute top-1 right-1 h-2 w-2 rounded-full" style="background-color: ${indicatorColor};"></span>`;
                    }
                }

                calendar.innerHTML += `<div class="${dayClass}">${day}${priorityIndicator}</div>`;
            }
        }
        
        function changeMonth(dir) {
            currentDate.setMonth(currentDate.getMonth() + dir);
            generateCalendar();
        }

        // --- POMODORO TIMER ---
        function startTimer() {
            if (isTimerRunning) return;
            isTimerRunning = true;
            timerInterval = setInterval(() => {
                if (timerSeconds === 0) {
                    if (timerMinutes === 0) {
                        resetTimer();
                        showMessage("Pomodoro Selesai!", "success");
                        return;
                    }
                    timerMinutes--;
                    timerSeconds = 59;
                } else {
                    timerSeconds--;
                }
                updateTimerDisplay();
            }, 1000);
        }

        function pauseTimer() { isTimerRunning = false; clearInterval(timerInterval); }
        function resetTimer() { pauseTimer(); timerMinutes = 25; timerSeconds = 0; updateTimerDisplay(); }
        function updateTimerDisplay() { document.getElementById('timerDisplay').textContent = `${String(timerMinutes).padStart(2, '0')}:${String(timerSeconds).padStart(2, '0')}`; }

        // --- SPLIT BILL ---
        function loadSplitPage() { 
            document.getElementById('splitBillDate').value = new Date().toISOString().split('T')[0];
            renderSplitHistory(); 
        }

        function calculateSplitBill(e) {
            e.preventDefault();
            const totalBill = parseFloat(document.getElementById('totalBill').value);
            const billDate = document.getElementById('splitBillDate').value;
            const peopleNames = document.getElementById('peopleNames').value.split(',').map(name => name.trim()).filter(name => name);
            const percentagesStr = document.getElementById('splitPercentages').value;
            const percentages = percentagesStr ? percentagesStr.split(',').map(p => parseFloat(p.trim())) : [];

            if (peopleNames.length === 0) {
                showMessage('Harap masukkan setidaknya satu nama.', 'error');
                return;
            }

            let results;

            if (percentages.length > 0) {
                if (percentages.length !== peopleNames.length) {
                    showMessage('Jumlah nama dan persentase harus sama.', 'error');
                    return;
                }
                const totalPercentage = percentages.reduce((sum, p) => sum + p, 0);
                if (Math.round(totalPercentage) !== 100) {
                    showMessage(`Total persentase harus 100%, bukan ${totalPercentage}%.`, 'error');
                    return;
                }
                if (percentages.some(isNaN)) {
                    showMessage('Mohon masukkan persentase yang valid.', 'error');
                    return;
                }
                results = peopleNames.map((name, index) => ({
                    name,
                    amount: (totalBill * percentages[index]) / 100,
                    percentage: percentages[index]
                }));
            } else {
                const amountPerPerson = totalBill / peopleNames.length;
                results = peopleNames.map(name => ({ name, amount: amountPerPerson }));
            }
            
            const splitBill = { id: generateId(), totalBill, results, date: billDate, type: percentages.length > 0 ? 'custom' : 'equal' };
            let appData = storage.getAppData();
            appData[currentMode].splitBills.push(splitBill);
            storage.saveAppData(appData);

            displaySplitResults(results, totalBill, billDate);
            renderSplitHistory();
            document.getElementById('splitBillForm').reset();
            document.getElementById('splitBillDate').value = new Date().toISOString().split('T')[0];
        }

        function displaySplitResults(results, totalBill, date) {
            const resultDiv = document.getElementById('splitResult');
            resultDiv.innerHTML = `<h4 class="font-bold mb-2">Total: ${formatCurrency(totalBill)}</h4>` + results.map(r => `
                <div class="flex justify-between p-2 border-b border-purple-900/50">
                    <span>${r.name} ${r.percentage ? `(${r.percentage}%)` : ''}</span>
                    <strong>${formatCurrency(r.amount)}</strong>
                </div>
            `).join('');
            document.getElementById('splitResultCard').classList.remove('hidden');
            document.getElementById('exportSplitBtn').onclick = () => exportSplitBillPDF(results, totalBill, date);
        }

        function renderSplitHistory() {
            const appData = storage.getAppData();
            const history = appData[currentMode].splitBills;
            const container = document.getElementById('splitHistory');
            container.innerHTML = [...history].reverse().map(split => `
                <div class="p-3 rounded-md border border-purple-900/50 hover:bg-purple-500/10">
                    <div class="flex justify-between items-center">
                        <div>
                            <strong class="block text-blue-400">${formatCurrency(split.totalBill)}</strong>
                            <small class="text-gray-400">${formatDate(split.date)} | ${split.results.length} orang | <span class="font-semibold ${split.type === 'custom' ? 'text-pink-400' : 'text-green-400'}">${split.type === 'custom' ? 'Kustom' : 'Merata'}</span></small>
                        </div>
                        <button onclick="confirmDeleteSplit('${split.id}')" class="text-red-500 hover:text-red-400"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`).join('') || '<p class="text-gray-500 text-center">Tidak ada riwayat.</p>';
        }
        
        function confirmDeleteSplit(id) {
            showConfirm('Hapus Riwayat?', 'Yakin ingin menghapus riwayat split bill ini?', () => deleteSplit(id));
        }

        function deleteSplit(id) {
            let appData = storage.getAppData();
            appData[currentMode].splitBills = appData[currentMode].splitBills.filter(s => s.id !== id);
            storage.saveAppData(appData);
            renderSplitHistory();
        }

        // --- SETTINGS & DATA MANAGEMENT ---
        function backupData() {
            const data = storage.get('lifeHubData_v4.8');
            if (!data) {
                showMessage("Tidak ada data untuk di-backup.", "error");
                return;
            }
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lifehub-backup-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showMessage("Backup berhasil!", "success");
        }

        function restoreData() {
            const file = document.getElementById('restoreFile').files[0];
            if (!file) {
                showMessage("Pilih file untuk restore.", "error");
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.personal && data.business) {
                        storage.saveAppData(data);
                        initializeApp();
                        showMessage("Restore berhasil!", "success");
                    } else {
                        throw new Error("Invalid file structure");
                    }
                } catch (err) {
                    showMessage("File backup korup atau tidak valid.", "error");
                }
            };
            reader.readAsText(file);
        }

        function clearAllDataConfirmed() {
            localStorage.removeItem('lifeHubData_v4.8');
            localStorage.removeItem('diaryNotes_v4.8'); // Also clear diary data
            initializeApp();
            showMessage("Semua data telah dihapus.", "success");
        }
        
        // --- BACKGROUND MEDIA ---
        function applyUploadedMedia() {
            const bgUploadMediaInput = document.getElementById('bg-upload-media');
            const selectedMediaFile = bgUploadMediaInput.files[0];

            if (!selectedMediaFile) {
                showMessage('Silakan pilih file terlebih dahulu!', 'error');
                return;
            }
            
            const appData = storage.getAppData();
            const fileUrl = URL.createObjectURL(selectedMediaFile);
            const bgVideo = document.getElementById('bg-video');
            const bgImageLayer = document.getElementById('bg-image-layer');

            resetBackgrounds();

            if (selectedMediaFile.type.startsWith('image/')) {
                bgImageLayer.style.backgroundImage = `url('${fileUrl}')`;
                bgImageLayer.style.display = 'block';
                document.body.classList.remove('gradient-bg');
                showMessage('Gambar diterapkan sebagai background.', 'success');
            } else if (selectedMediaFile.type.startsWith('video/')) {
                bgVideo.src = fileUrl;
                bgVideo.muted = appData.isVideoMuted;
                bgVideo.style.display = 'block';
                bgVideo.play().catch(e => console.error("Gagal memutar video:", e));
                document.body.classList.remove('gradient-bg');
                showMessage('Video diterapkan sebagai background.', 'success');
            } else {
                showMessage('Format file tidak didukung. Harap pilih gambar atau video.', 'error');
            }
        }
        
        function resetBackgroundMedia() {
            resetBackgrounds();
            document.getElementById('bg-upload-media').value = '';
            document.body.classList.add('gradient-bg');
            showMessage('Background direset.', 'info');
        }

        function resetBackgrounds() {
            const bgVideo = document.getElementById('bg-video');
            const bgImageLayer = document.getElementById('bg-image-layer');
            
            bgVideo.pause();
            bgVideo.removeAttribute('src');
            bgVideo.style.display = 'none';

            bgImageLayer.style.backgroundImage = 'none';
            bgImageLayer.style.display = 'none';
        }

        function toggleVideoSound() {
            const video = document.getElementById('bg-video');
            video.muted = !video.muted;
            
            let appData = storage.getAppData();
            appData.isVideoMuted = video.muted;
            storage.saveAppData(appData);

            updateVideoSoundUI();
            showMessage(video.muted ? 'Suara video dimatikan.' : 'Suara video diaktifkan.', 'info');
        }

        function updateVideoSoundUI() {
            const appData = storage.getAppData();
            const btn = document.getElementById('toggleVideoSoundBtn');
            const icon = btn.querySelector('i');
            const text = btn.querySelector('span');

            if (appData.isVideoMuted) {
                icon.classList.remove('fa-volume-up');
                icon.classList.add('fa-volume-mute');
                text.textContent = 'Aktifkan Suara Video';
            } else {
                icon.classList.remove('fa-volume-mute');
                icon.classList.add('fa-volume-up');
                text.textContent = 'Matikan Suara Video';
            }
        }

        // --- PDF EXPORT ---
        function exportFinancePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const appData = storage.getAppData();
            const transactions = appData[currentMode].transactions;

            doc.setFontSize(20);
            doc.text('Laporan Keuangan', 20, 20);
            doc.setFontSize(12);
            doc.text(`Mode: ${currentMode === 'personal' ? 'Pribadi' : 'Bisnis'}`, 20, 30);
            doc.text(`Tanggal: ${formatDate(new Date().toISOString())}`, 20, 40);

            const tableData = transactions.map(t => [
                formatDate(t.date),
                t.description,
                getCategoryName(t.category),
                t.type === 'income' ? formatCurrency(t.amount) : '',
                t.type === 'expense' ? formatCurrency(t.amount) : ''
            ]);
            
            doc.autoTable({
                head: [['Tanggal', 'Deskripsi', 'Kategori', 'Pemasukan', 'Pengeluaran']],
                body: tableData,
                startY: 50
            });

            doc.save(`laporan-keuangan-${currentMode}.pdf`);
        }
        
        function exportSplitBillPDF(results, totalBill, date) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text('Laporan Split Bill', 20, 20);
            doc.setFontSize(12);
            doc.text(`Total Tagihan: ${formatCurrency(totalBill)}`, 20, 30);
            doc.text(`Tanggal: ${formatDate(date)}`, 20, 38);
            
            const tableData = results.map(r => [r.name, formatCurrency(r.amount)]);
            doc.autoTable({
                head: [['Nama', 'Jumlah Bayar']],
                body: tableData,
                startY: 45
            });
            doc.save('split-bill.pdf');
        }
        
        // --- CHARTS ---
        function getChartColors() {
            const isLight = document.body.classList.contains('light-mode');
            return {
                gridColor: isLight ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)',
                tickColor: isLight ? '#4b5563' : '#d1d5db',
                legendColor: isLight ? '#1f2937' : '#d1d5db',
                incomeColor: isLight ? '#22c55e' : '#4ade80',
                expenseColor: isLight ? '#ec4899' : '#f472b6',
                taskColor: isLight ? '#3b82f6' : '#60a5fa',
                incomeBg: isLight ? 'rgba(34, 197, 94, 0.2)' : 'rgba(74, 222, 128, 0.2)',
                expenseBg: isLight ? 'rgba(236, 72, 153, 0.2)' : 'rgba(244, 114, 182, 0.2)',
                taskBg: isLight ? 'rgba(59, 130, 246, 0.7)' : 'rgba(96, 165, 250, 0.7)',
            };
        }

        function updateDashboardCharts() {
            updateCashFlowChart();
            updateProductivityChart();
        }

        function updateCashFlowChart() {
            const ctx = document.getElementById('cashFlowChart')?.getContext('2d');
            if (!ctx) return;
            if (window.cashFlowChartInstance) window.cashFlowChartInstance.destroy();

            const colors = getChartColors();
            const appData = storage.getAppData();
            const transactions = filterDataByRange(appData[currentMode].transactions, masterDateRange, 'date');
            
            const { labels, dataPoints } = getTimeBuckets(masterDateRange, transactions, 'date');
            
            const incomeData = new Array(labels.length).fill(0);
            const expenseData = new Array(labels.length).fill(0);

            transactions.forEach(t => {
                const itemDate = new Date(t.date + 'T00:00:00Z');
                let bucketIndex = -1;
                for (let i = dataPoints.length - 1; i >= 0; i--) {
                    if (itemDate >= dataPoints[i]) {
                        bucketIndex = i;
                        break;
                    }
                }
                if (bucketIndex !== -1) {
                    if (t.type === 'income') incomeData[bucketIndex] += t.amount;
                    else expenseData[bucketIndex] += t.amount;
                }
            });

            window.cashFlowChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'Pemasukan', data: incomeData, borderColor: colors.incomeColor, backgroundColor: colors.incomeBg, tension: 0.3, fill: true },
                        { label: 'Pengeluaran', data: expenseData, borderColor: colors.expenseColor, backgroundColor: colors.expenseBg, tension: 0.3, fill: true }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { color: colors.tickColor } },
                        x: { grid: { color: colors.gridColor }, ticks: { color: colors.tickColor } }
                    },
                    plugins: { legend: { labels: { color: colors.legendColor } } }
                }
            });
        }

        function updateProductivityChart() {
            const ctx = document.getElementById('productivityChart')?.getContext('2d');
            if (!ctx) return;
            if (window.productivityChartInstance) window.productivityChartInstance.destroy();

            const colors = getChartColors();
            const appData = storage.getAppData();
            const tasks = filterDataByRange(appData[currentMode].tasks, masterDateRange, 'datetime');

            const { labels, dataPoints } = getTimeBuckets(masterDateRange, tasks, 'datetime');
            const completedCounts = new Array(labels.length).fill(0);
            
            tasks.filter(t => t.completed && t.datetime).forEach(t => {
                const itemDate = new Date(t.datetime);
                let bucketIndex = -1;
                for (let i = dataPoints.length - 1; i >= 0; i--) {
                    if (itemDate >= dataPoints[i]) {
                        bucketIndex = i;
                        break;
                    }
                }
                if (bucketIndex !== -1) completedCounts[bucketIndex]++;
            });

            window.productivityChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Tugas Selesai',
                        data: completedCounts,
                        backgroundColor: colors.taskBg,
                        borderColor: colors.taskColor,
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1, color: colors.tickColor }, grid: { color: colors.gridColor } },
                        x: { ticks: { color: colors.tickColor }, grid: { color: colors.gridColor } }
                    },
                    plugins: { legend: { labels: { color: colors.legendColor } } }
                }
            });
        }
        
        function loadAnalysisCharts() {
            const appData = storage.getAppData();
            const modeData = appData[currentMode];
            const colors = getChartColors();
            const diaryNotes = JSON.parse(localStorage.getItem('diaryNotes_v4.8') || '[]');

            Chart.defaults.color = colors.legendColor;
            Chart.defaults.font.family = "'Poppins', 'sans-serif'";

            const chartIds = ['combinedAnalysisChart', 'incomeVsExpenseChart', 'spendingByCategoryChart', 'taskCompletionTrendChart', 'taskPriorityDistributionChart', 'splitBillByUserChart', 'splitBillFrequencyChart', 'diaryEntryFrequencyChart'];
            chartIds.forEach(id => {
                if (window[id + 'Instance']) window[id + 'Instance'].destroy();
            });
            
            const filteredPersonalTransactions = filterDataByRange(appData.personal.transactions, masterDateRange, 'date');
            const filteredPersonalTasks = filterDataByRange(appData.personal.tasks, masterDateRange, 'datetime');
            const filteredPersonalSplits = filterDataByRange(appData.personal.splitBills, masterDateRange, 'date');
            
            const filteredBusinessTransactions = filterDataByRange(appData.business.transactions, masterDateRange, 'date');
            const filteredBusinessTasks = filterDataByRange(appData.business.tasks, masterDateRange, 'datetime');
            const filteredBusinessSplits = filterDataByRange(appData.business.splitBills, masterDateRange, 'date');
            
            const filteredDiary = filterDataByRange(diaryNotes, masterDateRange, 'date');

            const personalData = {
                finance: filteredPersonalTransactions.length, tasks: filteredPersonalTasks.length,
                splitBill: filteredPersonalSplits.length, diary: filteredDiary.length,
            };
            const businessData = {
                finance: filteredBusinessTransactions.length, tasks: filteredBusinessTasks.length,
                splitBill: filteredBusinessSplits.length, diary: 0, // Diary is not per-mode
            };

            const combinedCtx = document.getElementById('combinedAnalysisChart').getContext('2d');
            window.combinedAnalysisChartInstance = new Chart(combinedCtx, {
                type: 'radar',
                data: {
                    labels: ['Keuangan', 'Tugas', 'Split Bill', 'Diary'],
                    datasets: [
                        { label: 'Pribadi', data: [personalData.finance, personalData.tasks, personalData.splitBill, personalData.diary], backgroundColor: 'rgba(0, 136, 255, 0.2)', borderColor: '#0088ff', borderWidth: 2, pointBackgroundColor: '#0088ff', pointRadius: 4, },
                        { label: 'Bisnis', data: [businessData.finance, businessData.tasks, businessData.splitBill, businessData.diary], backgroundColor: 'rgba(255, 0, 110, 0.2)', borderColor: '#ff006e', borderWidth: 2, pointBackgroundColor: '#ff006e', pointRadius: 4, }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20, font: { size: 14 } } } },
                    scales: { r: { angleLines: { color: colors.gridColor }, grid: { color: colors.gridColor }, pointLabels: { font: { size: 14, weight: '600' }, color: colors.tickColor }, ticks: { backdropColor: 'rgba(0,0,0,0.5)', color: colors.tickColor, stepSize: 5 }, suggestedMin: 0 } }
                }
            });

            const filteredFinance = filterDataByRange(modeData.transactions, masterDateRange, 'date');
            const financialData = processTimeSeriesData(filteredFinance, 'date', masterDateRange);
            const incomeVsExpenseCtx = document.getElementById('incomeVsExpenseChart').getContext('2d');
            window.incomeVsExpenseChartInstance = new Chart(incomeVsExpenseCtx, {
                type: 'bar', data: { labels: financialData.labels, datasets: [ { label: 'Pemasukan', data: financialData.income, backgroundColor: 'rgba(74, 222, 128, 0.7)' }, { label: 'Pengeluaran', data: financialData.expense, backgroundColor: 'rgba(244, 114, 182, 0.7)' } ] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { grid: { color: colors.gridColor } } } }
            });

            const spendingCtx = document.getElementById('spendingByCategoryChart').getContext('2d');
            const { labels: categoryLabels, data: spendingData } = processSpendingByCategory(filteredFinance);
            window.spendingByCategoryChartInstance = new Chart(spendingCtx, {
                type: 'doughnut', data: { labels: categoryLabels, datasets: [{ data: spendingData, backgroundColor: ['#f472b6', '#60a5fa', '#fbbf24', '#4ade80', '#c084fc', '#a1a1aa', '#f87171', '#818cf8'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const filteredTasks = filterDataByRange(modeData.tasks, masterDateRange, 'datetime');
            const taskData = processTimeSeriesData(filteredTasks, 'datetime', masterDateRange);
            const taskTrendCtx = document.getElementById('taskCompletionTrendChart').getContext('2d');
            window.taskCompletionTrendChartInstance = new Chart(taskTrendCtx, {
                type: 'line', data: { labels: taskData.labels, datasets: [ { label: 'Dibuat', data: taskData.created, borderColor: '#60a5fa', tension: 0.3 }, { label: 'Selesai', data: taskData.completed, borderColor: '#4ade80', tension: 0.3 } ] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { stepSize: 1 } } } }
            });

            const taskPriorityCtx = document.getElementById('taskPriorityDistributionChart').getContext('2d');
            const { labels: priorityLabels, data: priorityData } = processTaskPriorities(filteredTasks);
            window.taskPriorityDistributionChartInstance = new Chart(taskPriorityCtx, {
                type: 'pie', data: { labels: priorityLabels, datasets: [{ data: priorityData, backgroundColor: ['#f472b6', '#fbbf24', '#4ade80'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const filteredSplits = filterDataByRange(modeData.splitBills, masterDateRange, 'date');
            const splitByUserCtx = document.getElementById('splitBillByUserChart').getContext('2d');
            const { labels: userLabels, data: userSpendingData } = processSplitBillByUser(filteredSplits);
            window.splitBillByUserChartInstance = new Chart(splitByUserCtx, {
                type: 'bar', data: { labels: userLabels, datasets: [{ label: 'Total Pengeluaran', data: userSpendingData, backgroundColor: 'rgba(74, 222, 128, 0.7)', borderRadius: 5 }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { grid: { color: colors.gridColor } }, y: { grid: { display: false } } }, plugins: { legend: { display: false } } }
            });

            const splitFreqData = processTimeSeriesData(filteredSplits, 'date', masterDateRange);
            const splitFreqCtx = document.getElementById('splitBillFrequencyChart').getContext('2d');
            window.splitBillFrequencyChartInstance = new Chart(splitFreqCtx, {
                type: 'line', data: { labels: splitFreqData.labels, datasets: [{ label: 'Jumlah Split Bill', data: splitFreqData.count, borderColor: '#22d3ee', tension: 0.3, fill: true, backgroundColor: 'rgba(34, 211, 238, 0.2)' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { stepSize: 1 } } } }
            });

            const diaryData = processTimeSeriesData(filteredDiary, 'date', masterDateRange);
            const diaryCtx = document.getElementById('diaryEntryFrequencyChart').getContext('2d');
            window.diaryEntryFrequencyChartInstance = new Chart(diaryCtx, {
                type: 'bar', data: { labels: diaryData.labels, datasets: [{ label: 'Jumlah Entri', data: diaryData.count, backgroundColor: 'rgba(192, 132, 252, 0.7)', borderRadius: 5 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { stepSize: 1 } } } }
            });
        }

        // --- UTILITY & HELPER FUNCTIONS ---
        function processTimeSeriesData(data, dateKey, range) {
            const { labels, dataPoints } = getTimeBuckets(range, data, dateKey);
            const isFinance = data.length > 0 && 'type' in data[0] && 'amount' in data[0];
            const isTask = data.length > 0 && 'completed' in data[0];
            let results = {};
            if (isFinance) {
                results.income = new Array(labels.length).fill(0);
                results.expense = new Array(labels.length).fill(0);
            } else if (isTask) {
                results.created = new Array(labels.length).fill(0);
                results.completed = new Array(labels.length).fill(0);
            } else {
                results.count = new Array(labels.length).fill(0);
            }
            data.forEach(item => {
                if (!item[dateKey]) return;
                const itemDate = new Date(item[dateKey]);
                let bucketIndex = -1;
                for (let i = dataPoints.length - 1; i >= 0; i--) {
                    if (itemDate >= dataPoints[i]) {
                        bucketIndex = i;
                        break;
                    }
                }
                if (bucketIndex !== -1) {
                    if (isFinance) {
                        if (item.type === 'income') results.income[bucketIndex] += item.amount;
                        else results.expense[bucketIndex] += item.amount;
                    } else if (isTask) {
                        results.created[bucketIndex]++;
                        if (item.completed) results.completed[bucketIndex]++;
                    } else {
                        results.count[bucketIndex]++;
                    }
                }
            });
            return { labels, ...results };
        }

        function processSpendingByCategory(transactions) {
            const spending = {};
            transactions.filter(t => t.type === 'expense').forEach(t => {
                const categoryName = getCategoryName(t.category);
                spending[categoryName] = (spending[categoryName] || 0) + t.amount;
            });
            const sortedSpending = Object.entries(spending).sort(([,a],[,b]) => b-a);
            return {
                labels: sortedSpending.map(([label]) => label),
                data: sortedSpending.map(([,data]) => data)
            };
        }

        function processTaskPriorities(tasks) {
            const priorities = { high: 0, medium: 0, low: 0 };
            tasks.filter(t => !t.completed).forEach(t => {
                priorities[t.priority]++;
            });
            return {
                labels: ['Tinggi', 'Sedang', 'Rendah'],
                data: [priorities.high, priorities.medium, priorities.low]
            };
        }

        function processSplitBillByUser(splitBills) {
            const userTotals = {};
            splitBills.forEach(bill => {
                bill.results.forEach(person => {
                    userTotals[person.name] = (userTotals[person.name] || 0) + person.amount;
                });
            });
            const sortedUsers = Object.entries(userTotals).sort(([,a],[,b]) => b-a);
            return {
                labels: sortedUsers.map(([label]) => label),
                data: sortedUsers.map(([,data]) => data)
            };
        }

        function getGroupingUnit(range) {
            if (typeof range === 'object' && range.type === 'custom') {
                const diffTime = Math.abs(new Date(range.end) - new Date(range.start));
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays > 90) return 'month';
                if (diffDays > 30) return 'week';
                return 'day';
            }
            if (['7d', '1m'].includes(range)) return 'day';
            if (range === '3m') return 'week';
            if (['1y', 'all'].includes(range)) return 'month';
            return 'day';
        }

        function getTimeBuckets(range, data, dateKey) {
            const labels = [];
            const dataPoints = [];
            const now = new Date();
            const unit = getGroupingUnit(range);
            let startDate, endDate = new Date(now);
            if (typeof range === 'object' && range.type === 'custom') {
                startDate = new Date(range.start + 'T00:00:00Z');
                endDate = new Date(range.end + 'T23:59:59Z');
            } else if (range === 'all') {
                const validData = data.filter(d => d[dateKey]);
                if (validData.length === 0) {
                    startDate = new Date();
                    startDate.setMonth(startDate.getMonth() - 1);
                } else {
                    startDate = new Date(validData.reduce((min, p) => (p[dateKey] < min) ? p[dateKey] : min, validData[0][dateKey]));
                }
            } else {
                startDate = new Date(now);
                if (range === '7d') startDate.setDate(now.getDate() - 6);
                else if (range === '1m') startDate.setDate(now.getDate() - 29);
                else if (range === '3m') startDate.setMonth(now.getMonth() - 3);
                else if (range === '1y') startDate.setFullYear(now.getFullYear() - 1);
            }
            startDate.setHours(0, 0, 0, 0);
            let current = new Date(startDate);
            while (current <= endDate) {
                dataPoints.push(new Date(current));
                if (unit === 'day') {
                    labels.push(current.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' }));
                    current.setDate(current.getDate() + 1);
                } else if (unit === 'week') {
                    labels.push(`W${getWeekNumber(current)}`);
                    current.setDate(current.getDate() + 7);
                } else {
                    labels.push(current.toLocaleDateString('id-ID', { month: 'short', year: '2-digit' }));
                    current.setMonth(current.getMonth() + 1);
                }
            }
            return { labels, dataPoints };
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }

        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
        function formatCurrency(amount) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount); }
        function formatDate(dateString) { return dateString ? new Date(dateString + 'T00:00:00').toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' }) : ''; }
        function formatDateTime(dateString) { return dateString ? new Date(dateString).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }) : ''; }
        function getTransactionIcon(category) { const icons = { food: 'fa-utensils', transport: 'fa-car', entertainment: 'fa-gamepad', shopping: 'fa-shopping-bag', bills: 'fa-file-invoice', salary: 'fa-money-bill-wave', business: 'fa-briefcase', investment: 'fa-chart-line', other: 'fa-question' }; return icons[category] || 'fa-question'; }
        function getCategoryName(category = null) { const names = { food: 'Makanan', transport: 'Transport', entertainment: 'Hiburan', shopping: 'Belanja', bills: 'Tagihan', salary: 'Gaji', business: 'Bisnis', investment: 'Investasi', other: 'Lainnya' }; return category ? names[category] : names; }
        
        function showModal(content) {
            const modal = document.getElementById('mainModal');
            modal.querySelector('.modal-content').innerHTML = content;
            modal.classList.add('show');
            modal.querySelectorAll('.closeModal').forEach(btn => btn.addEventListener('click', closeModal));
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => modal.classList.remove('show'));
        }

        function showConfirm(title, message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            modal.classList.add('show');
            const yesBtn = document.getElementById('confirmYes');
            const noBtn = document.getElementById('confirmNo');
            const yesHandler = () => { onConfirm(); closeModal(); cleanup(); };
            const noHandler = () => { closeModal(); cleanup(); };
            const cleanup = () => {
                yesBtn.removeEventListener('click', yesHandler);
                noBtn.removeEventListener('click', noHandler);
            };
            yesBtn.addEventListener('click', yesHandler);
            noBtn.addEventListener('click', noHandler);
        }

        function showMessage(message, type = 'info') {
            const isLight = document.body.classList.contains('light-mode');
            const colors = { info: '#60a5fa', success: '#4ade80', error: '#f472b6' };
            const msgDiv = document.createElement('div');
            Object.assign(msgDiv.style, {
                position: 'fixed', bottom: '20px', right: '20px', padding: '15px',
                backgroundColor: isLight ? '#ffffff' : 'rgba(15, 10, 32, 0.8)',
                backdropFilter: 'blur(10px)', color: colors[type], border: `1px solid ${colors[type]}`,
                borderRadius: '8px', boxShadow: `0 4px 15px rgba(0,0,0,0.1)`, zIndex: '9999',
                transition: 'opacity 0.5s'
            });
            msgDiv.textContent = message;
            document.body.appendChild(msgDiv);
            setTimeout(() => {
                msgDiv.style.opacity = '0';
                setTimeout(() => msgDiv.remove(), 500);
            }, 3000);
        }

        function showDateRangeModal() {
            document.getElementById('dateRangeModal').classList.add('show');
        }

        function applyDateRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            if (!startDate || !endDate) {
                showMessage('Harap pilih tanggal mulai dan selesai.', 'error');
                return;
            }
            if (new Date(startDate) > new Date(endDate)) {
                showMessage('Tanggal mulai tidak boleh setelah tanggal selesai.', 'error');
                return;
            }
            const rangeObject = { type: 'custom', start: startDate, end: endDate };
            masterDateRange = rangeObject;
            customDateRange = rangeObject;
            updateActiveButton('master-range-selector', 'custom');
            refreshDashboardData();
            document.getElementById('dateRangeModal').classList.remove('show');
        }

        function setupMasterRangeSelector() {
            document.querySelectorAll('#master-range-selector .range-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const range = e.currentTarget.dataset.range;
                    if (range === 'custom') {
                        showDateRangeModal();
                    } else {
                        updateActiveButton('master-range-selector', range);
                        masterDateRange = range;
                        customDateRange = {}; 
                        refreshDashboardData();
                    }
                });
            });
        }

        function updateActiveButton(selectorId, activeRange) {
            document.querySelectorAll(`#${selectorId} .range-btn`).forEach(b => b.classList.remove('active'));
            document.querySelector(`#${selectorId} .range-btn[data-range="${activeRange}"]`).classList.add('active');
        }

        function filterDataByRange(data, range, dateKey) {
            if (range === 'all') return data.filter(item => item[dateKey]);
            let startDate, endDate = new Date();
            if (typeof range === 'object' && range.type === 'custom') {
                startDate = new Date(range.start + 'T00:00:00Z');
                endDate = new Date(range.end + 'T23:59:59Z');
            } else {
                startDate = new Date();
                if (range === '7d') startDate.setDate(endDate.getDate() - 6);
                else if (range === '1m') startDate.setDate(endDate.getDate() - 29);
                else if (range === '3m') startDate.setMonth(endDate.getMonth() - 3);
                else if (range === '1y') startDate.setFullYear(endDate.getFullYear() - 1);
                startDate.setHours(0, 0, 0, 0);
            }
            return data.filter(item => {
                if (!item[dateKey]) return false;
                const itemDate = new Date(item[dateKey]);
                return itemDate >= startDate && itemDate <= endDate;
            });
        }
    </script>
</body>
</html>

