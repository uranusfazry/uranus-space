<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeHub v5 - Integrated Terminal</title>
    
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Memuat Font Awesome untuk ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Memuat Chart.js untuk grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Memuat jsPDF & AutoTable untuk ekspor PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Memuat html2canvas untuk konversi HTML ke gambar (diperlukan untuk PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Memuat PDF.js & JSZip untuk fitur ekspor gambar -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>

    <!-- PENTING: Memuat Google Identity Services (GSI) untuk otentikasi -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Gaya Kustom -->
    <style>
        /* [PERUBAHAN] Mengganti semua impor font dengan satu baris yang efisien untuk memuat semua font baru */
        @import url('https://fonts.googleapis.com/css2?family=Alfa+Slab+One&family=Anton&family=Bebas+Neue&family=Bitter&family=Caveat&family=Cormorant+Garamond&family=Dancing+Script&family=EB+Garamond&family=Fira+Code&family=Indie+Flower&family=Inconsolata&family=JetBrains+Mono&family=Lato&family=Lobster&family=Lora&family=Merriweather&family=Montserrat&family=Nunito+Sans&family=Open+Sans&family=Orbitron&family=Oswald&family=Pacifico&family=Playfair+Display&family=Poppins&family=Raleway&family=Roboto&family=Shadows+Into+Light+Two&family=Source+Code+Pro&family=Space+Mono&family=Ubuntu&display=swap');
        
        :root {
            /* [DEFAULT] Dark Purple Theme */
            --bg-gradient: linear-gradient(135deg, #0F0A20, #1A1033, #2E0B4D, #4A148C);
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --card-bg: rgba(15, 10, 32, 0.4);
            --card-border: rgba(255, 255, 255, 0.05);
            --sidebar-bg: rgba(26, 16, 51, 0.8);
            --sidebar-border: rgba(192, 132, 252, 0.1);
            --input-bg: rgba(15, 10, 32, 0.5);
            --input-border: rgba(192, 132, 252, 0.2);
            --input-focus-border: #c084fc;
            --active-nav-bg: rgba(192, 132, 252, 0.2);
            --active-nav-border: #c084fc;
            --hover-nav-bg: rgba(192, 132, 252, 0.1);
            --hover-nav-border: #a855f7;
            --primary-brand: #c084fc;
            --danger-brand: #f472b6;
        }

        body.light-mode {
            /* Light Theme */
            --bg-gradient: linear-gradient(135deg, #f3e8ff, #faf5ff, #f5f3ff);
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --card-bg: rgba(255, 255, 255, 0.8);
            --card-border: rgba(0, 0, 0, 0.1);
            --sidebar-bg: #ffffff;
            --sidebar-border: #e5e7eb;
            --input-bg: #f9fafb;
            --input-border: #d1d5db;
            --input-focus-border: #9333ea;
            --active-nav-bg: rgba(147, 51, 234, 0.1);
            --active-nav-border: #9333ea;
            --hover-nav-bg: rgba(147, 51, 234, 0.05);
            --hover-nav-border: #a855f7;
            --primary-brand: #9333ea;
            --danger-brand: #ec4899;
        }

        /* [PENAMBAHAN] Black Mode Theme */
        body.black-mode {
            --bg-gradient: linear-gradient(135deg, #111, #000);
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --card-bg: rgba(20, 20, 20, 0.6);
            --card-border: rgba(255, 255, 255, 0.1);
            --sidebar-bg: rgba(10, 10, 10, 0.85);
            --sidebar-border: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(25, 25, 25, 0.7);
            --input-border: rgba(255, 255, 255, 0.15);
            --input-focus-border: #00f0ff; /* Cyan glow */
            --active-nav-bg: rgba(0, 240, 255, 0.15);
            --active-nav-border: #00f0ff;
            --hover-nav-bg: rgba(0, 240, 255, 0.1);
            --hover-nav-border: #00f0ff;
            --primary-brand: #00f0ff; /* Cyan as primary brand */
            --danger-brand: #ff2a6d; /* Neon Pink for danger */
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-primary);
            transition: background 0.5s, color 0.5s;
            overflow-x: hidden;
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .gradient-bg {
            background-size: 400% 400%;
            animation: gradientFlow 15s ease infinite;
        }
        body.light-mode .gradient-bg,
        body.black-mode .gradient-bg {
            animation: none; /* Disable flow for static themes */
        }
        
        .glass-effect {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 12px;
            border: 1px solid var(--card-border);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        body.light-mode .glass-effect {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .glass-effect:hover {
            border-color: rgba(192, 132, 252, 0.2);
        }
        .black-mode .glass-effect:hover {
            border-color: var(--hover-nav-border);
        }

        .custom-input, .custom-select {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            width: 100%;
            transition: all 0.3s ease;
        }
        .custom-input:focus, .custom-select:focus {
            outline: none;
            border-color: var(--input-focus-border);
            box-shadow: 0 0 10px var(--input-focus-border, 0.3);
        }
        .custom-input::placeholder {
            color: var(--text-secondary);
        }

        .custom-button {
            background: linear-gradient(90deg, #9333ea, #7e22ce);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(147, 51, 234, 0.3);
            border: none;
            cursor: pointer;
        }
        .custom-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(147, 51, 234, 0.5);
        }
        .custom-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .custom-button-danger {
            background: linear-gradient(90deg, #ef4444, #dc2626);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        .custom-button-danger:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
        }

        /* [PENAMBAHAN] Style tombol untuk Black Mode */
        .black-mode .custom-button {
            background: linear-gradient(90deg, #00c3ff, #008cff);
            box-shadow: 0 4px 15px rgba(0, 200, 255, 0.3);
        }
        .black-mode .custom-button:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(0, 200, 255, 0.5);
        }
        .black-mode .custom-button-danger {
            background: linear-gradient(90deg, #ff4d4d, #ff0000);
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.3);
        }
        .black-mode .custom-button-danger:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.5);
        }

        .nav-item {
            transition: all 0.3s ease;  
            cursor: pointer;  
            padding: 0.75rem 1rem;
            margin: 0.25rem 0;  
            border-radius: 0.5rem;  
            border-left: 3px solid transparent;
        }
        .nav-item:hover {  
            background-color: var(--hover-nav-bg);  
            border-left-color: var(--hover-nav-border);  
        }
        .nav-item.active {  
            background-color: var(--active-nav-bg);  
            border-left-color: var(--active-nav-border);  
            color: var(--primary-brand);  
            font-weight: 500;
        }
        body.light-mode .nav-item.active {
            color: var(--primary-brand);
        }

        /* [PENAMBAHAN] Efek glow untuk teks di Black Mode */
        .black-mode h1,
        .black-mode h2,
        .black-mode h3,
        .black-mode .font-bold,
        .black-mode .nav-item.active {
            text-shadow: 0 0 8px rgba(0, 240, 255, 0.4);
        }
        .black-mode #logo-icon {
            background: linear-gradient(to br, #00f0ff, #00a2ff);
        }
        .black-mode #logo-icon i {
            color: #002d3c;
        }
        .black-mode h1.text-purple-300,
        .black-mode h2.text-purple-300,
        .black-mode h3.text-purple-300,
        .black-mode .text-purple-300,
        .black-mode .text-purple-400 {
            color: var(--primary-brand);
        }
        .black-mode .text-pink-400 {
            color: #ff80c0; /* A contrasting pink for black mode */
        }
        .black-mode .text-blue-400 {
            color: #80bfff; /* A contrasting blue for black mode */
        }


        .modal {  
            display: none;  
            position: fixed;  
            top: 0;  
            left: 0;  
            width: 100%;  
            height: 100%;  
            background-color: rgba(0, 0, 0, 0.7);  
            backdrop-filter: blur(5px);
            z-index: 1000;  
            animation: fadeIn 0.3s ease;  
        }
        .modal.show {  
            display: flex;  
            align-items: center;  
            justify-content: center;  
        }
        .modal-content {
            max-width: 90vw;  
            max-height: 90vh;  
            overflow-y: auto;  
            animation: modalAppear 0.5s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modalAppear { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        
        .income { border-left: 4px solid #4ade80; }
        .expense { border-left: 4px solid #f472b6; }
        
        .task-item.completed { opacity: 0.6; text-decoration: line-through; }

        .hidden { display: none !important; }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            height: 100vh;  
            overflow-y: auto;  
            position: fixed;  
            left: -250px;  
            top: 0;  
            width: 250px;
            background-color: var(--sidebar-bg);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--sidebar-border);  
            z-index: 100;  
            transition: left 0.3s ease, opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .sidebar.open { left: 0; }
        
        .overlay {  
            display: none;  
            position: fixed;  
            top: 0;  
            left: 0;  
            width: 100%;  
            height: 100%;  
            background-color: rgba(0, 0, 0, 0.5);  
            z-index: 99;  
        }
        .overlay.show { display: block; }
        
        .main-content {  
            flex-grow: 1;
            width: 100%;
            transition: margin-left 0.3s ease;  
        }
        
        .main-content > .p-6 {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        
        @media (min-width: 768px) {  
            .sidebar {  
                position: relative;
                left: 0;  
                flex-shrink: 0;
                height: auto; 
            }
            .main-content {
                width: calc(100% - 250px);
            }
            #mobileMenuBtn, .overlay, .main-header {
                display: none;
            }
        }
        
        @media (max-width: 767px) {
            .app-container {
                display: block;
            }
             .main-content {
                padding-top: 70px; /* Space for the new fixed header */
            }
        }

        #bg-video, #bg-image-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -2;
            display: none;
        }
        #bg-image-layer {
            background-size: cover;
            background-position: center;
        }

        #mobileMenuBtn {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }

        body.preview-mode .sidebar,
        body.preview-mode .main-content > .p-6,
        body.preview-mode #mobileMenuBtn,
        body.preview-mode .main-header { /* Hide header in preview */
            opacity: 0;
            transform: translateY(15px);
            pointer-events: none;
        }

        .range-btn {
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }
        .range-btn:hover {
            background-color: var(--hover-nav-bg);
            color: var(--text-primary);
        }
        .range-btn.active {
            background-color: var(--primary-brand);
            color: white;
            box-shadow: 0 2px 10px rgba(192, 132, 252, 0.4);
        }
        body.light-mode .range-btn.active,
        body.black-mode .range-btn.active {
            color: white;
        }
        body.black-mode .range-btn.active {
             box-shadow: 0 2px 10px rgba(0, 240, 255, 0.4);
        }


        .chart-container {
            height: 350px;
            position: relative;
        }

        #notes-section .notes-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .note-item {
            border: 1px solid var(--card-border);
            transition: background-color 0.3s ease;
        }
        .note-item:hover {
            background-color: var(--hover-nav-bg);
        }
        .tag {
            background-color: var(--primary-brand);
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
        }

        /* --- GAYA UNTUK FAKE HACK EFFECT --- */
        #hack-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 9999;
            display: none; /* Awalnya disembunyikan */
            color: #0f0;
            font-family: 'Fira Code', monospace;
            padding: 2rem;
            overflow: hidden;
        }
        .hack-text {
            white-space: pre-wrap;
            font-size: 1.1rem;
            line-height: 1.5;
            text-shadow: 0 0 5px #0f0;
        }
        .hack-text.glitch {
            animation: glitch 0.1s infinite;
        }
        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }
        .typewriter-cursor {
            display: inline-block;
            background-color: #0f0;
            width: 10px;
            height: 1.2em;
            animation: blink 1s step-end infinite;
            margin-left: 5px;
        }
        @keyframes blink {
            from, to { background-color: transparent; }
            50% { background-color: #0f0; }
        }

        /* === [BARU] GAYA UNTUK PORTAL DI SIDEBAR === */
        .sidebar-portal-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem; /* py-2 px-3 */
            border-radius: 0.5rem; /* rounded-lg */
            transition: all 0.2s ease-in-out;
            text-decoration: none;
            color: var(--text-secondary);
            background-color: transparent;
            border: 1px solid transparent;
        }

        .sidebar-portal-item:hover {
            background-color: var(--hover-nav-bg);
            color: var(--text-primary);
            border-color: var(--hover-nav-border);
        }

        .sidebar-portal-item .portal-icon {
            width: 1.5rem; /* w-6 */
            height: 1.5rem; /* h-6 */
            margin-right: 0.75rem; /* mr-3 */
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem; /* Menyesuaikan ukuran ikon FontAwesome */
        }

        .sidebar-portal-item .portal-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Mengubah ke cover agar gambar mengisi area */
            border-radius: 4px; /* Sedikit rounded corner untuk gambar */
        }

        .sidebar-portal-item .portal-name {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.875rem; /* text-sm */
        }

        .sidebar-portal-item .delete-portal-btn {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            margin-left: 0.5rem; /* ml-2 */
            color: var(--danger-brand);
        }

        .sidebar-portal-item:hover .delete-portal-btn {
            opacity: 1;
        }

        /* === [BARU] GAYA UNTUK MODAL PORTAL === */
        .portal-modal-label {
            color: var(--primary-brand);
            text-shadow: 0 0 5px var(--primary-brand);
        }
        .portal-color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-block;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border: 2px solid transparent;
        }
        .portal-color-option:hover {
            transform: scale(1.1);
        }
        .portal-color-option.selected {
            border-color: var(--primary-brand);
            transform: scale(1.1);
        }
        .portal-color-option.selected::after {
            content: "✓";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 0 0 2px white;
        }
        .portal-custom-color-input {
            width: 100%;
            height: 40px;
            border: none;
            background: transparent;
            cursor: pointer;
            padding: 0;
        }
        /* Menyembunyikan tampilan default color picker */
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 8px;
        }

        /* === [BARU] GAYA UNTUK AVATAR PENGGUNA === */
        #avatar-container {
            background-image: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=2071&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            position: relative;
            box-shadow: 0 0 15px rgba(192, 132, 252, 0.4);
        }
        #user-picture {
            object-fit: cover;
        }

        /* === [BARU] GAYA UNTUK FITUR PRIVASI EMAIL === */
        #user-email {
            transition: filter 0.3s ease-in-out;
        }
        .email-blur {
            filter: blur(5px);
            user-select: none;
        }

        /* === [BARU] GAYA UNTUK EDITOR TEKS PROFESIONAL === */
        .pro-editor-container {
            position: relative;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--input-border);
            border-radius: 0.5rem;
            background-color: var(--input-bg);
            transition: all 0.3s ease;
        }
        .pro-editor-container:focus-within {
            border-color: var(--input-focus-border);
            box-shadow: 0 0 10px var(--input-focus-border, 0.3);
        }

        #editor-master-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        #editor-master-btn:hover {
            color: var(--primary-brand);
            border-color: var(--primary-brand);
            transform: scale(1.1);
        }

        .pro-toolbar {
            display: none; /* Akan diubah menjadi 'flex' oleh JS */
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border-bottom: 1px solid var(--input-border);
            background-color: var(--sidebar-bg);
            border-radius: 0.5rem 0.5rem 0 0;
        }
        .pro-toolbar.visible {
            display: flex;
        }

        .pro-toolbar-group {
            display: flex;
            align-items: center;
            gap: 0.2rem;
            padding: 0 0.5rem;
            border-right: 1px solid var(--input-border);
        }
        .pro-toolbar-group:last-child {
            border-right: none;
        }
        @media (max-width: 768px) {
            .pro-toolbar-group {
                border-right: none;
                padding: 0.25rem;
                background: rgba(0,0,0,0.1);
                border-radius: 6px;
            }
        }


        .pro-toolbar-button, .pro-toolbar-select, .pro-toolbar-color-wrapper {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            min-width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0 0.5rem;
            font-size: 0.9rem;
        }
        .pro-toolbar-button:hover, .pro-toolbar-select:hover {
            background-color: var(--hover-nav-bg);
            color: var(--text-primary);
        }
        .pro-toolbar-button.active {
            background-color: var(--active-nav-bg);
            color: var(--primary-brand);
        }
        .pro-toolbar-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.25rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
            padding-right: 1.5rem;
        }
        .pro-toolbar-color-wrapper {
            position: relative;
            padding: 0;
        }
        .pro-toolbar-color-wrapper input[type="color"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        /* [BARU] GAYA UNTUK PASTE DROPDOWN */
        .paste-dropdown-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        .paste-dropdown-menu {
            display: none;
            position: absolute;
            top: 110%;
            left: 0;
            z-index: 20;
            background-color: var(--sidebar-bg);
            border: 1px solid var(--card-border);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            padding: 0.5rem;
            width: max-content;
        }
        .paste-dropdown-container:hover .paste-dropdown-menu {
            display: block;
        }
        .paste-dropdown-menu button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.5rem 0.75rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 0.8rem;
            border-radius: 4px;
            cursor: pointer;
        }
        .paste-dropdown-menu button:hover {
            background-color: var(--hover-nav-bg);
            color: var(--text-primary);
        }

        .pro-editor-content {
            min-height: 400px;
            max-height: 65vh;
            padding: 1.5rem;
            overflow-y: auto;
            outline: none;
            color: var(--text-primary);
            line-height: 1.7;
            caret-color: var(--primary-brand);
        }
        .pro-editor-content[contenteditable="true"]:empty:before {
            content: attr(placeholder);
            color: var(--text-secondary);
            pointer-events: none;
            display: block;
        }
        /* Styling konten di dalam editor */
        .pro-editor-content h1, .pro-editor-content h2, .pro-editor-content h3 { border-bottom: 1px solid var(--input-border); padding-bottom: 0.3em; margin-bottom: 0.5em; }
        .pro-editor-content blockquote { border-left: 3px solid var(--primary-brand); margin-left: 0; padding-left: 1rem; color: var(--text-secondary); font-style: italic; }
        .pro-editor-content code { background: var(--card-bg); padding: 0.2em 0.4em; border-radius: 4px; font-family: 'Fira Code', monospace; font-size: 0.9em; }
        .pro-editor-content pre { background: #000; color: #f8f8f2; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap; font-family: 'Fira Code', monospace; }
        .pro-editor-content table { width: 100%; border-collapse: collapse; }
        .pro-editor-content th, .pro-editor-content td { border: 1px solid var(--input-border); padding: 0.5rem; }
        .pro-editor-content th { background-color: var(--card-bg); }

        .pro-editor-statusbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            border-top: 1px solid var(--input-border);
            background-color: var(--sidebar-bg);
            border-radius: 0 0 0.5rem 0.5rem;
            flex-wrap: wrap;
        }
        .pro-statusbar-segment {
            cursor: default;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .pro-statusbar-segment:hover {
            background-color: var(--hover-nav-bg);
        }
        .pro-statusbar-segment i {
            margin-right: 0.5em;
        }

    </style>
</head>
<body class="gradient-bg">
    <!-- Elemen untuk background media -->
    <div id="bg-image-layer"></div>
    <video autoplay loop muted id="bg-video"></video>

    <!-- PENAMBAHAN: Overlay untuk Fake Hack Effect -->
    <div id="hack-overlay">
        <pre id="hack-text" class="hack-text"></pre>
    </div>

    <!-- Overlay for mobile -->
    <div id="overlay" class="overlay"></div>

    <div class="app-container">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar">
            <div class="p-6 h-full flex flex-col">
                <!-- Bagian Atas (Logo, Judul, Mode) -->
                <div>
                    <div class="flex items-center justify-between mb-8">
                        <div class="flex items-center space-x-3">
                            <div id="logo-container" class="w-14 h-14 rounded-full flex items-center justify-center cursor-pointer" title="Masuk Mode Pratinjau">
                                <img src="https://i.imghippo.com/files/YXY6439eaY.png" alt="Uranus Space Logo" class="w-full h-full object-cover rounded-full">
                            </div>
                            <h1 class="text-3xl font-bold text-purple-300">Uranus Space</h1>
                        </div>
                        <button id="themeToggle" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-purple-500/10 text-purple-300" title="Toggle Theme">
                            <i class="fas fa-sun"></i>
                        </button>
                    </div>
                    
                    <div class="mb-6">
                        <label for="modeSelect" class="block text-sm font-medium mb-2 text-purple-300">Mode Terminal</label>
                        <select id="modeSelect" class="custom-input">
                            <option value="personal">Pribadi</option>
                            <option value="business">Bisnis</option>
                        </select>
                    </div>
                    
                    <!-- Navigasi Utama -->
                    <nav>
                        <div class="nav-item active" data-section="dashboard"><i class="fas fa-tachometer-alt mr-3 w-5"></i>Dashboard</div>
                        <div class="nav-item" data-section="finance"><i class="fas fa-wallet mr-3 w-5"></i>Manajemen Keuangan</div>
                        <div class="nav-item" data-section="tasks"><i class="fas fa-tasks mr-3 w-5"></i>Manajemen Waktu</div>
                        <div class="nav-item" data-section="split"><i class="fas fa-receipt mr-3 w-5"></i>Split Bill</div>
                        <div class="nav-item" data-section="notes"><i class="fas fa-book mr-3 w-5"></i>Catatan</div>
                        <div class="nav-item" data-section="settings"><i class="fas fa-cog mr-3 w-5"></i>Pengaturan</div>
                    </nav>
                </div>

                <!-- Container untuk Portal di Sidebar -->
                <div class="mt-8 pt-6 border-t border-[var(--sidebar-border)] flex-grow flex flex-col min-h-0">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-purple-300">Portal Tautan</h3>
                        <button id="addNewPortalBtn" class="custom-button !p-2 !text-xs" title="Tambah Portal Baru">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <!-- Daftar Portal akan dirender di sini oleh JavaScript -->
                    <div id="sidebar-portals-container" class="flex-grow overflow-y-auto pr-2 space-y-2">
                        <!-- Konten portal akan diisi oleh JS -->
                    </div>
                </div>

            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
             <!-- Header baru ditambahkan untuk menampung tombol hamburger dan judul di mobile -->
            <header class="main-header p-4 glass-effect md:hidden fixed top-0 left-0 right-0 z-40">
                <div class="flex items-center justify-between">
                    <button id="mobileMenuBtn" class="custom-button !p-3">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="flex items-center space-x-2">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center">
                             <img src="https://i.imghippo.com/files/YXY6439eaY.png" alt="Uranus Space Logo" class="w-full h-full object-cover rounded-full">
                        </div>
                        <h1 class="text-2xl font-bold text-purple-300">Uranus Space</h1>
                    </div>
                    <!-- Placeholder to balance the flexbox -->
                    <div class="w-12"></div>
                </div>
            </header>

            <div class="p-6 relative z-10">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="section">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h2 class="text-3xl font-bold text-purple-300">Dashboard</h2>
                        <div id="master-range-selector" class="flex items-center gap-1 bg-purple-900/30 p-1 rounded-md glass-effect">
                            <button data-range="7d" class="range-btn active" title="7 Hari">7H</button>
                            <button data-range="1m" class="range-btn" title="1 Bulan">1B</button>
                            <button data-range="3m" class="range-btn" title="3 Bulan">3B</button>
                            <button data-range="1y" class="range-btn" title="1 Tahun">1T</button>
                            <button data-range="all" class="range-btn" title="Selamanya">∞</button>
                            <button data-range="custom" class="range-btn" title="Pilih Rentang"><i class="fas fa-calendar-alt"></i></button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold mb-2 text-pink-400">Saldo Total</h3><p class="text-2xl font-bold" id="totalBalance">Rp 0</p></div>
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold mb-2 text-pink-400">Tugas Hari Ini</h3><p class="text-2xl font-bold" id="todayTasksCount">0</p></div>
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold mb-2 text-pink-400">Tugas Tertunda</h3><p class="text-2xl font-bold" id="pendingTasks">0</p></div>
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold mb-2 text-pink-400">Mode Aktif</h3><p class="text-2xl font-bold" id="activeMode">Pribadi</p></div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold text-blue-400 mb-4">Arus Kas</h3>
                            <canvas id="cashFlowChart"></canvas>
                        </div>
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold text-pink-400 mb-4">Produktivitas</h3>
                            <canvas id="productivityChart"></canvas>
                        </div>
                    </div>

                    <div class="glass-effect p-6 mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-blue-400">Aktivitas Terkini</h3>
                        <div id="recentActivities" class="space-y-2"></div>
                    </div>

                    <h2 class="text-3xl font-bold mb-6 mt-10 text-purple-300">Analisis Mendalam</h2>
                    <div class="grid grid-cols-1 gap-6">
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold mb-4 text-purple-400">Analisis Gabungan Fitur</h3>
                            <div class="chart-container" style="height: 450px;">
                                <canvas id="combinedAnalysisChart"></canvas>
                            </div>
                        </div>

                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold mb-4 text-blue-400">Analisis Keuangan</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-2">
                                    <p class="text-md font-medium text-purple-300 mb-2">Pemasukan vs Pengeluaran</p>
                                    <div class="chart-container h-64">
                                        <canvas id="incomeVsExpenseChart"></canvas>
                                    </div>
                                </div>
                                <div>
                                     <p class="text-md font-medium text-purple-300 mb-2">Alokasi Pengeluaran</p>
                                    <div class="chart-container h-64">
                                        <canvas id="spendingByCategoryChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="glass-effect p-6">
                             <h3 class="text-xl font-semibold mb-4 text-pink-400">Analisis Produktivitas</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-2">
                                    <p class="text-md font-medium text-purple-300 mb-2">Tren Penyelesaian Tugas</p>
                                    <div class="chart-container h-64">
                                        <canvas id="taskCompletionTrendChart"></canvas>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-md font-medium text-purple-300 mb-2">Distribusi Prioritas Tugas</p>
                                    <div class="chart-container h-64">
                                        <canvas id="taskPriorityDistributionChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold mb-4 text-green-400">Analisis Split Bill</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <p class="text-md font-medium text-purple-300 mb-2">Total Pengeluaran per Orang</p>
                                    <div class="chart-container h-64">
                                        <canvas id="splitBillByUserChart"></canvas>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-md font-medium text-purple-300 mb-2">Frekuensi Split Bill</p>
                                    <div class="chart-container h-64">
                                        <canvas id="splitBillFrequencyChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- [PERUBAHAN] Bagian Analisis Catatan diubah menjadi grid 2 kolom -->
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold mb-4 text-blue-400">Analisis Catatan</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Grafik 1: Frekuensi Entri Catatan -->
                                <div>
                                    <p class="text-md font-medium text-purple-300 mb-2 text-center">Frekuensi Entri Catatan</p>
                                    <div class="chart-container h-64">
                                        <canvas id="diaryEntryFrequencyChart"></canvas>
                                    </div>
                                </div>
                                <!-- Grafik 2: Analisis Mood (Grafik Baru) -->
                                <div>
                                    <p class="text-md font-medium text-purple-300 mb-2 text-center">Analisis Mood</p>
                                    <div class="chart-container h-64">
                                        <canvas id="noteMoodAnalysisChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Finance Section -->
                <div id="finance-section" class="section hidden">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h2 class="text-3xl font-bold text-purple-300">Manajemen Keuangan</h2>
                        <div class="flex gap-2">
                            <button id="addTransactionBtn" class="custom-button"><i class="fas fa-plus mr-2"></i>Tambah</button>
                            <button id="exportFinanceBtn" class="custom-button" style="background: linear-gradient(90deg, #10b981, #059669);"><i class="fas fa-file-pdf mr-2"></i>Laporan</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold text-green-400 mb-2">Pemasukan</h3><p class="text-2xl font-bold" id="totalIncome">Rp 0</p></div>
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold text-pink-400 mb-2">Pengeluaran</h3><p class="text-2xl font-bold" id="totalExpense">Rp 0</p></div>
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold text-blue-400 mb-2">Saldo</h3><p class="text-2xl font-bold" id="balance">Rp 0</p></div>
                    </div>

                    <div class="glass-effect p-4 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-center">
                            <input type="text" id="searchTransaction" placeholder="Cari transaksi..." class="custom-input md:col-span-2">
                            <select id="categoryFilter" class="custom-input"></select>
                            <select id="typeFilter" class="custom-input"></select>
                            <button id="financeDateFilterBtn" class="custom-button"><i class="fas fa-calendar-alt mr-2"></i>Filter Tanggal</button>
                        </div>
                    </div>

                    <div class="glass-effect p-6">
                        <h3 class="text-xl font-semibold mb-4 text-pink-400">Daftar Transaksi</h3>
                        <div id="transactionsList" class="space-y-2"></div>
                    </div>
                </div>
                
                <!-- Tasks & Plans Section -->
                <div id="tasks-section" class="section hidden">
                    <h2 class="text-3xl font-bold mb-6 text-purple-300">Manajemen Waktu</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 space-y-6">
                            <div class="glass-effect p-6">
                                <h3 class="text-xl font-semibold mb-4 text-blue-400">Tambah Tugas</h3>
                                <form id="taskForm" class="space-y-4">
                                    <div><label class="block text-sm font-medium mb-1">Tugas</label><input type="text" id="taskTitle" class="custom-input" required></div>
                                    <div><label class="block text-sm font-medium mb-1">Tanggal & Waktu</label><input type="datetime-local" id="taskDateTime" class="custom-input" required></div>
                                    <div><label class="block text-sm font-medium mb-1">Prioritas</label><select id="taskPriority" class="custom-input"><option value="low">Rendah</option><option value="medium">Sedang</option><option value="high">Tinggi</option></select></div>
                                    <button type="submit" class="custom-button w-full">Tambah Tugas</button>
                                </form>
                            </div>
                            <div class="glass-effect p-6 text-center">
                                <h3 class="text-xl font-semibold mb-4 text-pink-400">Pomodoro Timer</h3>
                                <div id="timerDisplay" class="text-5xl font-mono my-4">25:00</div>
                                <div class="flex gap-2 justify-center">
                                    <button id="startTimerBtn" class="custom-button bg-green-600 hover:bg-green-500"><i class="fas fa-play"></i></button>
                                    <button id="pauseTimerBtn" class="custom-button bg-yellow-600 hover:bg-yellow-500"><i class="fas fa-pause"></i></button>
                                    <button id="resetTimerBtn" class="custom-button custom-button-danger"><i class="fas fa-sync"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="lg:col-span-2 space-y-6">
                            <div class="glass-effect p-6">
                                 <h3 class="text-xl font-semibold mb-4 text-blue-400">Daftar Tugas</h3>
                                 <div id="taskList" class="space-y-3 max-h-96 overflow-y-auto"></div>
                            </div>
                            <div class="glass-effect p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <button id="prevMonth" class="custom-button !p-3"><i class="fas fa-chevron-left"></i></button>
                                    <span id="currentMonth" class="text-xl font-semibold text-pink-400"></span>
                                    <button id="nextMonth" class="custom-button !p-3"><i class="fas fa-chevron-right"></i></button>
                                </div>
                                <div id="calendar" class="grid grid-cols-7 gap-1"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Split Bill Section -->
                <div id="split-section" class="section hidden">
                    <h2 class="text-3xl font-bold mb-6 text-purple-300">Split Bill</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <div class="glass-effect p-6 mb-6">
                                <h3 class="text-xl font-semibold mb-4 text-blue-400">Kalkulator Bill</h3>
                                <form id="splitBillForm" class="space-y-4">
                                    <div><label class="block text-sm font-medium mb-1">Total Tagihan</label><input type="number" id="totalBill" class="custom-input" required></div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Tanggal</label>
                                        <input type="date" id="splitBillDate" class="custom-input" required>
                                    </div>
                                    <div><label class="block text-sm font-medium mb-1">Nama (pisahkan koma)</label><input type="text" id="peopleNames" class="custom-input" placeholder="Zedd, Jett, Omen" required></div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Persentase (opsional, pisahkan koma)</label>
                                        <input type="text" id="splitPercentages" class="custom-input" placeholder="25, 75">
                                        <p class="text-xs text-gray-400 mt-1">Kosongkan untuk membagi rata.</p>
                                    </div>
                                    <button type="submit" class="custom-button w-full">Hitung</button>
                                </form>
                            </div>
                            <div id="splitResultCard" class="glass-effect p-6 hidden">
                                <h3 class="text-xl font-semibold mb-4 text-pink-400">Hasil Pembagian</h3>
                                <div id="splitResult"></div>
                                <button id="exportSplitBtn" class="custom-button custom-button-danger w-full mt-4">Export PDF</button>
                            </div>
                        </div>
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold mb-4 text-blue-400">Riwayat Split Bill</h3>
                            <div id="splitHistory" class="space-y-3 max-h-[600px] overflow-y-auto"></div>
                        </div>
                    </div>
                </div>

                <!-- Notes Section -->
                <div id="notes-section" class="section hidden">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                         <h2 class="text-3xl font-bold text-purple-300">Catatan Profesional</h2>
                         <div class="flex gap-2">
                                <button id="notesAddNewBtn" class="custom-button"><i class="fas fa-plus mr-2"></i>Catatan Baru</button>
                         </div>
                    </div>
                    <div class="notes-container">
                        <!-- [BARU] Kontrol untuk Manajemen Font Kustom -->
                        <div class="glass-effect p-4 mb-6">
                            <h3 class="font-semibold text-lg text-pink-400 mb-2">Manajemen Font Kustom</h3>
                            <div class="flex items-center gap-4">
                                <div class="flex-grow">
                                    <label for="customFontUploader" class="block text-sm font-medium mb-1">Unggah Font Baru (.ttf, .otf, .woff)</label>
                                    <input type="file" id="customFontUploader" class="custom-input !p-2" accept=".otf,.ttf,.woff,.woff2">
                                </div>
                                <button id="clearCustomFontsBtn" class="custom-button custom-button-danger" title="Hapus Semua Font Kustom">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Font yang diunggah akan tersimpan di browser Anda dan muncul di pilihan editor.</p>
                        </div>

                        <!-- ===== [START] EDITOR PROFESIONAL BARU ===== -->
                        <div id="notesEditorSection" class="glass-effect p-4">
                            <input type="text" id="notesTitleInput" class="custom-input mb-4 text-xl" placeholder="Judul Catatan...">
                            
                            <div class="pro-editor-container">
                                <!-- Tombol Induk untuk Menampilkan Toolbar -->
                                <button id="editor-master-btn" title="Tampilkan Opsi Pemformatan">
                                    <span class="font-bold">A</span><i class="fas fa-ellipsis-v ml-1"></i>
                                </button>
                
                                <!-- Toolbar Pemformatan Lengkap (Awalnya tersembunyi) -->
                                <div id="pro-toolbar" class="pro-toolbar">
                                    <!-- Grup Undo/Redo & Clear -->
                                    <div class="pro-toolbar-group">
                                        <button class="pro-toolbar-button" data-command="undo" title="Undo (Ctrl+Z)"><i class="fas fa-undo"></i></button>
                                        <button class="pro-toolbar-button" data-command="redo" title="Redo (Ctrl+Y)"><i class="fas fa-redo"></i></button>
                                        <button class="pro-toolbar-button" data-command="cut" title="Gunting (Ctrl+X)"><i class="fas fa-cut"></i></button>
                                        <button class="pro-toolbar-button" data-command="copy" title="Salin (Ctrl+C)"><i class="fas fa-copy"></i></button>
                                        <!-- Smart Paste Dropdown -->
                                        <div class="paste-dropdown-container">
                                            <button class="pro-toolbar-button" data-command="paste" title="Tempel (Ctrl+V)"><i class="fas fa-paste"></i></button>
                                            <div class="paste-dropdown-menu">
                                                <button data-command="pasteKeepFormatting">Tempel dengan Format</button>
                                                <button data-command="pasteAsPlainText">Tempel Teks Biasa</button>
                                            </div>
                                        </div>
                                    </div>
                
                                    <!-- [PERUBAHAN] Grup Font & Ukuran dengan daftar KOSONG -->
                                    <div class="pro-toolbar-group">
                                        <select class="pro-toolbar-select" data-command="fontName" title="Jenis Font">
                                            <!-- Opsi font kustom akan ditambahkan oleh JavaScript -->
                                        </select>
                                    </div>
                
                                    <!-- Grup Gaya Teks -->
                                    <div class="pro-toolbar-group">
                                        <button class="pro-toolbar-button" data-command="bold" title="Bold (Ctrl+B)"><i class="fas fa-bold"></i></button>
                                        <button class="pro-toolbar-button" data-command="italic" title="Italic (Ctrl+I)"><i class="fas fa-italic"></i></button>
                                        <button class="pro-toolbar-button" data-command="underline" title="Underline (Ctrl+U)"><i class="fas fa-underline"></i></button>
                                        <button class="pro-toolbar-button" data-command="strikeThrough" title="Strikethrough"><i class="fas fa-strikethrough"></i></button>
                                        <button class="pro-toolbar-button" data-command="subscript" title="Subskrip"><i class="fas fa-subscript"></i></button>
                                        <button class="pro-toolbar-button" data-command="superscript" title="Superskrip"><i class="fas fa-superscript"></i></button>
                                    </div>
                                    
                                    <!-- Grup Warna -->
                                    <div class="pro-toolbar-group">
                                        <div class="pro-toolbar-color-wrapper" title="Warna Teks">
                                            <i class="fas fa-font"></i>
                                            <input type="color" data-command="foreColor">
                                        </div>
                                        <div class="pro-toolbar-color-wrapper" title="Warna Sorot (Highlight)">
                                            <i class="fas fa-highlighter"></i>
                                            <input type="color" data-command="backColor">
                                        </div>
                                    </div>
                                    
                                    <!-- Grup Heading & Block -->
                                    <div class="pro-toolbar-group">
                                        <select class="pro-toolbar-select" data-command="formatBlock" title="Gaya Paragraf">
                                            <option value="p">Paragraf</option>
                                            <option value="h1">Heading 1</option>
                                            <option value="h2">Heading 2</option>
                                            <option value="h3">Heading 3</option>
                                            <option value="blockquote">Kutipan</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Grup Perataan -->
                                    <div class="pro-toolbar-group">
                                        <button class="pro-toolbar-button" data-command="justifyLeft" title="Rata Kiri"><i class="fas fa-align-left"></i></button>
                                        <button class="pro-toolbar-button" data-command="justifyCenter" title="Rata Tengah"><i class="fas fa-align-center"></i></button>
                                        <button class="pro-toolbar-button" data-command="justifyRight" title="Rata Kanan"><i class="fas fa-align-right"></i></button>
                                        <button class="pro-toolbar-button" data-command="justifyFull" title="Rata Kanan Kiri"><i class="fas fa-align-justify"></i></button>
                                    </div>
                
                                    <!-- Grup Daftar -->
                                    <div class="pro-toolbar-group">
                                        <button class="pro-toolbar-button" data-command="insertUnorderedList" title="Bullet List"><i class="fas fa-list-ul"></i></button>
                                        <button class="pro-toolbar-button" data-command="insertOrderedList" title="Numbered List"><i class="fas fa-list-ol"></i></button>
                                        <button class="pro-toolbar-button" data-command="outdent" title="Kurangi Indentasi"><i class="fas fa-outdent"></i></button>
                                        <button class="pro-toolbar-button" data-command="indent" title="Tambah Indentasi"><i class="fas fa-indent"></i></button>
                                    </div>
                
                                    <!-- Grup Sisipkan -->
                                    <div class="pro-toolbar-group">
                                        <button class="pro-toolbar-button" data-command="createLink" title="Sisipkan Tautan"><i class="fas fa-link"></i></button>
                                        <button class="pro-toolbar-button" data-command="insertImage" title="Sisipkan Gambar"><i class="fas fa-image"></i></button>
                                        <button class="pro-toolbar-button" data-command="embedYouTube" title="Sematkan Video YouTube"><i class="fab fa-youtube"></i></button>
                                        <button class="pro-toolbar-button" data-command="embedTikTok" title="Sematkan Video TikTok"><i class="fab fa-tiktok"></i></button>
                                        <button class="pro-toolbar-button" data-command="uploadFile" title="Unggah File"><i class="fas fa-upload"></i></button>
                                        <button class="pro-toolbar-button" data-command="insertHorizontalRule" title="Garis Horizontal"><i class="fas fa-minus"></i></button>
                                    </div>
                
                                    <!-- Grup Lainnya -->
                                    <div class="pro-toolbar-group">
                                         <button class="pro-toolbar-button" data-command="clearFormatting" title="Hapus Format"><i class="fas fa-eraser"></i></button>
                                         <button class="pro-toolbar-button" data-command="findAndReplace" title="Cari & Ganti"><i class="fas fa-search"></i></button>
                                    </div>
                                </div>
                
                                <!-- Area Konten Editor -->
                                <div id="pro-editor-content" class="pro-editor-content" contenteditable="true" placeholder="Mulai menulis atau jatuhkan file di sini...">
                                    <!-- Konten akan diisi oleh pengguna -->
                                </div>
                
                                <!-- Status Bar Profesional -->
                                <div class="pro-editor-statusbar">
                                    <div class="flex items-center gap-4">
                                        <span id="word-count" class="pro-statusbar-segment" title="Jumlah Kata"><i class="fas fa-file-word"></i>0 Kata</span>
                                        <span id="char-count" class="pro-statusbar-segment" title="Jumlah Karakter"><i class="fas fa-keyboard"></i>0 Karakter</span>
                                        <span id="reading-time" class="pro-statusbar-segment" title="Waktu Baca"><i class="fas fa-clock"></i>0 mnt</span>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <span id="save-status" class="pro-statusbar-segment" title="Status Penyimpanan"><i class="fas fa-cloud"></i>Tersimpan</span>
                                        <span id="sync-status" class="pro-statusbar-segment" title="Status Sinkronisasi"><i class="fas fa-sync"></i>Tersinkronisasi</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Input Tambahan untuk Catatan (Tanggal, Tags, Mood) -->
                            <div class="flex flex-wrap gap-4 mt-4">
                                <input type="date" id="notesDateFilter" class="custom-input flex-1">
                                <select id="notesMoodSelector" class="custom-input flex-1">
                                    <option value="neutral">Netral</option>
                                    <option value="happy">Senang</option>
                                    <option value="sad">Sedih</option>
                                    <option value="excited">Bersemangat</option>
                                    <option value="angry">Marah</option>
                                </select>
                                <input type="text" id="notesTagsInput" class="custom-input flex-1" placeholder="Tags, pisahkan koma">
                            </div>

                            <!-- Tombol Aksi Utama untuk Catatan -->
                            <div class="flex flex-wrap gap-2 mt-4">
                                <button id="notesSaveBtn" class="custom-button flex-grow"><i class="fas fa-save mr-2"></i>Simpan</button>
                                <button id="notesSetPasswordBtn" class="custom-button flex-grow" style="background: linear-gradient(90deg, #f59e0b, #d97706);"><i class="fas fa-lock mr-2"></i>Kunci</button>
                                <button id="notesClearEditorBtn" class="custom-button custom-button-danger"><i class="fas fa-eraser mr-2"></i>Bersihkan</button>
                            </div>
                        </div>
                        <!-- ===== [END] EDITOR PROFESIONAL BARU ===== -->
                        
                        <div class="glass-effect p-4 space-y-4 mt-6">
                            <h3 class="font-semibold text-lg text-pink-400">Kontrol & Filter Catatan</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="search" id="notesSearchInput" class="custom-input" placeholder="Cari berdasarkan judul, isi, atau tag...">
                                <select id="notesMoodFilter" class="custom-input">
                                    <option value="">Semua Mood</option>
                                    <option value="happy">Senang</option>
                                    <option value="sad">Sedih</option>
                                    <option value="neutral">Netral</option>
                                    <option value="excited">Bersemangat</option>
                                    <option value="angry">Marah</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="glass-effect p-4 mt-6">
                            <h3 class="font-semibold text-lg text-pink-400 mb-2">Daftar Catatan</h3>
                            <div id="notesList" class="space-y-2 max-h-96 overflow-y-auto"></div>
                        </div>
                
                    </div>
                </div>
                
                <div id="settings-section" class="section hidden">
                    <h2 class="text-3xl font-bold mb-6 text-purple-300">Pengaturan</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold mb-4 text-blue-400">Data & Laporan</h3>
                            <div class="space-y-4">
                                
                                <div class="p-4 rounded-lg border border-purple-500/20 space-y-3">
                                    <label for="pdf-time-range" class="block text-sm font-medium text-purple-300">Download Laporan Lengkap</label>
                                    <select id="pdf-time-range" class="custom-select">
                                        <option value="all">Selamanya</option>
                                        <option value="last7days">7 Hari Terakhir</option>
                                        <option value="last1month">1 Bulan Terakhir</option>
                                        <option value="last3months">3 Bulan Terakhir</option>
                                        <option value="last1year">1 Tahun Terakhir</option>
                                        <option value="custom">Rentang Kustom...</option>
                                    </select>
                                    <div id="pdf-custom-range-inputs" class="hidden grid grid-cols-2 gap-2">
                                        <input type="date" id="pdf-start-date" class="custom-input" title="Tanggal Mulai">
                                        <input type="date" id="pdf-end-date" class="custom-input" title="Tanggal Selesai">
                                    </div>
                                    <button id="export-pdf-btn" class="custom-button w-full" style="background: linear-gradient(90deg, #10b981, #059669);">
                                        <i class="fas fa-file-pdf mr-2"></i>Ekspor ke PDF
                                    </button>
                                    <!-- [BARU] Tombol untuk ekspor gambar -->
                                    <button id="export-images-btn" class="custom-button w-full" style="background: linear-gradient(90deg, #3b82f6, #2563eb);">
                                        <i class="fas fa-file-archive mr-2"></i>Ekspor Gambar (ZIP)
                                    </button>
                                </div>

                                <hr class="border-purple-500/20">
                                <button id="backupData" class="custom-button w-full"><i class="fas fa-download mr-2"></i>Backup Data Lokal (.txt)</button>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Restore Data (.txt)</label>
                                    <input type="file" id="restoreFile" accept=".txt" class="custom-input">
                                    <button id="restoreData" class="custom-button custom-button-danger w-full mt-2"><i class="fas fa-upload mr-2"></i>Restore dari Lokal</button>
                                </div>
                                <hr class="border-purple-500/20">
                                
                                <h4 class="text-lg font-semibold text-purple-300 pt-2">Profil & Sinkronisasi Google Drive</h4>
                                
                                <div id="user-profile" class="hidden mb-6 text-center border-b border-purple-500/20 pb-6">
                                    <div id="avatar-container" class="w-24 h-24 rounded-full p-1 border-2 border-purple-400 mx-auto mb-3">
                                        <img id="user-picture" class="w-full h-full object-cover" alt="Avatar Pengguna" src="https://placehold.co/96x96/0F0A20/c084fc?text=?">
                                    </div>
                                    <p class="text-lg font-semibold text-purple-200" id="user-name"></p>
                                    <!-- [PERUBAHAN] Struktur HTML untuk Privasi Email -->
                                    <div class="flex items-center justify-center gap-2 mt-1">
                                        <p class="text-sm text-gray-400" id="user-email"></p>
                                        <i id="toggle-email-visibility" class="fas fa-eye cursor-pointer text-purple-300 hover:text-white transition-colors" title="Tampilkan/Sembunyikan Email"></i>
                                    </div>
                                </div>

                                <div id="google-drive-ui" class="space-y-3">
                                    <button id="auth-button" class="custom-button w-full" style="background: linear-gradient(90deg, #3b82f6, #2563eb);"><i class="fab fa-google mr-2"></i><span>Hubungkan ke Google</span></button>
                                    <button id="backup-button" class="custom-button w-full" disabled><i class="fab fa-google-drive mr-2"></i>Backup Data ke Drive</button>
                                    <button id="restore-button" class="custom-button w-full bg-green-600 hover:bg-green-500" disabled><i class="fas fa-cloud-download-alt mr-2"></i>Restore Data dari Drive</button>
                                    <div id="auth-status" class="text-center text-sm text-gray-400">Belum terhubung.</div>
                                    <div id="file-list" class="text-xs text-gray-500 bg-black/20 p-2 rounded-md max-h-40 overflow-y-auto"></div>
                                </div>
                                
                                <hr class="border-purple-500/20">
                                <button id="clearAllData" class="custom-button custom-button-danger w-full mt-4"><i class="fas fa-trash mr-2"></i>Hapus Semua Data</button>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <div class="glass-effect p-6">
                                <h3 class="text-xl font-semibold mb-4 text-pink-400">Ubah Latar Belakang</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label for="bg-upload-media" class="block text-sm font-medium mb-2">Pilih File (Gambar/Video)</label>
                                        <input type="file" id="bg-upload-media" class="custom-input" accept="image/*,video/*">
                                    </div>
                                    <button id="applyBgMediaBtn" class="custom-button w-full">Terapkan Latar Belakang</button>
                                    <button id="resetBgMediaBtn" class="custom-button custom-button-danger w-full">Reset Latar Belakang</button>
                                    <button id="toggleVideoSoundBtn" class="custom-button w-full" style="background: linear-gradient(90deg, #3b82f6, #2563eb);">
                                        <i class="fas fa-volume-mute mr-2"></i> <span>Aktifkan Suara Video</span>
                                    </button>
                                </div>
                            </div>
                            <div class="glass-effect p-6">
                                <h3 class="text-xl font-semibold mb-4 text-pink-400">Kontak & Sosial Media</h3>
                                <div class="space-y-3">
                                    <a href="https://youtube.com/@uranusfazry?si=44IbU_u8hYA0cSBO" target="_blank" class="flex items-center p-2 rounded-lg hover:bg-purple-500/10 transition-colors">
                                        <i class="fab fa-youtube w-6 text-center text-red-500 mr-3"></i>
                                        <span class="text-sm">YouTube</span>
                                    </a>
                                    <a href="https://www.tiktok.com/@uranusfazry?_t=ZS-8z7TBMBtmqu&_r=1" target="_blank" class="flex items-center p-2 rounded-lg hover:bg-purple-500/10 transition-colors">
                                        <i class="fab fa-tiktok w-6 text-center mr-3"></i>
                                        <span class="text-sm">TikTok</span>
                                    </a>
                                    <a href="mailto:irawanfazry697@gmail.com" target="_blank" class="flex items-center p-2 rounded-lg hover:bg-purple-500/10 transition-colors">
                                        <i class="fas fa-envelope w-6 text-center text-gray-400 mr-3"></i>
                                        <span class="text-sm">Email</span>
                                    </a>
                                    <a href="https://wa.me/6287872521809?text=Halo%2C%20saya%20membutuhkan%20bantuan%20terkait%20website%20dan%20aplikasi%20uranusfazry%20(Uranuspace)" target="_blank" class="flex items-center p-2 rounded-lg hover:bg-purple-500/10 transition-colors">
                                        <i class="fab fa-whatsapp w-6 text-center text-green-500 mr-3"></i>
                                        <span class="text-sm">WhatsApp</span>
                                    </a>
                                </div>
                            </div>
                            <div class="glass-effect p-6">
                                <h3 class="text-xl font-semibold mb-4 text-pink-400">Informasi Aplikasi</h3>
                                <div class="space-y-2 text-sm">
                                    <p><strong>Nama:</strong> LifeHub v5 (Uranus Space)</p>
                                    <p><strong>Versi:</strong> 5.5.1-FeatureUpdate</p>
                                    <p><strong>Fitur:</strong> Editor Teks Modern, Google Drive Backup & Restore, Analisis Data, Keuangan, Tugas, Pomodoro, Split Bill, Portal Tautan, Custom BG (Persisten), Preview Mode, Kunci Catatan, Keamanan Lanjutan, Laporan PDF Komprehensif dengan Tema Custom, Unggah Font Kustom.</p>
                                    <p><strong>Storage:</strong> LocalStorage, IndexedDB & Google Drive (Data terenkripsi di terminal Anda)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <footer class="text-center mt-10 py-4">
                    <p class="text-xs text-gray-500">© 2025 Uranus Space All rights reserved</p>
                </footer>

            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="mainModal" class="modal"><div class="modal-content glass-effect p-8 w-full max-w-2xl"></div></div>
    <div id="confirmModal" class="modal">
        <div class="modal-content glass-effect p-8 w-full max-w-sm text-center">
            <h3 id="confirmTitle" class="text-xl font-semibold mb-4 text-pink-400">Konfirmasi</h3>
            <p id="confirmMessage" class="mb-6">Apakah Anda yakin?</p>
            <div class="flex gap-4">
                <button id="confirmYes" class="custom-button flex-1">Ya</button>
                <button id="confirmNo" class="custom-button custom-button-danger flex-1">Tidak</button>
            </div>
        </div>
    </div>
    <div id="dateRangeModal" class="modal">
        <div class="modal-content glass-effect p-8 w-full max-w-md">
            <h3 class="text-xl font-semibold mb-6 text-purple-400">Pilih Rentang Tanggal</h3>
            <div class="space-y-4">
                <div>
                    <label for="startDate" class="block text-sm font-medium mb-1">Tanggal Mulai</label>
                    <input type="date" id="startDate" class="custom-input">
                </div>
                <div>
                    <label for="endDate" class="block text-sm font-medium mb-1">Tanggal Selesai</label>
                    <input type="date" id="endDate" class="custom-input">
                </div>
            </div>
            <div class="flex gap-4 mt-8">
                <button id="applyDateRange" class="custom-button flex-1">Terapkan</button>
                <button id="cancelDateRange" class="custom-button custom-button-danger flex-1">Batal</button>
            </div>
        </div>
    </div>
    
    <!-- NotesApp Modals -->
    <div id="notesPasswordModal" class="modal">
        <div class="modal-content glass-effect p-8 w-full max-w-sm text-center">
            <h3 class="text-xl font-semibold mb-4 text-pink-400">Catatan Terkunci</h3>
            <p id="password-prompt-message" class="mb-4">Masukkan kata sandi untuk membuka.</p>
            <input type="password" id="notesPasswordInput" class="custom-input mb-4">
            <div class="flex gap-2">
                <button id="notesCheckPasswordBtn" class="custom-button flex-1">Buka</button>
                <button id="notesCancelPasswordBtn" class="custom-button custom-button-danger">Batal</button>
            </div>
        </div>
    </div>
    <div id="notesPreviewModal" class="modal">
        <div class="modal-content glass-effect p-8 w-full max-w-3xl">
            <div id="notesPreviewContent" class="prose max-w-none"></div>
            <button id="notesClosePreviewBtn" class="custom-button mt-6">Tutup</button>
        </div>
    </div>

    <!-- [BARU] Modal Kustom untuk Input Password -->
    <div id="customPromptModal" class="modal">
        <div class="modal-content glass-effect p-8 w-full max-w-sm">
            <h3 id="customPromptTitle" class="text-xl font-semibold mb-4 text-pink-400">Atur Kata Sandi</h3>
            <p id="customPromptMessage" class="mb-6 text-gray-300">Masukkan kata sandi baru (kosongkan untuk membuka kunci):</p>
            
            <div class="relative">
                <input type="password" id="customPromptInput" class="custom-input pr-10" placeholder="Ketik kata sandi...">
                <i id="customPromptToggle" class="fas fa-eye absolute top-1/2 right-3 -translate-y-1/2 cursor-pointer text-gray-400 hover:text-white"></i>
            </div>

            <div class="flex gap-4 mt-6">
                <button id="customPromptCancel" class="custom-button custom-button-danger flex-1">Batal</button>
                <button id="customPromptOK" class="custom-button flex-1">Oke</button>
            </div>
        </div>
    </div>

    <!-- [PERBAIKAN] Menambahkan elemen audio untuk suara kunci -->
    <audio id="lockSound" src="https://c.top4top.io/m_35235kd2e1.m4a" preload="auto"></audio>

<script>
// ===================================================================================
// ======================= [BARU] FUNGSI HELPER UNTUK INDEXEDDB ======================
// ===================================================================================
/**
 * Membuka koneksi ke database IndexedDB.
 * @returns {Promise<IDBDatabase>} Promise yang resolve dengan objek database.
 */
function openDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('UranusSpaceDB', 2); // Versi dinaikkan untuk upgrade
        request.onupgradeneeded = event => {
            const db = event.target.result;
            // Store untuk media (backgrounds, media catatan)
            if (!db.objectStoreNames.contains('mediaFiles')) {
                db.createObjectStore('mediaFiles', { keyPath: 'id' });
            }
        };
        request.onsuccess = event => resolve(event.target.result);
        request.onerror = event => reject(event.target.error);
    });
}

/**
 * Menyimpan file (Blob) ke IndexedDB.
 * @param {string} id - Kunci unik untuk file (misalnya, nama file).
 * @param {Blob} blob - Data file sebagai Blob.
 * @returns {Promise<void>}
 */
async function saveFileToDB(id, blob) {
    try {
        const db = await openDB();
        const tx = db.transaction('mediaFiles', 'readwrite');
        const store = tx.objectStore('mediaFiles');
        store.put({ id: id, file: blob });
        return tx.complete;
    } catch (error) {
        console.error("Gagal menyimpan file ke DB:", error);
        showMessage("Gagal menyimpan file media. Mungkin storage penuh.", "error");
    }
}

/**
 * Mengambil file (Blob) dari IndexedDB.
 * @param {string} id - Kunci unik file.
 * @returns {Promise<Blob|null>}
 */
async function getFileFromDB(id) {
    try {
        const db = await openDB();
        const tx = db.transaction('mediaFiles', 'readonly');
        const store = tx.objectStore('mediaFiles');
        const request = store.get(id);
        return new Promise((resolve, reject) => {
            request.onsuccess = () => resolve(request.result ? request.result.file : null);
            request.onerror = () => reject(request.error);
        });
    } catch (error) {
        console.error("Gagal mengambil file dari DB:", error);
        return null;
    }
}

/**
 * Menghapus file dari IndexedDB.
 * @param {string} id - Kunci unik file.
 * @returns {Promise<void>}
 */
async function deleteFileFromDB(id) {
    try {
        const db = await openDB();
        const tx = db.transaction('mediaFiles', 'readwrite');
        const store = tx.objectStore('mediaFiles');
        store.delete(id);
        return tx.complete;
    } catch (error) {
        console.error("Gagal menghapus file dari DB:", error);
    }
}

/**
 * Mengambil semua kunci file dari object store.
 * @returns {Promise<string[]>}
 */
async function getAllFileKeysFromDB() {
    try {
        const db = await openDB();
        const tx = db.transaction('mediaFiles', 'readonly');
        const store = tx.objectStore('mediaFiles');
        const request = store.getAllKeys();
        return new Promise((resolve, reject) => {
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    } catch (error) {
        console.error("Gagal mengambil semua kunci file dari DB:", error);
        return [];
    }
}


// ===================================================================================
// ======================= [BARU] FUNGSI HELPER UNTUK MODAL KUSTOM ===================
// ===================================================================================
/**
 * Menampilkan modal kustom sebagai pengganti window.prompt().
 * @param {string} title - Judul modal.
 * @param {string} message - Pesan instruksi untuk pengguna.
 * @param {string} placeholder - Placeholder untuk input field.
 * @returns {Promise<string|null>} Promise yang resolve dengan nilai input atau null jika dibatalkan.
 */
function showCustomPrompt(title, message, placeholder) {
    return new Promise((resolve) => {
        const modal = document.getElementById('customPromptModal');
        const titleEl = document.getElementById('customPromptTitle');
        const messageEl = document.getElementById('customPromptMessage');
        const inputEl = document.getElementById('customPromptInput');
        const okBtn = document.getElementById('customPromptOK');
        const cancelBtn = document.getElementById('customPromptCancel');
        const toggleBtn = document.getElementById('customPromptToggle');

        // Reset state
        titleEl.textContent = title;
        messageEl.textContent = message;
        inputEl.placeholder = placeholder;
        inputEl.value = '';
        inputEl.type = 'password';
        toggleBtn.classList.remove('fa-eye-slash');
        toggleBtn.classList.add('fa-eye');

        modal.classList.add('show');
        inputEl.focus();

        const handleOK = () => {
            cleanup();
            resolve(inputEl.value);
        };

        const handleCancel = () => {
            cleanup();
            resolve(null);
        };

        const handleToggle = () => {
            if (inputEl.type === 'password') {
                inputEl.type = 'text';
                toggleBtn.classList.remove('fa-eye');
                toggleBtn.classList.add('fa-eye-slash');
            } else {
                inputEl.type = 'password';
                toggleBtn.classList.remove('fa-eye-slash');
                toggleBtn.classList.add('fa-eye');
            }
        };

        const handleKeyup = (e) => {
            if (e.key === 'Enter') handleOK();
            if (e.key === 'Escape') handleCancel();
        };

        // Tambahkan event listeners
        okBtn.addEventListener('click', handleOK);
        cancelBtn.addEventListener('click', handleCancel);
        toggleBtn.addEventListener('click', handleToggle);
        modal.addEventListener('keyup', handleKeyup);

        // Fungsi cleanup untuk menghapus listener setelah modal ditutup
        function cleanup() {
            modal.classList.remove('show');
            okBtn.removeEventListener('click', handleOK);
            cancelBtn.removeEventListener('click', handleCancel);
            toggleBtn.removeEventListener('click', handleToggle);
            modal.removeEventListener('keyup', handleKeyup);
        }
    });
}


/**
 * NotesApp Class
 * Logika untuk aplikasi catatan dengan editor profesional dan keamanan lanjutan.
 */
class NotesApp {
    constructor() {
        this.notes = [];
        this.currentNoteId = null;
        this.lastSelection = null; // Menyimpan selection range terakhir
        this.customFonts = []; // [BARU] Untuk menyimpan font kustom
    }

    init() {
        this.cacheDOMElements();
        this.bindEvents();
        this.loadNotes();
        this.loadSavedFonts(); // [BARU] Memuat font saat inisialisasi
        setInterval(() => this.autoSave(), 30000); // Autosave setiap 30 detik
    }

    cacheDOMElements() {
        this.dom = {
            // [PERBAIKAN] Menambahkan elemen audio ke cache
            lockSound: document.getElementById('lockSound'),

            // Elemen Umum & Keamanan
            passwordModal: document.getElementById('notesPasswordModal'),
            passwordInput: document.getElementById('notesPasswordInput'),
            checkPasswordBtn: document.getElementById('notesCheckPasswordBtn'),
            cancelPasswordBtn: document.getElementById('notesCancelPasswordBtn'),
            passwordPromptMessage: document.getElementById('password-prompt-message'),
            hackOverlay: document.getElementById('hack-overlay'),
            hackText: document.getElementById('hack-text'),
            
            // Kontrol Utama
            addNewNoteBtn: document.getElementById('notesAddNewBtn'),
            searchInput: document.getElementById('notesSearchInput'),
            moodFilter: document.getElementById('notesMoodFilter'),
            
            // Editor Profesional & Font
            editorSection: document.getElementById('notesEditorSection'),
            titleInput: document.getElementById('notesTitleInput'),
            masterBtn: document.getElementById('editor-master-btn'),
            toolbar: document.getElementById('pro-toolbar'),
            editorContent: document.getElementById('pro-editor-content'),
            fontSelect: document.querySelector('#pro-toolbar select[data-command="fontName"]'), // [BARU]
            fontUploader: document.getElementById('customFontUploader'), // [BARU]
            clearFontsBtn: document.getElementById('clearCustomFontsBtn'), // [BARU]
            
            // Status Bar
            wordCountEl: document.getElementById('word-count'),
            charCountEl: document.getElementById('char-count'),
            readingTimeEl: document.getElementById('reading-time'),
            saveStatusEl: document.getElementById('save-status'),
            
            // Input Tambahan & Tombol Aksi
            dateFilter: document.getElementById('notesDateFilter'),
            moodSelector: document.getElementById('notesMoodSelector'),
            tagsInput: document.getElementById('notesTagsInput'),
            saveNoteBtn: document.getElementById('notesSaveBtn'),
            setPasswordBtn: document.getElementById('notesSetPasswordBtn'),
            clearEditorBtn: document.getElementById('notesClearEditorBtn'),
            
            // Daftar Catatan & Pratinjau
            notesList: document.getElementById('notesList'),
            previewModal: document.getElementById('notesPreviewModal'),
            previewContent: document.getElementById('notesPreviewContent'),
            closePreviewBtn: document.getElementById('notesClosePreviewBtn'),
        };
    }

    bindEvents() {
        this.dom.addNewNoteBtn.addEventListener('click', () => this.addNewNote());
        this.dom.saveNoteBtn.addEventListener('click', () => this.saveNote(true));
        this.dom.setPasswordBtn.addEventListener('click', () => this.setPasswordForCurrentNote());
        this.dom.clearEditorBtn.addEventListener('click', () => this.clearEditor());
        this.dom.searchInput.addEventListener('input', () => this.filterNotes());
        this.dom.moodFilter.addEventListener('change', () => this.filterNotes());

        // [BARU] Event listener untuk fitur font kustom
        this.dom.fontUploader.addEventListener('change', (e) => this.handleFontUpload(e));
        this.dom.clearFontsBtn.addEventListener('click', () => this.clearAllCustomFonts());

        // Event untuk Editor Profesional
        this.dom.masterBtn.addEventListener('click', () => this.toggleToolbar());

        this.dom.toolbar.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return; 

            const command = button.dataset.command;
            if (command) {
                e.preventDefault(); 
                this.handleCommand(command);
            }
        });

        this.dom.toolbar.querySelectorAll('select, input[type="color"]').forEach(input => {
            input.addEventListener('change', (e) => {
                const command = e.target.dataset.command;
                if (command) {
                    this.handleCommand(command, e.target.value);
                }
            });
        });
        
        this.dom.editorContent.addEventListener('input', () => this.updateStatusBar());
        this.dom.editorContent.addEventListener('blur', () => this.saveSelection());
        this.dom.editorContent.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); this.dom.editorContent.classList.add('dragover'); });
        this.dom.editorContent.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); this.dom.editorContent.classList.remove('dragover'); });
        this.dom.editorContent.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); this.dom.editorContent.classList.remove('dragover'); this.handleFileUpload(e.dataTransfer.files); });
        this.dom.editorContent.addEventListener('paste', (e) => this.handlePaste(e));

        // Event untuk Daftar Catatan
        this.dom.notesList.addEventListener('click', (e) => {
            const target = e.target.closest('button, .note-item-clickable');
            if (!target) return;
            const noteId = parseInt(target.dataset.id);
            const action = target.dataset.action;
            if (action === 'click-to-edit') { e.stopPropagation(); this.handleNoteClick(noteId); }
            if (action === 'delete') { e.stopPropagation(); this.deleteNote(noteId); }
            if (action === 'preview') { e.stopPropagation(); this.previewNote(noteId); }
        });
        this.dom.closePreviewBtn.addEventListener('click', () => this.closePreview());
    }
    
    // --- [BARU] LOGIKA FONT KUSTOM ---

    /** Memuat font yang sudah tersimpan saat aplikasi dimulai */
    loadSavedFonts() {
        this.customFonts = JSON.parse(localStorage.getItem('customFonts_v5.5.0')) || [];
        let fontStyleSheet = document.getElementById('custom-font-styles');
        if (!fontStyleSheet) {
            fontStyleSheet = document.createElement('style');
            fontStyleSheet.id = 'custom-font-styles';
            document.head.appendChild(fontStyleSheet);
        }
        
        this.customFonts.forEach(font => {
            const newFontFace = `@font-face { font-family: "${font.name}"; src: url(${font.url}); font-display: swap; }`;
            fontStyleSheet.innerHTML += newFontFace;
        });

        this.updateFontSelector();
    }

    /** Menangani file font yang diunggah oleh pengguna */
    handleFontUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const fontUrl = e.target.result;
            let fontName = file.name.split('.').slice(0, -1).join('.');
            fontName = fontName.replace(/[^a-zA-Z0-9\s-]/g, '').trim();

            if (!fontName) {
                showMessage(`Nama file font tidak valid.`, 'error');
                this.dom.fontUploader.value = '';
                return;
            }

            if (this.customFonts.some(f => f.name.toLowerCase() === fontName.toLowerCase())) {
                showMessage(`Font dengan nama "${fontName}" sudah ada.`, 'error');
                this.dom.fontUploader.value = '';
                return;
            }
            
            const newFont = { name: fontName, url: fontUrl };
            this.customFonts.push(newFont);
            
            const fontStyleSheet = document.getElementById('custom-font-styles');
            const newFontFace = `@font-face { font-family: "${fontName}"; src: url(${fontUrl}); font-display: swap; }`;
            fontStyleSheet.innerHTML += newFontFace;

            localStorage.setItem('customFonts_v5.5.0', JSON.stringify(this.customFonts));
            this.updateFontSelector();
            showMessage(`Font "${fontName}" berhasil ditambahkan!`, 'success');
            this.dom.fontUploader.value = '';
        };
        reader.readAsDataURL(file);
    }

    /** Memperbarui dropdown pilihan font di editor */
    updateFontSelector() {
        this.dom.fontSelect.innerHTML = '';

        const fallbackOption = document.createElement('option');
        fallbackOption.value = "'Poppins', sans-serif";
        fallbackOption.textContent = 'Default (Poppins)';
        this.dom.fontSelect.appendChild(fallbackOption);

        this.customFonts.forEach(font => {
            const option = document.createElement('option');
            option.value = `"${font.name}", sans-serif`;
            option.textContent = font.name;
            option.style.fontFamily = `"${font.name}", sans-serif`;
            this.dom.fontSelect.appendChild(option);
        });
    }
    
    /** Menghapus semua font kustom */
    clearAllCustomFonts() {
        showConfirm('Hapus Semua Font?', 'Anda yakin ingin menghapus semua font kustom yang telah diunggah?', () => {
            this.customFonts = [];
            localStorage.removeItem('customFonts_v5.5.0');
            const fontStyleSheet = document.getElementById('custom-font-styles');
            if (fontStyleSheet) {
                fontStyleSheet.innerHTML = '';
            }
            this.updateFontSelector();
            showMessage('Semua font kustom telah dihapus.', 'success');
        });
    }

    // --- LOGIKA EDITOR PROFESIONAL ---

    toggleToolbar() {
        this.dom.toolbar.classList.toggle('visible');
    }
    
    saveSelection() {
        if (window.getSelection) {
            const sel = window.getSelection();
            if (sel.getRangeAt && sel.rangeCount) {
                this.lastSelection = sel.getRangeAt(0);
            }
        }
    }

    restoreSelection() {
        if (this.lastSelection) {
            if (window.getSelection) {
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(this.lastSelection);
            }
        }
    }
    
    applyStyle(styleProperty, styleValue) {
        this.restoreSelection();
        this.dom.editorContent.focus();

        const selection = window.getSelection();
        if (!selection.rangeCount) return;

        const range = selection.getRangeAt(0);
        if (range.collapsed) {
             const span = document.createElement('span');
            span.style[styleProperty] = styleValue;
            span.innerHTML = '&#8203;'; 
            range.insertNode(span);
            
            const newRange = document.createRange();
            newRange.selectNodeContents(span);
            newRange.collapse(false);
            selection.removeAllRanges();
            selection.addRange(newRange);
            return;
        }

        document.execCommand('styleWithCSS', false, true);
        document.execCommand('fontName', false, 'tmp-font');
        document.execCommand('styleWithCSS', false, false);
        
        const fontElements = this.dom.editorContent.querySelectorAll('font[face="tmp-font"]');
        fontElements.forEach(fontElement => {
            const span = document.createElement('span');
            span.style[styleProperty] = styleValue;
            span.innerHTML = fontElement.innerHTML;
            fontElement.parentNode.replaceChild(span, fontElement);
        });
    }


    handleCommand(command, value = null) {
        const simpleCommands = ['undo', 'redo', 'cut', 'copy', 'bold', 'italic', 'underline', 'strikeThrough', 'subscript', 'superscript', 'justifyLeft', 'justifyCenter', 'justifyRight', 'justifyFull', 'insertOrderedList', 'insertUnorderedList', 'indent', 'outdent', 'insertHorizontalRule'];
        
        if (simpleCommands.includes(command)) {
            document.execCommand(command, false, value);
        } else if (command === 'clearFormatting') {
             document.execCommand('removeFormat', false, null);
        } else if (command === 'fontName') {
            this.applyStyle('fontFamily', value);
        } else if (command === 'formatBlock' || command === 'foreColor' || command === 'backColor') {
            document.execCommand(command, false, value);
        } else if (command === 'createLink') {
            const url = prompt('Masukkan URL:', 'https://');
            if (url) document.execCommand('createLink', false, url);
        } else if (command === 'embedYouTube') {
            this.embedYouTube();
        } else if (command === 'embedTikTok') {
            this.embedTikTok();
        } else if (command === 'uploadFile' || command === 'insertImage') {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,video/*,application/pdf,.txt,.md,.json';
            input.onchange = (e) => this.handleFileUpload(e.target.files);
            input.click();
        } else if (command === 'pasteKeepFormatting') {
            navigator.clipboard.read().then(items => {
                for (const item of items) {
                    if (item.types.includes('text/html')) {
                        item.getType('text/html').then(blob => {
                            blob.text().then(html => document.execCommand('insertHTML', false, html));
                        });
                        return;
                    }
                }
                navigator.clipboard.readText().then(text => document.execCommand('insertText', false, text));
            });
        } else if (command === 'pasteAsPlainText') {
            navigator.clipboard.readText().then(text => {
                document.execCommand('insertText', false, text);
            });
        } else {
            console.warn(`Perintah tidak dikenal: ${command}`);
        }
        this.dom.editorContent.focus();
    }

    handlePaste(e) {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text/plain');
        document.execCommand('insertText', false, text);
    }

    updateStatusBar() {
        const text = this.dom.editorContent.innerText || '';
        const wordCount = text.trim().split(/\s+/).filter(Boolean).length;
        const charCount = text.length;
        const readingTime = Math.ceil(wordCount / 200);

        this.dom.wordCountEl.innerHTML = `<i class="fas fa-file-word"></i>${wordCount} Kata`;
        this.dom.charCountEl.innerHTML = `<i class="fas fa-keyboard"></i>${charCount} Karakter`;
        this.dom.readingTimeEl.innerHTML = `<i class="fas fa-clock"></i>${readingTime} mnt`;
        
        this.dom.saveStatusEl.innerHTML = `<i class="fas fa-edit"></i>Belum disimpan`;
        this.dom.saveStatusEl.style.color = '#fbbf24';
    }

    // --- LOGIKA KATA SANDI & KEAMANAN LANJUTAN ---
    handleNoteClick(id) { const note = this.notes.find(n => n.id === id); if (note) { const lockdownKey = `lockdown_${id}`; const lockdownUntil = parseInt(localStorage.getItem(lockdownKey) || '0'); if (Date.now() < lockdownUntil) { const remaining = Math.ceil((lockdownUntil - Date.now()) / 1000); showMessage(`❌ Akses ditolak. Coba lagi dalam ${remaining} detik.`, 'error'); this.triggerHackEffect(true); return; } if (note.isLocked) { this.promptForPassword(id); } else { this.editNote(id); } } }
    
    promptForPassword(id) { 
        this.dom.passwordModal.classList.add('show'); 
        this.dom.passwordInput.value = ''; 
        this.dom.passwordInput.focus(); 
        this.dom.passwordPromptMessage.textContent = 'Masukkan kata sandi untuk membuka.'; 
        let attempts = 0; 
        const attemptKey = `attempts_${id}`; 
        const checkHandler = () => { 
            const note = this.notes.find(n => n.id === id); 
            if (note && this.dom.passwordInput.value === note.password) { 
                this.editNote(id); 
                this.dom.passwordModal.classList.remove('show'); 
                showMessage('Catatan terbuka!', 'success'); 
                localStorage.removeItem(attemptKey); 
                cleanup(); 
            } else { 
                attempts = parseInt(localStorage.getItem(attemptKey) || '0') + 1; 
                localStorage.setItem(attemptKey, attempts); 
                if (attempts === 1) { 
                    this.dom.passwordPromptMessage.textContent = '😕 Hmm, coba lagi.'; 
                } else if (attempts === 2) { 
                    this.dom.passwordPromptMessage.textContent = '😡 Masih salah, hati-hati!'; 
                } else if (attempts >= 3) { 
                    this.dom.passwordModal.classList.remove('show'); 
                    this.triggerLockdown(id); 
                    cleanup(); 
                    return; 
                } 
                this.dom.passwordInput.value = ''; 
                this.dom.passwordInput.focus(); 
            } 
        }; 
        const cancelHandler = () => { 
            this.dom.passwordModal.classList.remove('show'); 
            cleanup(); 
        }; 
        const cleanup = () => { 
            this.dom.checkPasswordBtn.removeEventListener('click', checkHandler); 
            this.dom.cancelPasswordBtn.removeEventListener('click', cancelHandler); 
        }; 
        this.dom.checkPasswordBtn.addEventListener('click', checkHandler); 
        this.dom.cancelPasswordBtn.addEventListener('click', cancelHandler); 
    }

    triggerLockdown(id) { 
        const lockdownDuration = 30000; 
        const lockdownKey = `lockdown_${id}`; 
        localStorage.setItem(lockdownKey, Date.now() + lockdownDuration); 
        localStorage.removeItem(`attempts_${id}`); 
        this.triggerHackEffect(); 
        setTimeout(() => { 
            localStorage.removeItem(lockdownKey); 
        }, lockdownDuration); 
    }
    
    // [PERBAIKAN] Fungsi ini sekarang menghentikan suara setelah selesai.
    triggerHackEffect(isResuming = false) { 
        this.dom.hackOverlay.style.display = 'flex'; 

        // Memutar suara satu kali
        if (this.dom.lockSound) {
            this.dom.lockSound.currentTime = 0; // Selalu mulai dari awal
            this.dom.lockSound.play().catch(e => console.error("Gagal memutar audio:", e));
        }

        const text = "Access Denied!\nSystem Lockdown Initiated...\nPlease wait 30 seconds..."; 
        let i = 0; 
        this.dom.hackText.innerHTML = ''; 
        const type = () => { 
            if (i < text.length) { 
                this.dom.hackText.innerHTML += text.charAt(i); 
                i++; 
                setTimeout(type, 50); 
            } else { 
                this.dom.hackText.innerHTML += '<span class="typewriter-cursor"></span>'; 
                setInterval(() => { 
                    this.dom.hackText.classList.toggle('glitch'); 
                }, 200); 
            } 
        }; 
        type(); 
        
        setTimeout(() => { 
            this.dom.hackOverlay.style.display = 'none'; 
            this.dom.hackText.classList.remove('glitch'); 
            // [PERBAIKAN] Hentikan dan reset audio saat efek visual selesai
            if (this.dom.lockSound) {
                this.dom.lockSound.pause();
                this.dom.lockSound.currentTime = 0;
            }
        }, isResuming ? 5000 : 30000); 
    }

    // [PERUBAHAN] Menggunakan modal kustom baru
    async setPasswordForCurrentNote() {
        if (!this.currentNoteId) {
            showMessage('Simpan catatan terlebih dahulu sebelum menguncinya.', 'error');
            return;
        }
        const note = this.notes.find(n => n.id === this.currentNoteId);
        if (!note) return;

        if (note.isLocked) {
            const currentPassword = await showCustomPrompt('Ubah Kata Sandi', 'Masukkan kata sandi saat ini untuk melanjutkan.', 'Kata sandi saat ini');
            if (currentPassword === null) return; // Pengguna membatalkan
            if (currentPassword !== note.password) {
                showMessage('Kata sandi saat ini salah.', 'error');
                return;
            }
        }

        const newPassword = await showCustomPrompt('Atur Kata Sandi Baru', 'Masukkan kata sandi baru (kosongkan untuk membuka kunci).', 'Kata sandi baru');
        if (newPassword === null) return; // Pengguna membatalkan

        if (newPassword) {
            note.isLocked = true;
            note.password = newPassword;
            showMessage('Catatan berhasil dikunci!', 'success');
        } else {
            note.isLocked = false;
            delete note.password;
            showMessage('Kunci catatan berhasil dibuka.', 'success');
        }

        this.saveToStorage();
        this.displayNotes();
    }

    // --- FUNGSI INTI ---
    embedYouTube() { const url = prompt("Masukkan URL video YouTube:"); if (!url) return; let videoId = null; const regexes = [/(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([^&]+)/, /(?:https?:\/\/)?(?:www\.)?youtu\.be\/([^?]+)/, /(?:https?:\/\/)?(?:www\.)?youtube\.com\/embed\/([^?]+)/]; for (const regex of regexes) { const match = url.match(regex); if (match && match[1]) { videoId = match[1]; break; } } if (videoId) { const embedHTML = `<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; margin: 1rem 0;"><iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 8px;"></iframe></div><p><br></p>`; document.execCommand('insertHTML', false, embedHTML); } else { showMessage("URL YouTube tidak valid.", "error"); } }
    embedTikTok() { const url = prompt("Masukkan URL video TikTok:"); if (!url) return; const regex = /tiktok\.com\/.*\/video\/(\d+)/; const match = url.match(regex); const videoId = match && match[1] ? match[1] : null; if (videoId) { const embedHTML = `<div style="position: relative; padding-bottom: 177.78%; height: 0; overflow: hidden; max-width: 325px; margin: 1rem auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);"><iframe src="https://www.tiktok.com/embed/v2/${videoId}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></iframe></div><p><br></p>`; document.execCommand('insertHTML', false, embedHTML); showMessage("Video TikTok berhasil disematkan!", "success"); } else { showMessage("URL TikTok tidak valid. Pastikan URL berisi '/video/...' dan ID video.", "error"); } }
    handleFileUpload(files) { if (!files || files.length === 0) return; const file = files[0]; const reader = new FileReader(); reader.onload = (e) => { const result = e.target.result; let elementHTML = ''; if (file.type.startsWith('image/')) { elementHTML = `<img src="${result}" style="max-width: 100%; height: auto; border-radius: 8px; margin: 1rem 0;" />`; } else if (file.type.startsWith('video/')) { elementHTML = `<video controls src="${result}" style="max-width: 100%; border-radius: 8px; margin: 1rem 0;"></video>`; } else if (file.type === 'application/pdf') { elementHTML = `<embed src="${result}" type="application/pdf" width="100%" height="500px" style="border-radius: 8px; margin: 1rem 0;" />`; } else if (file.type.startsWith('text/') || file.name.endsWith('.md') || file.name.endsWith('.json')) { const escapedText = result.replace(/</g, "&lt;").replace(/>/g, "&gt;"); elementHTML = `<pre style="background: rgba(0,0,0,0.2); border: 1px solid var(--input-border); padding: 1rem; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word;"><code>${escapedText}</code></pre>`; } else { showMessage(`Tipe file ${file.type} tidak didukung untuk pratinjau.`, 'error'); return; } document.execCommand('insertHTML', false, elementHTML + "<p><br></p>"); }; if (file.type.startsWith('text/') || file.name.endsWith('.md') || file.name.endsWith('.json')) { reader.readAsText(file); } else { reader.readAsDataURL(file); } }
    saveNote(isManual = false) { const title = this.dom.titleInput.value.trim(); const content = this.dom.editorContent.innerHTML; const tags = this.dom.tagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag); const mood = this.dom.moodSelector.value; const date = this.dom.dateFilter.value || new Date().toISOString().split('T')[0]; if (!title && !content.trim()) { if (isManual) showMessage('Judul atau isi tidak boleh kosong.', 'error'); return; } if (this.currentNoteId) { const index = this.notes.findIndex(n => n.id === this.currentNoteId); const existingNote = this.notes[index]; existingNote.title = title; existingNote.content = content; existingNote.tags = tags; existingNote.mood = mood; existingNote.date = new Date(date).toISOString(); existingNote.lastModified = new Date().toISOString(); } else { const note = { id: Date.now(), title: title, content: content, tags: tags, mood: mood, date: new Date(date).toISOString(), lastModified: new Date().toISOString(), isLocked: false }; this.notes.unshift(note); this.currentNoteId = note.id; } this.saveToStorage(); this.displayNotes(); if (isManual) { showMessage('Catatan disimpan!', 'success'); this.dom.saveStatusEl.innerHTML = `<i class="fas fa-cloud"></i>Disimpan`; this.dom.saveStatusEl.style.color = 'var(--text-secondary)'; } }
    autoSave() { const title = this.dom.titleInput.value.trim(); const content = this.dom.editorContent.innerHTML; if ((title || content.trim()) && this.currentNoteId) { this.saveNote(); showMessage('Tersimpan otomatis', 'info'); this.dom.saveStatusEl.innerHTML = `<i class="fas fa-cloud"></i>Disimpan`; this.dom.saveStatusEl.style.color = 'var(--text-secondary)'; } }
    loadNotes() { const saved = localStorage.getItem('notes_v5.5.0'); if (saved) { this.notes = JSON.parse(saved); this.displayNotes(); } }
    saveToStorage() { localStorage.setItem('notes_v5.5.0', JSON.stringify(this.notes)); }
    displayNotes(filteredNotes = null) { const notesToShow = (filteredNotes || this.notes).sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified)); if (notesToShow.length === 0) { this.dom.notesList.innerHTML = '<div class="text-center text-gray-500 py-4">Tidak ada catatan.</div>'; return; } this.dom.notesList.innerHTML = notesToShow.map(note => { const lockIcon = note.isLocked ? '<i class="fas fa-lock text-yellow-500 text-xs ml-2"></i>' : ''; return `<div class="note-item p-3 rounded-lg mb-2 cursor-pointer note-item-clickable" data-action="click-to-edit" data-id="${note.id}"><div class="flex items-start justify-between mb-1"><div><strong class="text-md text-purple-300">${note.title || 'Tanpa Judul'}${lockIcon}</strong><span class="block text-xs text-gray-400">${this.formatDate(note.lastModified)}</span></div><div class="flex gap-2"><button data-action="preview" data-id="${note.id}" class="text-green-400 hover:text-green-300"><i class="fas fa-eye"></i></button><button data-action="delete" data-id="${note.id}" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button></div></div><div class="text-sm text-gray-400">${note.isLocked ? '<em>Konten terkunci...</em>' : this.truncateContent(note.content, 80)}</div></div>`; }).join(''); }
    editNote(id) { const note = this.notes.find(n => n.id === id); if (note) { this.currentNoteId = id; this.dom.titleInput.value = note.title; this.dom.editorContent.innerHTML = note.content; this.dom.tagsInput.value = note.tags.join(', '); this.dom.moodSelector.value = note.mood; this.dom.dateFilter.value = note.date.split('T')[0]; this.dom.titleInput.focus(); this.updateStatusBar(); showMessage('Catatan dimuat untuk diedit', 'info'); } }
    deleteNote(id) { showConfirm('Hapus Catatan?', 'Yakin ingin menghapus catatan ini secara permanen?', () => { this.notes = this.notes.filter(n => n.id !== id); this.saveToStorage(); this.displayNotes(); if (this.currentNoteId === id) { this.clearEditor(); } showMessage('Catatan dihapus!', 'success'); }); }
    previewNote(id) { const note = this.notes.find(n => n.id === id); if (note) { if (note.isLocked) { showMessage('Catatan ini terkunci. Buka kunci untuk melihat pratinjau.', 'error'); return; } this.dom.previewContent.innerHTML = `<h2 class="font-bold text-2xl mb-2 text-purple-300">${note.title || 'Tanpa Judul'}</h2><p class="text-sm text-gray-400 mb-4">${this.formatDate(note.lastModified)}</p><div class="pro-editor-content max-w-none">${note.content}</div>`; this.dom.previewModal.classList.add('show'); } }
    closePreview() { this.dom.previewModal.classList.remove('show'); }
    clearEditor() { this.dom.titleInput.value = ''; this.dom.editorContent.innerHTML = ''; this.dom.tagsInput.value = ''; this.dom.moodSelector.value = 'neutral'; this.dom.dateFilter.value = new Date().toISOString().split('T')[0]; this.currentNoteId = null; this.updateStatusBar(); }
    addNewNote() { this.clearEditor(); this.dom.titleInput.focus(); showMessage('Editor siap untuk catatan baru.', 'info'); }
    filterNotes() { const query = this.dom.searchInput.value.toLowerCase(); const mood = this.dom.moodFilter.value; let filtered = this.notes; if (query) { filtered = filtered.filter(note => (note.title && note.title.toLowerCase().includes(query)) || (!note.isLocked && note.content.toLowerCase().includes(query)) || note.tags.some(tag => tag.toLowerCase().includes(query))); } if (mood) { filtered = filtered.filter(note => note.mood === mood); } this.displayNotes(filtered); }
    formatDate(dateString) { return dateString ? new Date(dateString).toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' }) : ''; }
    truncateContent(html, length) { const text = html.replace(/<[^>]*>/g, ''); if (text.length <= length) return text; return text.substring(0, length) + '...'; }
}

// ===================================================================================
// ========================== BAGIAN 2: LOGIKA APLIKASI UTAMA ========================
// ===================================================================================

// --- Variabel Global dan Inisialisasi ---
let currentSection = 'dashboard'; 
let currentDate = new Date(); 
let currentMode = 'personal'; 
let timerInterval; 
let timerMinutes = 25; 
let timerSeconds = 0; 
let isTimerRunning = false; 
let touchStartX = 0; 
let touchEndX = 0; 
let isDragging = false; 

let masterDateRange = '7d'; 
let financeDateRange = { start: null, end: null };
let dateRangeSource = 'dashboard';

// Objek helper untuk mengelola LocalStorage
const storage = { 
    get: (key, defaultValue = null) => { 
        try { 
            const item = localStorage.getItem(key); 
            return item ? JSON.parse(item) : defaultValue; 
        } catch { 
            return defaultValue; 
        } 
    }, 
    set: (key, value) => { 
        localStorage.setItem(key, JSON.stringify(value)); 
    }, 
    getAppData: () => { 
        return storage.get('lifeHubData_v5.5.0', { 
            currentMode: 'personal', 
            theme: 'dark', 
            isVideoMuted: true, 
            personal: { transactions: [], tasks: [], splitBills: [], portals: [] }, 
            business: { transactions: [], tasks: [], splitBills: [], portals: [] } 
        }); 
    }, 
    saveAppData: (data) => { 
        storage.set('lifeHubData_v5.5.0', data); 
    } 
};

// Konfigurasi Google Drive API
const GOOGLE_CLIENT_ID = "175269804015-7agb1gr0nd6ah66co5qen34dd2mvtm68.apps.googleusercontent.com"; 
const GOOGLE_SCOPES = "https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email";
const DRIVE_FOLDER_NAME = "Uranuspace_App_Backups"; 
let googleTokenClient; 
let googleAccessToken = null;

// Titik masuk utama aplikasi
document.addEventListener('DOMContentLoaded', function() { 
    initializeApp(); 
    setupEventListeners(); 
    const notesApp = new NotesApp(); 
    notesApp.init(); 
    setTimeout(initGisClient, 500); 
});

/**
 * Inisialisasi status awal aplikasi saat pertama kali dimuat.
 */
async function initializeApp() {
    // Fungsi loadAndApplyCustomBackground diubah untuk membaca dari IndexedDB
    const bgMediaBlob = await getFileFromDB('customBackground');
    const bgType = localStorage.getItem('customBackgroundType');

    if (bgMediaBlob && bgType) {
        const bgUrl = URL.createObjectURL(bgMediaBlob);
        const bgVideo = document.getElementById('bg-video');
        const bgImageLayer = document.getElementById('bg-image-layer');
        resetBackgrounds(); 

        if (bgType.startsWith('image/')) {
            bgImageLayer.style.backgroundImage = `url('${bgUrl}')`;
            bgImageLayer.style.display = 'block';
            document.body.classList.remove('gradient-bg');
        } else if (bgType.startsWith('video/')) {
            bgVideo.src = bgUrl;
            bgVideo.style.display = 'block';
            const appData = storage.getAppData();
            bgVideo.muted = appData.isVideoMuted;
            bgVideo.play().catch(e => console.error("Gagal memutar video saat memuat:", e));
            document.body.classList.remove('gradient-bg');
        }
    }


    const appData = storage.getAppData();
    currentMode = appData.currentMode || 'personal';
    document.getElementById('modeSelect').value = currentMode;
    
    if (appData.theme === 'light') {
        document.body.classList.add('light-mode');
    } else if (appData.theme === 'black') {
        document.body.classList.add('black-mode');
    }
    updateThemeUI(appData.theme || 'dark');
    document.getElementById('bg-video').muted = appData.isVideoMuted;
    updateVideoSoundUI();
    const splitBillDateInput = document.getElementById('splitBillDate');
    if (splitBillDateInput) {
        splitBillDateInput.value = new Date().toISOString().split('T')[0];
    }
    switchSection('dashboard');
    renderPortals(); // Memuat portal di sidebar saat aplikasi dimulai
}

/**
 * Menyiapkan semua event listener utama untuk elemen UI.
 */
function setupEventListeners() { 
    document.querySelectorAll('.nav-item').forEach(item => item.addEventListener('click', () => switchSection(item.dataset.section))); 
    document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu); 
    document.getElementById('overlay').addEventListener('click', closeMobileMenu); 
    document.getElementById('themeToggle').addEventListener('click', toggleTheme); 
    document.getElementById('modeSelect').addEventListener('change', switchMode); 
    document.getElementById('logo-container').addEventListener('click', enterPreviewMode); 
    document.getElementById('addTransactionBtn').addEventListener('click', () => showTransactionModal()); 
    document.getElementById('exportFinanceBtn').addEventListener('click', exportFinancePDF); 
    document.getElementById('searchTransaction').addEventListener('input', filterAndRenderTransactions); 
    document.getElementById('categoryFilter').addEventListener('change', filterAndRenderTransactions); 
    document.getElementById('typeFilter').addEventListener('change', filterAndRenderTransactions); 
    document.getElementById('financeDateFilterBtn').addEventListener('click', () => showDateRangeModal('finance')); 
    document.getElementById('taskForm').addEventListener('submit', saveTask); 
    document.getElementById('startTimerBtn').addEventListener('click', startTimer); 
    document.getElementById('pauseTimerBtn').addEventListener('click', pauseTimer); 
    document.getElementById('resetTimerBtn').addEventListener('click', resetTimer); 
    document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1)); 
    document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1)); 
    document.getElementById('splitBillForm').addEventListener('submit', calculateSplitBill); 
    document.getElementById('backupData').addEventListener('click', backupData); 
    document.getElementById('restoreData').addEventListener('click', restoreData); 
    document.getElementById('clearAllData').addEventListener('click', () => { showConfirm('Hapus Semua Data?', 'Operasi ini tidak dapat diurungkan. Anda yakin ingin menghapus semua data lokal?', clearAllDataConfirmed); }); 
    document.getElementById('applyBgMediaBtn').addEventListener('click', applyUploadedMedia); 
    document.getElementById('resetBgMediaBtn').addEventListener('click', resetBackgroundMedia); 
    document.getElementById('toggleVideoSoundBtn').addEventListener('click', toggleVideoSound); 
    document.body.addEventListener('touchstart', handleTouchStart, { passive: true }); 
    document.body.addEventListener('touchend', handleTouchEnd); 
    document.body.addEventListener('mousedown', handleMouseDown); 
    document.body.addEventListener('mouseup', handleMouseUp); 
    setupMasterRangeSelector(); 
    document.getElementById('applyDateRange').addEventListener('click', applyDateRange); 
    document.getElementById('cancelDateRange').addEventListener('click', () => document.getElementById('dateRangeModal').classList.remove('show')); 
    document.getElementById('auth-button').addEventListener('click', handleAuthClick); 
    document.getElementById('backup-button').addEventListener('click', handleBackupClick); 
    document.getElementById('restore-button').addEventListener('click', showRestoreOptionsModal); 
    document.getElementById('addNewPortalBtn').addEventListener('click', showPortalModal);
    // [PERUBAHAN] Menambahkan event listener untuk ikon mata
    document.getElementById('toggle-email-visibility').addEventListener('click', toggleEmailVisibility);
    
    // [PERBAIKAN] Menambahkan event listener untuk mematikan suara saat tab tidak aktif
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            document.getElementById('lockSound')?.pause();
        }
    });

    const exportPdfBtn = document.getElementById('export-pdf-btn');
    const pdfTimeRangeSelector = document.getElementById('pdf-time-range');
    const pdfCustomRangeInputs = document.getElementById('pdf-custom-range-inputs');

    pdfTimeRangeSelector.addEventListener('change', () => {
        if (pdfTimeRangeSelector.value === 'custom') {
            pdfCustomRangeInputs.classList.remove('hidden');
        } else {
            pdfCustomRangeInputs.classList.add('hidden');
        }
    });

    exportPdfBtn.addEventListener('click', () => {
        const selectedRange = pdfTimeRangeSelector.value;
        if (selectedRange === 'custom') {
            const startDate = document.getElementById('pdf-start-date').value;
            const endDate = document.getElementById('pdf-end-date').value;
            if (!startDate || !endDate) {
                showMessage('Harap pilih tanggal mulai dan selesai untuk rentang kustom.', 'error');
                return;
            }
            exportAllToPdf('custom', startDate, endDate);
        } else {
            exportAllToPdf(selectedRange);
        }
    });
    
    // [BARU] Event listener untuk tombol ekspor gambar
    document.getElementById('export-images-btn').addEventListener('click', () => {
        const selectedRange = document.getElementById('pdf-time-range').value;
        if (selectedRange === 'custom') {
            const startDate = document.getElementById('pdf-start-date').value;
            const endDate = document.getElementById('pdf-end-date').value;
            if (!startDate || !endDate) {
                showMessage('Harap pilih tanggal mulai dan selesai untuk rentang kustom.', 'error');
                return;
            }
            exportAllToImages('custom', startDate, endDate);
        } else {
            exportAllToImages(selectedRange);
        }
    });
}
function enterPreviewMode() { document.body.classList.add('preview-mode'); } function handleGestureEnd() { const swipeThreshold = 70; const deltaX = touchEndX - touchStartX; if (document.querySelector('.modal.show')) return; if (deltaX < -swipeThreshold) { document.body.classList.remove('preview-mode'); } } function handleTouchStart(e) { touchStartX = e.changedTouches[0].screenX; } function handleTouchEnd(e) { touchEndX = e.changedTouches[0].screenX; handleGestureEnd(); } function handleMouseDown(e) { if (e.button !== 0 || e.target.closest('button, input, select, textarea, a, .modal')) return; isDragging = true; touchStartX = e.screenX; } function handleMouseUp(e) { if (!isDragging) return; isDragging = false; touchEndX = e.screenX; handleGestureEnd(); }
function switchSection(section) { 
    // [PERBAIKAN] Hentikan suara terminal setiap kali berpindah section
    document.getElementById('lockSound')?.pause();

    document.querySelectorAll('.section').forEach(s => s.classList.add('hidden')); 
    document.getElementById(section + '-section').classList.remove('hidden'); 
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active')); 
    document.querySelector(`[data-section="${section}"]`).classList.add('active'); 
    currentSection = section; 
    switch(section) { 
        case 'dashboard': loadDashboard(); break; 
        case 'finance': loadFinancePage(); break; 
        case 'tasks': loadTasksPage(); break; 
        case 'split': loadSplitPage(); break; 
        case 'notes': break; 
        case 'settings': break; 
    } 
    closeMobileMenu(); 
}
function switchMode(e) { currentMode = e.target.value; let appData = storage.getAppData(); appData.currentMode = currentMode; storage.saveAppData(appData); switchSection(currentSection); renderPortals(); } 

function toggleTheme() {
    let currentTheme = 'dark'; // Default
    if (document.body.classList.contains('light-mode')) {
        currentTheme = 'light';
    } else if (document.body.classList.contains('black-mode')) {
        currentTheme = 'black';
    }

    let nextTheme;
    document.body.classList.remove('light-mode', 'black-mode');

    if (currentTheme === 'dark') {
        nextTheme = 'light';
        document.body.classList.add('light-mode');
    } else if (currentTheme === 'light') {
        nextTheme = 'black';
        document.body.classList.add('black-mode');
    } else { // currentTheme is 'black'
        nextTheme = 'dark';
    }

    let appData = storage.getAppData();
    appData.theme = nextTheme;
    storage.saveAppData(appData);
    updateThemeUI(nextTheme);
}

function updateThemeUI(theme) {
    const icon = document.querySelector('#themeToggle i');
    icon.classList.remove('fa-sun', 'fa-moon', 'fa-star');

    if (theme === 'dark') {
        icon.classList.add('fa-sun');
    } else if (theme === 'light') {
        icon.classList.add('fa-moon');
    } else { // theme is 'black'
        icon.classList.add('fa-star');
    }
    
    if (currentSection === 'dashboard') {
        refreshDashboardData();
    }
    renderPortals();
}

// [FIX] Menambahkan kembali fungsi yang hilang untuk menu hamburger
function toggleMobileMenu() { 
    document.getElementById('sidebar').classList.toggle('open'); 
    document.getElementById('overlay').classList.toggle('show'); 
} 
function closeMobileMenu() { 
    document.getElementById('sidebar').classList.remove('open'); 
    document.getElementById('overlay').classList.remove('show'); 
}

function loadDashboard() { const appData = storage.getAppData(); const modeData = appData[currentMode]; const balance = modeData.transactions.reduce((sum, t) => sum + (t.type === 'income' ? t.amount : -t.amount), 0); const today = new Date().toISOString().split('T')[0]; const todayTasks = modeData.tasks.filter(p => p.datetime && p.datetime.startsWith(today) && !p.completed).length; const pendingTasks = modeData.tasks.filter(t => !t.completed).length; document.getElementById('totalBalance').textContent = formatCurrency(balance); document.getElementById('todayTasksCount').textContent = todayTasks; document.getElementById('pendingTasks').textContent = pendingTasks; document.getElementById('activeMode').textContent = currentMode === 'personal' ? 'Pribadi' : 'Bisnis'; refreshDashboardData(); }
function refreshDashboardData() { updateDashboardCharts(); loadAnalysisCharts(); loadRecentActivities(); } function loadRecentActivities() { const appData = storage.getAppData(); const modeData = appData[currentMode]; const activities = []; const filteredTransactions = filterDataByRange(modeData.transactions, masterDateRange, 'date'); const filteredTasks = filterDataByRange(modeData.tasks, masterDateRange, 'datetime'); const filteredSplits = filterDataByRange(modeData.splitBills, masterDateRange, 'date'); filteredTransactions.forEach(t => activities.push({ type: 'transaction', icon: t.type === 'income' ? 'fa-arrow-up text-green-500' : 'fa-arrow-down text-pink-500', text: `${t.type === 'income' ? 'Pemasukan' : 'Pengeluaran'}: ${formatCurrency(t.amount)}`, time: t.date })); filteredTasks.forEach(p => activities.push({ type: 'task', icon: 'fa-calendar-check text-blue-500', text: `Tugas: ${p.title}`, time: p.datetime })); filteredSplits.forEach(s => activities.push({ type: 'split', icon: 'fa-receipt text-green-500', text: `Split Bill: ${formatCurrency(s.totalBill)}`, time: s.date })); activities.sort((a, b) => new Date(b.time) - new Date(a.time)); const container = document.getElementById('recentActivities'); container.innerHTML = activities.length > 0 ? activities.slice(0, 15).map(activity => `<div class="flex items-center justify-between p-2 hover:bg-purple-500/10 rounded"><div class="flex items-center"><i class="fas ${activity.icon} mr-3"></i><span>${activity.text}</span></div><span class="text-sm text-gray-400">${formatDate(activity.time)}</span></div>`).join('') : '<p class="text-gray-500">Tidak ada aktivitas dalam rentang waktu ini.</p>'; }
function loadFinancePage() { populateFinanceFilters(); filterAndRenderTransactions(); updateFinanceSummary(); } function updateFinanceSummary() { const appData = storage.getAppData(); const transactions = appData[currentMode].transactions; const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0); const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0); document.getElementById('totalIncome').textContent = formatCurrency(income); document.getElementById('totalExpense').textContent = formatCurrency(expense); document.getElementById('balance').textContent = formatCurrency(income - expense); } 
function filterAndRenderTransactions() { const appData = storage.getAppData(); let transactions = appData[currentMode].transactions; const search = document.getElementById('searchTransaction').value.toLowerCase(); const category = document.getElementById('categoryFilter').value; const type = document.getElementById('typeFilter').value; if (search) transactions = transactions.filter(t => t.description.toLowerCase().includes(search)); if (category) transactions = transactions.filter(t => t.category === category); if (type) transactions = transactions.filter(t => t.type === type); if (financeDateRange.start && financeDateRange.end) { transactions = transactions.filter(t => { const tDate = new Date(t.date); return tDate >= new Date(financeDateRange.start) && tDate <= new Date(financeDateRange.end); }); } displayTransactions(transactions); } 
function displayTransactions(transactions) { const container = document.getElementById('transactionsList'); if (transactions.length === 0) { container.innerHTML = '<p class="text-center text-gray-500">Belum ada transmisi data</p>'; return; } container.innerHTML = [...transactions].reverse().map(t => `<div class="p-4 rounded-md flex justify-between items-center hover:bg-purple-500/10 cursor-pointer ${t.type}" onclick="showTransactionModal('${t.id}')"><div class="flex items-center"><i class="fas ${getTransactionIcon(t.category)} mr-4 text-xl"></i><div><h4 class="font-semibold">${t.description}</h4><p class="text-sm text-gray-400">${getCategoryName(t.category)} • ${formatDate(t.date)}</p></div></div><div class="text-right"><p class="font-bold font-mono ${t.type === 'income' ? 'text-green-500' : 'text-pink-500'}">${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}</p><button onclick="confirmDeleteTransaction('${t.id}', event)" class="text-red-500 hover:text-red-400 ml-2 text-xs"><i class="fas fa-trash"></i></button></div></div>`).join(''); } function showTransactionModal(id = null) { const appData = storage.getAppData(); const transaction = id ? appData[currentMode].transactions.find(t => t.id === id) : null; const content = `<div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold text-purple-600">${id ? 'Edit' : 'Tambah'} Transaksi</h3><button class="closeModal text-gray-400 hover:text-purple-600"><i class="fas fa-times"></i></button></div><form id="transactionForm" class="space-y-4"><input type="hidden" id="transactionId" value="${id || ''}"><div><label class="block text-sm font-medium mb-1">Tipe</label><select id="transactionType" class="custom-input" required>${['income', 'expense'].map(o => `<option value="${o}" ${transaction?.type === o ? 'selected' : ''}>${o === 'income' ? 'Pemasukan' : 'Pengeluaran'}</option>`).join('')}</select></div><div><label class="block text-sm font-medium mb-1">Jumlah</label><input type="number" id="transactionAmount" class="custom-input" value="${transaction?.amount || ''}" required></div><div><label class="block text-sm font-medium mb-1">Kategori</label><select id="transactionCategory" class="custom-input" required>${Object.keys(getCategoryName()).map(c => `<option value="${c}" ${transaction?.category === c ? 'selected' : ''}>${getCategoryName(c)}</option>`).join('')}</select></div><div><label class="block text-sm font-medium mb-1">Deskripsi</label><input type="text" id="transactionDescription" class="custom-input" value="${transaction?.description || ''}" required></div><div><label class="block text-sm font-medium mb-1">Tanggal</label><input type="date" id="transactionDate" class="custom-input" value="${transaction?.date || new Date().toISOString().split('T')[0]}" required></div><div class="flex gap-2 mt-6"><button type="submit" class="custom-button flex-1">Simpan</button><button type="button" class="closeModal custom-button custom-button-danger">Batal</button></div></form>`; showModal(content); document.getElementById('transactionForm').addEventListener('submit', saveTransaction); } function saveTransaction(e) { e.preventDefault(); const id = document.getElementById('transactionId').value || generateId(); const newTransaction = { id, type: document.getElementById('transactionType').value, amount: parseFloat(document.getElementById('transactionAmount').value), category: document.getElementById('transactionCategory').value, description: document.getElementById('transactionDescription').value, date: document.getElementById('transactionDate').value, }; let appData = storage.getAppData(); if (document.getElementById('transactionId').value) { const index = appData[currentMode].transactions.findIndex(t => t.id === id); if (index > -1) appData[currentMode].transactions[index] = newTransaction; } else { appData[currentMode].transactions.push(newTransaction); } storage.saveAppData(appData); loadFinancePage(); closeModal(); showMessage("Transaksi disimpan!", "success"); } function confirmDeleteTransaction(id, event) { event.stopPropagation(); showConfirm('Hapus Transaksi?', 'Yakin ingin menghapus transmisi data ini?', () => deleteTransaction(id)); } function deleteTransaction(id) { let appData = storage.getAppData(); appData[currentMode].transactions = appData[currentMode].transactions.filter(t => t.id !== id); storage.saveAppData(appData); loadFinancePage(); } function populateFinanceFilters() { const appData = storage.getAppData(); const categories = [...new Set(appData[currentMode].transactions.map(t => t.category))]; const categoryFilter = document.getElementById('categoryFilter'); categoryFilter.innerHTML = '<option value="">Semua Kategori</option>' + categories.map(c => `<option value="${c}">${getCategoryName(c)}</option>`).join(''); const typeFilter = document.getElementById('typeFilter'); typeFilter.innerHTML = '<option value="">Semua Tipe</option><option value="income">Pemasukan</option><option value="expense">Pengeluaran</option>'; }
function loadTasksPage() { renderTasks(); generateCalendar(); } function renderTasks() { const appData = storage.getAppData(); const tasks = appData[currentMode].tasks; const list = document.getElementById('taskList'); list.innerHTML = ''; const sortedTasks = [...tasks].sort((a, b) => new Date(a.datetime) - new Date(b.datetime)); if (sortedTasks.length === 0) { list.innerHTML = '<p class="text-gray-500 text-center">Tidak ada tugas. Waktunya bersantai!</p>'; return; } sortedTasks.forEach(task => { const item = document.createElement('div'); item.className = `task-item p-3 rounded-lg flex justify-between items-center hover:bg-purple-500/10 ${task.completed ? 'completed' : ''}`; const priorityColor = { high: '#f472b6', medium: '#fbbf24', low: '#4ade80' }; item.innerHTML = `<div class="flex items-center"><input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask('${task.id}')" class="w-5 h-5 rounded bg-purple-900/50 border-purple-400 text-purple-600 focus:ring-purple-500"><div class="ml-4"><strong class="block">${task.title}</strong><small class="text-gray-400">${formatDateTime(task.datetime)} | <span style="color: ${priorityColor[task.priority]}">●</span> ${task.priority}</small></div></div><button onclick="confirmDeleteTask('${task.id}')" class="text-red-500 hover:text-red-400"><i class="fas fa-trash"></i></button>`; list.appendChild(item); }); } function saveTask(e) { e.preventDefault(); const task = { id: generateId(), title: document.getElementById('taskTitle').value, datetime: document.getElementById('taskDateTime').value, priority: document.getElementById('taskPriority').value, completed: false, }; let appData = storage.getAppData(); appData[currentMode].tasks.push(task); storage.saveAppData(appData); renderTasks(); generateCalendar(); document.getElementById('taskForm').reset(); showMessage("Tugas ditambahkan!", "success"); } function toggleTask(id) { let appData = storage.getAppData(); const task = appData[currentMode].tasks.find(t => t.id === id); if (task) { task.completed = !task.completed; storage.saveAppData(appData); renderTasks(); generateCalendar(); } } function confirmDeleteTask(id) { showConfirm('Hapus Tugas?', 'Yakin ingin menghapus tugas ini?', () => deleteTask(id)); } function deleteTask(id) { let appData = storage.getAppData(); appData[currentMode].tasks = appData[currentMode].tasks.filter(t => t.id !== id); storage.saveAppData(appData); renderTasks(); generateCalendar(); }
function generateCalendar() { const calendar = document.getElementById('calendar'); document.getElementById('currentMonth').textContent = new Intl.DateTimeFormat('id-ID', { month: 'long', year: 'numeric' }).format(currentDate); calendar.innerHTML = ''; const year = currentDate.getFullYear(); const month = currentDate.getMonth(); const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); const appData = storage.getAppData(); const tasks = appData[currentMode].tasks; const days = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab']; days.forEach(day => calendar.innerHTML += `<div class="text-center font-bold text-purple-400 text-sm">${day}</div>`); for (let i = 0; i < firstDay; i++) calendar.innerHTML += '<div></div>'; for (let day = 1; day <= daysInMonth; day++) { const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; const dayTasks = tasks.filter(t => t.datetime && t.datetime.startsWith(dateStr)); const isToday = new Date().toDateString() === new Date(year, month, day).toDateString(); let dayClass = 'text-center p-2 border border-transparent rounded-md transition-colors duration-300 relative'; if (isToday) dayClass += ' border-purple-400 bg-purple-500/10'; let priorityIndicator = ''; if (dayTasks.length > 0) { const hasHigh = dayTasks.some(t => t.priority === 'high' && !t.completed); const hasMedium = dayTasks.some(t => t.priority === 'medium' && !t.completed); const hasLow = dayTasks.some(t => t.priority === 'low' && !t.completed); let indicatorColor = ''; if (hasHigh) indicatorColor = '#f472b6'; else if (hasMedium) indicatorColor = '#fbbf24'; else if (hasLow) indicatorColor = '#4ade80'; if (indicatorColor) { priorityIndicator = `<span class="absolute top-1 right-1 h-2 w-2 rounded-full" style="background-color: ${indicatorColor};"></span>`; } } calendar.innerHTML += `<div class="${dayClass}">${day}${priorityIndicator}</div>`; } }
function changeMonth(dir) { currentDate.setMonth(currentDate.getMonth() + dir); generateCalendar(); }
function startTimer() { if (isTimerRunning) return; isTimerRunning = true; timerInterval = setInterval(() => { if (timerSeconds === 0) { if (timerMinutes === 0) { resetTimer(); showMessage("Pomodoro Selesai!", "success"); return; } timerMinutes--; timerSeconds = 59; } else { timerSeconds--; } updateTimerDisplay(); }, 1000); } function pauseTimer() { isTimerRunning = false; clearInterval(timerInterval); } function resetTimer() { pauseTimer(); timerMinutes = 25; timerSeconds = 0; updateTimerDisplay(); } function updateTimerDisplay() { document.getElementById('timerDisplay').textContent = `${String(timerMinutes).padStart(2, '0')}:${String(timerSeconds).padStart(2, '0')}`; }
function loadSplitPage() { document.getElementById('splitBillDate').value = new Date().toISOString().split('T')[0]; renderSplitHistory(); } function calculateSplitBill(e) { e.preventDefault(); const totalBill = parseFloat(document.getElementById('totalBill').value); const billDate = document.getElementById('splitBillDate').value; const peopleNames = document.getElementById('peopleNames').value.split(',').map(name => name.trim()).filter(name => name); const percentagesStr = document.getElementById('splitPercentages').value; const percentages = percentagesStr ? percentagesStr.split(',').map(p => parseFloat(p.trim())) : []; if (peopleNames.length === 0) { showMessage('Harap masukkan setidaknya satu nama.', 'error'); return; } let results; if (percentages.length > 0) { if (percentages.length !== peopleNames.length) { showMessage('Jumlah nama dan persentase harus sama.', 'error'); return; } const totalPercentage = percentages.reduce((sum, p) => sum + p, 0); if (Math.round(totalPercentage) !== 100) { showMessage(`Total persentase harus 100%, bukan ${totalPercentage}%.`, 'error'); return; } if (percentages.some(isNaN)) { showMessage('Mohon masukkan persentase yang valid.', 'error'); return; } results = peopleNames.map((name, index) => ({ name, amount: (totalBill * percentages[index]) / 100, percentage: percentages[index] })); } else { const amountPerPerson = totalBill / peopleNames.length; results = peopleNames.map(name => ({ name, amount: amountPerPerson })); } const splitBill = { id: generateId(), totalBill, results, date: billDate, type: percentages.length > 0 ? 'custom' : 'equal' }; let appData = storage.getAppData(); appData[currentMode].splitBills.push(splitBill); storage.saveAppData(appData); displaySplitResults(results, totalBill, billDate); renderSplitHistory(); document.getElementById('splitBillForm').reset(); document.getElementById('splitBillDate').value = new Date().toISOString().split('T')[0]; } function displaySplitResults(results, totalBill, date) { const resultDiv = document.getElementById('splitResult'); resultDiv.innerHTML = `<h4 class="font-bold mb-2">Total: ${formatCurrency(totalBill)}</h4>` + results.map(r => `<div class="flex justify-between p-2 border-b border-purple-900/50"><span>${r.name} ${r.percentage ? `(${r.percentage}%)` : ''}</span><strong>${formatCurrency(r.amount)}</strong></div>`).join(''); document.getElementById('splitResultCard').classList.remove('hidden'); document.getElementById('exportSplitBtn').onclick = () => exportSplitBillPDF(results, totalBill, date); } function renderSplitHistory() { const appData = storage.getAppData(); const history = appData[currentMode].splitBills; const container = document.getElementById('splitHistory'); container.innerHTML = [...history].reverse().map(split => `<div class="p-3 rounded-md border border-purple-900/50 hover:bg-purple-500/10"><div class="flex justify-between items-center"><div><strong class="block text-blue-400">${formatCurrency(split.totalBill)}</strong><small class="text-gray-400">${formatDate(split.date)} | ${split.results.length} orang | <span class="font-semibold ${split.type === 'custom' ? 'text-pink-400' : 'text-green-400'}">${split.type === 'custom' ? 'Kustom' : 'Merata'}</span></small></div><button onclick="confirmDeleteSplit('${split.id}')" class="text-red-500 hover:text-red-400"><i class="fas fa-trash"></i></button></div></div>`).join('') || '<p class="text-gray-500 text-center">Tidak ada riwayat.</p>'; } function confirmDeleteSplit(id) { showConfirm('Hapus Riwayat?', 'Yakin ingin menghapus riwayat split bill ini?', () => deleteSplit(id)); } function deleteSplit(id) { let appData = storage.getAppData(); appData[currentMode].splitBills = appData[currentMode].splitBills.filter(s => s.id !== id); storage.saveAppData(appData); renderSplitHistory(); }
function backupData() { const data = storage.get('lifeHubData_v5.5.0'); const notesData = storage.get('notes_v5.5.0', []); const allData = { lifeHub: data, notes: notesData }; if (!data && notesData.length === 0) { showMessage("Tidak ada data untuk di-backup.", "error"); return; } const dataStr = JSON.stringify(allData, null, 2); const blob = new Blob([dataStr], { type: 'text/plain' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `lifehub-backup-${new Date().toISOString().split('T')[0]}.txt`; a.click(); URL.revokeObjectURL(url); showMessage("Backup berhasil!", "success"); } function restoreData() { const file = document.getElementById('restoreFile').files[0]; if (!file) { showMessage("Pilih file untuk restore.", "error"); return; } const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if (data.lifeHub && data.notes) { storage.saveAppData(data.lifeHub); storage.set('notes_v5.5.0', data.notes); initializeApp(); showMessage("Restore berhasil!", "success"); setTimeout(() => window.location.reload(), 1000); } else { throw new Error("Invalid file structure"); } } catch (err) { showMessage("File backup korup atau tidak valid.", "error"); } }; reader.readAsText(file); } 
async function clearAllDataConfirmed() {
    localStorage.removeItem('lifeHubData_v5.5.0');
    localStorage.removeItem('notes_v5.5.0');
    localStorage.removeItem('customBackgroundType');
    
    // Hapus semua file dari IndexedDB
    try {
        const keys = await getAllFileKeysFromDB();
        for (const key of keys) {
            await deleteFileFromDB(key);
        }
    } catch (error) {
        console.error("Gagal membersihkan IndexedDB:", error);
    }

    initializeApp();
    showMessage("Semua data lokal telah dihapus.", "success");
    setTimeout(() => window.location.reload(), 1000);
}


async function applyUploadedMedia() {
    const bgUploadMediaInput = document.getElementById('bg-upload-media');
    const selectedMediaFile = bgUploadMediaInput.files[0];
    if (!selectedMediaFile) {
        showMessage('Silakan pilih file terlebih dahulu!', 'error');
        return;
    }

    // Simpan file sebagai Blob ke IndexedDB
    await saveFileToDB('customBackground', selectedMediaFile);
    // Simpan tipe file ke localStorage untuk referensi
    localStorage.setItem('customBackgroundType', selectedMediaFile.type);

    await initializeApp(); // Muat ulang background dari DB
    showMessage('Latar belakang custom berhasil diterapkan dan disimpan.', 'success');
} 

async function resetBackgroundMedia() { 
    resetBackgrounds(); 
    document.getElementById('bg-upload-media').value = ''; 
    document.body.classList.add('gradient-bg'); 
    await deleteFileFromDB('customBackground');
    localStorage.removeItem('customBackgroundType');
    showMessage('Background direset.', 'info'); 
} 

function resetBackgrounds() { const bgVideo = document.getElementById('bg-video'); const bgImageLayer = document.getElementById('bg-image-layer'); bgVideo.pause(); bgVideo.removeAttribute('src'); bgVideo.style.display = 'none'; bgImageLayer.style.backgroundImage = 'none'; bgImageLayer.style.display = 'none'; } function toggleVideoSound() { const video = document.getElementById('bg-video'); video.muted = !video.muted; let appData = storage.getAppData(); appData.isVideoMuted = video.muted; storage.saveAppData(appData); updateVideoSoundUI(); showMessage(video.muted ? 'Suara video dimatikan.' : 'Suara video diaktifkan.', 'info'); } function updateVideoSoundUI() { const appData = storage.getAppData(); const btn = document.getElementById('toggleVideoSoundBtn'); const icon = btn.querySelector('i'); const text = btn.querySelector('span'); if (appData.isVideoMuted) { icon.classList.remove('fa-volume-up'); icon.classList.add('fa-volume-mute'); text.textContent = 'Aktifkan Suara Video'; } else { icon.classList.remove('fa-volume-mute'); icon.classList.add('fa-volume-up'); text.textContent = 'Matikan Suara Video'; } }

function exportFinancePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const appData = storage.getAppData();
    const transactions = appData[currentMode].transactions;

    doc.setFontSize(20);
    doc.text('Laporan Keuangan', 20, 20);
    doc.setFontSize(12);
    doc.text(`Mode: ${currentMode === 'personal' ? 'Pribadi' : 'Bisnis'}`, 20, 30);
    doc.text(`Tanggal: ${formatDate(new Date().toISOString())}`, 20, 40);

    const tableData = transactions.map(t => [
        formatDate(t.date),
        t.description,
        getCategoryName(t.category),
        t.type === 'income' ? formatCurrency(t.amount) : '',
        t.type === 'expense' ? formatCurrency(t.amount) : ''
    ]);

    doc.autoTable({
        head: [['Tanggal', 'Deskripsi', 'Kategori', 'Pemasukan', 'Pengeluaran']],
        body: tableData,
        startY: 50
    });

    const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
    const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
    const balance = totalIncome - totalExpense;
    let finalY = doc.autoTable.previous.finalY + 10;

    doc.setFontSize(12);
    doc.text('Total Pemasukan:', 20, finalY);
    doc.text(formatCurrency(totalIncome), 190, finalY, { align: 'right' });
    finalY += 7;
    doc.text('Total Pengeluaran:', 20, finalY);
    doc.text(formatCurrency(totalExpense), 190, finalY, { align: 'right' });
    finalY += 7;
    doc.setFont('helvetica', 'bold');
    doc.text('Saldo Akhir:', 20, finalY);
    doc.text(formatCurrency(balance), 190, finalY, { align: 'right' });

    doc.save(`laporan-keuangan-${currentMode}.pdf`);
}

function exportSplitBillPDF(results, totalBill, date) { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.setFontSize(16); doc.text('Laporan Split Bill', 20, 20); doc.setFontSize(12); doc.text(`Total Tagihan: ${formatCurrency(totalBill)}`, 20, 30); doc.text(`Tanggal: ${formatDate(date)}`, 20, 38); const tableData = results.map(r => [r.name, formatCurrency(r.amount)]); doc.autoTable({ head: [['Nama', 'Jumlah Bayar']], body: tableData, startY: 45 }); doc.save('split-bill.pdf'); }

function getChartColors() {
    const isLight = document.body.classList.contains('light-mode');
    const isBlack = document.body.classList.contains('black-mode');

    if (isBlack) {
        return {
            gridColor: 'rgba(255, 255, 255, 0.15)',
            tickColor: '#e5e7eb',
            legendColor: '#e5e7eb',
            incomeColor: '#00f0ff', // Cyan
            expenseColor: '#ff00ff', // Magenta
            taskColor: '#00ff7f', // Spring Green
            incomeBg: 'rgba(0, 240, 255, 0.2)',
            expenseBg: 'rgba(255, 0, 255, 0.2)',
            taskBg: 'rgba(0, 255, 127, 0.7)',
        };
    }

    if (isLight) {
        return { 
            gridColor: 'rgba(0, 0, 0, 0.1)', 
            tickColor: '#4b5563', 
            legendColor: '#1f2937', 
            incomeColor: '#22c55e', 
            expenseColor: '#ec4899', 
            taskColor: '#3b82f6', 
            incomeBg: 'rgba(34, 197, 94, 0.2)', 
            expenseBg: 'rgba(236, 72, 153, 0.2)', 
            taskBg: 'rgba(59, 130, 246, 0.7)', 
        };
    }

    // Default Dark (Purple) Theme
    return { 
        gridColor: 'rgba(255, 255, 255, 0.1)', 
        tickColor: '#d1d5db', 
        legendColor: '#d1d5db', 
        incomeColor: '#4ade80', 
        expenseColor: '#f472b6', 
        taskColor: '#60a5fa', 
        incomeBg: 'rgba(74, 222, 128, 0.2)', 
        expenseBg: 'rgba(244, 114, 182, 0.2)', 
        taskBg: 'rgba(96, 165, 250, 0.7)', 
    };
}

function updateDashboardCharts() { updateCashFlowChart(); updateProductivityChart(); } function updateCashFlowChart() { const ctx = document.getElementById('cashFlowChart')?.getContext('2d'); if (!ctx) return; if (window.cashFlowChartInstance) window.cashFlowChartInstance.destroy(); const colors = getChartColors(); const appData = storage.getAppData(); const transactions = filterDataByRange(appData[currentMode].transactions, masterDateRange, 'date'); const { labels, dataPoints } = getTimeBuckets(masterDateRange, transactions, 'date'); const incomeData = new Array(labels.length).fill(0); const expenseData = new Array(labels.length).fill(0); transactions.forEach(t => { const itemDate = new Date(t.date + 'T00:00:00Z'); let bucketIndex = -1; for (let i = dataPoints.length - 1; i >= 0; i--) { if (itemDate >= dataPoints[i]) { bucketIndex = i; break; } } if (bucketIndex !== -1) { if (t.type === 'income') incomeData[bucketIndex] += t.amount; else expenseData[bucketIndex] += t.amount; } }); window.cashFlowChartInstance = new Chart(ctx, { type: 'line', data: { labels, datasets: [ { label: 'Pemasukan', data: incomeData, borderColor: colors.incomeColor, backgroundColor: colors.incomeBg, tension: 0.3, fill: true }, { label: 'Pengeluaran', data: expenseData, borderColor: colors.expenseColor, backgroundColor: colors.expenseBg, tension: 0.3, fill: true } ] }, options: { responsive: true, scales: { y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { color: colors.tickColor } }, x: { grid: { color: colors.gridColor }, ticks: { color: colors.tickColor } } }, plugins: { legend: { labels: { color: colors.legendColor } } } } }); } function updateProductivityChart() { const ctx = document.getElementById('productivityChart')?.getContext('2d'); if (!ctx) return; if (window.productivityChartInstance) window.productivityChartInstance.destroy(); const colors = getChartColors(); const appData = storage.getAppData(); const tasks = filterDataByRange(appData[currentMode].tasks, masterDateRange, 'datetime'); const { labels, dataPoints } = getTimeBuckets(masterDateRange, tasks, 'datetime'); const completedCounts = new Array(labels.length).fill(0); tasks.filter(t => t.completed && t.datetime).forEach(t => { const itemDate = new Date(t.datetime); let bucketIndex = -1; for (let i = dataPoints.length - 1; i >= 0; i--) { if (itemDate >= dataPoints[i]) { bucketIndex = i; break; } } if (bucketIndex !== -1) completedCounts[bucketIndex]++; }); window.productivityChartInstance = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Tugas Selesai', data: completedCounts, backgroundColor: colors.taskBg, borderColor: colors.taskColor, borderWidth: 1, borderRadius: 5 }] }, options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, color: colors.tickColor }, grid: { color: colors.gridColor } }, x: { ticks: { color: colors.tickColor }, grid: { color: colors.gridColor } } }, plugins: { legend: { labels: { color: colors.legendColor } } } } }); }
function loadAnalysisCharts() { const appData = storage.getAppData(); const modeData = appData[currentMode]; const colors = getChartColors(); const diaryNotes = JSON.parse(localStorage.getItem('notes_v5.5.0') || '[]'); Chart.defaults.color = colors.legendColor; Chart.defaults.font.family = "'Poppins', 'sans-serif'"; const chartIds = ['combinedAnalysisChart', 'incomeVsExpenseChart', 'spendingByCategoryChart', 'taskCompletionTrendChart', 'taskPriorityDistributionChart', 'splitBillByUserChart', 'splitBillFrequencyChart', 'diaryEntryFrequencyChart', 'noteMoodAnalysisChart']; chartIds.forEach(id => { if (window[id + 'Instance']) window[id + 'Instance'].destroy(); }); const filteredPersonalTransactions = filterDataByRange(appData.personal.transactions, masterDateRange, 'date'); const filteredPersonalTasks = filterDataByRange(appData.personal.tasks, masterDateRange, 'datetime'); const filteredPersonalSplits = filterDataByRange(appData.personal.splitBills, masterDateRange, 'date'); const filteredBusinessTransactions = filterDataByRange(appData.business.transactions, masterDateRange, 'date'); const filteredBusinessTasks = filterDataByRange(appData.business.tasks, masterDateRange, 'datetime'); const filteredBusinessSplits = filterDataByRange(appData.business.splitBills, masterDateRange, 'date'); const filteredDiary = filterDataByRange(diaryNotes, masterDateRange, 'date'); const personalData = { finance: filteredPersonalTransactions.length, tasks: filteredPersonalTasks.length, splitBill: filteredPersonalSplits.length, diary: filteredDiary.length, }; const businessData = { finance: filteredBusinessTransactions.length, tasks: filteredBusinessTasks.length, splitBill: filteredBusinessSplits.length, diary: 0, }; const combinedCtx = document.getElementById('combinedAnalysisChart').getContext('2d'); window.combinedAnalysisChartInstance = new Chart(combinedCtx, { type: 'radar', data: { labels: ['Keuangan', 'Tugas', 'Split Bill', 'Catatan'], datasets: [ { label: 'Pribadi', data: [personalData.finance, personalData.tasks, personalData.splitBill, personalData.diary], backgroundColor: 'rgba(0, 136, 255, 0.2)', borderColor: '#0088ff', borderWidth: 2, pointBackgroundColor: '#0088ff', pointRadius: 4, }, { label: 'Bisnis', data: [businessData.finance, businessData.tasks, businessData.splitBill, businessData.diary], backgroundColor: 'rgba(255, 0, 110, 0.2)', borderColor: '#ff006e', borderWidth: 2, pointBackgroundColor: '#ff006e', pointRadius: 4, } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20, font: { size: 14 } } } }, scales: { r: { angleLines: { color: colors.gridColor }, grid: { color: colors.gridColor }, pointLabels: { font: { size: 14, weight: '600' }, color: colors.tickColor }, ticks: { backdropColor: 'rgba(0,0,0,0.5)', color: colors.tickColor, stepSize: 5 }, suggestedMin: 0 } } } }); const filteredFinance = filterDataByRange(modeData.transactions, masterDateRange, 'date'); const financialData = processTimeSeriesData(filteredFinance, 'date', masterDateRange); const incomeVsExpenseCtx = document.getElementById('incomeVsExpenseChart').getContext('2d'); window.incomeVsExpenseChartInstance = new Chart(incomeVsExpenseCtx, { type: 'bar', data: { labels: financialData.labels, datasets: [ { label: 'Pemasukan', data: financialData.income, backgroundColor: colors.incomeColor }, { label: 'Pengeluaran', data: financialData.expense, backgroundColor: colors.expenseColor } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { grid: { color: colors.gridColor } } } } }); const spendingCtx = document.getElementById('spendingByCategoryChart').getContext('2d'); const { labels: categoryLabels, data: spendingData } = processSpendingByCategory(filteredFinance); window.spendingByCategoryChartInstance = new Chart(spendingCtx, { type: 'doughnut', data: { labels: categoryLabels, datasets: [{ data: spendingData, backgroundColor: ['#f472b6', '#60a5fa', '#fbbf24', '#4ade80', '#c084fc', '#a1a1aa', '#f87171', '#818cf8'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); const filteredTasks = filterDataByRange(modeData.tasks, masterDateRange, 'datetime'); const taskData = processTimeSeriesData(filteredTasks, 'datetime', masterDateRange); const taskTrendCtx = document.getElementById('taskCompletionTrendChart').getContext('2d'); window.taskCompletionTrendChartInstance = new Chart(taskTrendCtx, { type: 'line', data: { labels: taskData.labels, datasets: [ { label: 'Dibuat', data: taskData.created, borderColor: '#60a5fa', tension: 0.3 }, { label: 'Selesai', data: taskData.completed, borderColor: '#4ade80', tension: 0.3 } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { stepSize: 1 } } } } }); const taskPriorityCtx = document.getElementById('taskPriorityDistributionChart').getContext('2d'); const { labels: priorityLabels, data: priorityData } = processTaskPriorities(filteredTasks); window.taskPriorityDistributionChartInstance = new Chart(taskPriorityCtx, { type: 'pie', data: { labels: priorityLabels, datasets: [{ data: priorityData, backgroundColor: ['#f472b6', '#fbbf24', '#4ade80'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); const filteredSplits = filterDataByRange(modeData.splitBills, masterDateRange, 'date'); const splitByUserCtx = document.getElementById('splitBillByUserChart').getContext('2d'); const { labels: userLabels, data: userSpendingData } = processSplitBillByUser(filteredSplits); window.splitBillByUserChartInstance = new Chart(splitByUserCtx, { type: 'bar', data: { labels: userLabels, datasets: [{ label: 'Total Pengeluaran', data: userSpendingData, backgroundColor: colors.incomeColor, borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { grid: { color: colors.gridColor } }, y: { grid: { display: false } } }, plugins: { legend: { display: false } } } }); const splitFreqData = processTimeSeriesData(filteredSplits, 'date', masterDateRange); const splitFreqCtx = document.getElementById('splitBillFrequencyChart').getContext('2d'); window.splitBillFrequencyChartInstance = new Chart(splitFreqCtx, { type: 'line', data: { labels: splitFreqData.labels, datasets: [{ label: 'Jumlah Split Bill', data: splitFreqData.count, borderColor: '#22d3ee', tension: 0.3, fill: true, backgroundColor: 'rgba(34, 211, 238, 0.2)' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { stepSize: 1 } } } } }); const diaryCtx = document.getElementById('diaryEntryFrequencyChart').getContext('2d'); const diaryData = processTimeSeriesData(filteredDiary, 'date', masterDateRange); window.diaryEntryFrequencyChartInstance = new Chart(diaryCtx, { type: 'bar', data: { labels: diaryData.labels, datasets: [{ label: 'Jumlah Entri', data: diaryData.count, backgroundColor: colors.taskBg, borderColor: colors.taskColor, borderWidth: 1, borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { stepSize: 1 } } } } }); const moodCtx = document.getElementById('noteMoodAnalysisChart').getContext('2d'); const moodData = processNoteMoods(filteredDiary); window.noteMoodAnalysisChartInstance = new Chart(moodCtx, { type: 'doughnut', data: { labels: moodData.labels, datasets: [{ data: moodData.data, backgroundColor: moodData.backgroundColors, borderColor: colors.gridColor, borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 10 } } } } }); }
function processTimeSeriesData(data, dateKey, range) { const { labels, dataPoints } = getTimeBuckets(range, data, dateKey); const isFinance = data.length > 0 && 'type' in data[0] && 'amount' in data[0]; const isTask = data.length > 0 && 'completed' in data[0]; let results = {}; if (isFinance) { results.income = new Array(labels.length).fill(0); results.expense = new Array(labels.length).fill(0); } else if (isTask) { results.created = new Array(labels.length).fill(0); results.completed = new Array(labels.length).fill(0); } else { results.count = new Array(labels.length).fill(0); } data.forEach(item => { if (!item[dateKey]) return; const itemDate = new Date(item[dateKey]); let bucketIndex = -1; for (let i = dataPoints.length - 1; i >= 0; i--) { if (itemDate >= dataPoints[i]) { bucketIndex = i; break; } } if (bucketIndex !== -1) { if (isFinance) { if (item.type === 'income') results.income[bucketIndex] += item.amount; else results.expense[bucketIndex] += item.amount; } else if (isTask) { results.created[bucketIndex]++; if (item.completed) results.completed[bucketIndex]++; } else { results.count[bucketIndex]++; } } }); return { labels, ...results }; } function processSpendingByCategory(transactions) { const spending = {}; transactions.filter(t => t.type === 'expense').forEach(t => { const categoryName = getCategoryName(t.category); spending[categoryName] = (spending[categoryName] || 0) + t.amount; }); const sortedSpending = Object.entries(spending).sort(([,a],[,b]) => b-a); return { labels: sortedSpending.map(([label]) => label), data: sortedSpending.map(([,data]) => data) }; } function processTaskPriorities(tasks) { const priorities = { high: 0, medium: 0, low: 0 }; tasks.filter(t => !t.completed).forEach(t => { priorities[t.priority]++; }); return { labels: ['Tinggi', 'Sedang', 'Rendah'], data: [priorities.high, priorities.medium, priorities.low] }; } function processSplitBillByUser(splitBills) { const userTotals = {}; splitBills.forEach(bill => { bill.results.forEach(person => { userTotals[person.name] = (userTotals[person.name] || 0) + person.amount; }); }); const sortedUsers = Object.entries(userTotals).sort(([,a],[,b]) => b-a); return { labels: sortedUsers.map(([label]) => label), data: sortedUsers.map(([,data]) => data) }; }
/**
 * [BARU] Fungsi untuk memproses mood dari catatan untuk ditampilkan di grafik.
 * @param {Array} notes - Array objek catatan yang telah difilter.
 * @returns {Object} - Objek berisi labels, data, dan warna untuk grafik.
 */
function processNoteMoods(notes) {
    const moodCounts = {};
    const moodColors = {
        happy: '#4ade80', // Green
        sad: '#60a5fa',   // Blue
        excited: '#facc15', // Yellow
        angry: '#f472b6', // Pink
        neutral: '#9ca3af' // Gray
    };
    const moodLabels = {
        happy: 'Senang',
        sad: 'Sedih',
        excited: 'Bersemangat',
        angry: 'Marah',
        neutral: 'Netral'
    };

    notes.forEach(note => {
        if (note.mood) {
            moodCounts[note.mood] = (moodCounts[note.mood] || 0) + 1;
        }
    });

    const labels = Object.keys(moodCounts).map(mood => moodLabels[mood] || mood);
    const data = Object.values(moodCounts);
    const backgroundColors = Object.keys(moodCounts).map(mood => moodColors[mood] || '#a1a1aa');

    return { labels, data, backgroundColors };
}
function getGroupingUnit(range) { if (typeof range === 'object' && range.type === 'custom') { const diffTime = Math.abs(new Date(range.end) - new Date(range.start)); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); if (diffDays > 90) return 'month'; if (diffDays > 30) return 'week'; return 'day'; } if (['7d', '1m'].includes(range)) return 'day'; if (range === '3m') return 'week'; if (['1y', 'all'].includes(range)) return 'month'; return 'day'; } function getTimeBuckets(range, data, dateKey) { const labels = []; const dataPoints = []; const now = new Date(); const unit = getGroupingUnit(range); let startDate, endDate = new Date(now); if (typeof range === 'object' && range.type === 'custom') { startDate = new Date(range.start + 'T00:00:00Z'); endDate = new Date(range.end + 'T23:59:59Z'); } else if (range === 'all') { const validData = data.filter(d => d[dateKey]); if (validData.length === 0) { startDate = new Date(); startDate.setMonth(startDate.getMonth() - 1); } else { startDate = new Date(validData.reduce((min, p) => (p[dateKey] < min) ? p[dateKey] : min, validData[0][dateKey])); } } else { startDate = new Date(now); if (range === '7d') startDate.setDate(now.getDate() - 6); else if (range === '1m') startDate.setDate(now.getDate() - 29); else if (range === '3m') startDate.setMonth(now.getMonth() - 3); else if (range === '1y') startDate.setFullYear(now.getFullYear() - 1); } startDate.setHours(0, 0, 0, 0); let current = new Date(startDate); while (current <= endDate) { dataPoints.push(new Date(current)); if (unit === 'day') { labels.push(current.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' })); current.setDate(current.getDate() + 1); } else if (unit === 'week') { labels.push(`W${getWeekNumber(current)}`); current.setDate(current.getDate() + 7); } else { labels.push(current.toLocaleDateString('id-ID', { month: 'short', year: '2-digit' })); current.setMonth(current.getMonth() + 1); } } return { labels, dataPoints }; } function getWeekNumber(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7); return weekNo; }
function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); } function formatCurrency(amount) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount); } 
function formatDate(dateString) { return dateString ? new Date(dateString).toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' }) : ''; } 
function formatDateTime(dateString) { return dateString ? new Date(dateString).toLocaleString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : ''; } 

function getTransactionIcon(category) {
    const icons = {
        food: 'fa-utensils', transport: 'fa-car', entertainment: 'fa-gamepad', shopping: 'fa-shopping-bag', bills: 'fa-file-invoice', salary: 'fa-money-bill-wave', business: 'fa-briefcase', investment: 'fa-chart-line', health: 'fa-heart-pulse', education: 'fa-graduation-cap', subscription: 'fa-rss', household: 'fa-house-chimney', personal_care: 'fa-spa', gift: 'fa-gift', other: 'fa-shapes'
    };
    return icons[category] || 'fa-shapes';
}

function getCategoryName(category = null) { const names = { food: 'Makanan & Minuman', transport: 'Transportasi', entertainment: 'Hiburan', shopping: 'Belanja', bills: 'Tagihan & Utilitas', salary: 'Gaji', business: 'Bisnis', investment: 'Investasi', health: 'Kesehatan', education: 'Pendidikan', subscription: 'Langganan', household: 'Rumah Tangga', personal_care: 'Perawatan Diri', gift: 'Hadiah & Donasi', other: 'Lainnya' }; return category ? names[category] : names; }
function showModal(content) { const modal = document.getElementById('mainModal'); modal.querySelector('.modal-content').innerHTML = content; modal.classList.add('show'); modal.querySelectorAll('.closeModal').forEach(btn => btn.addEventListener('click', closeModal)); } function closeModal() { document.querySelectorAll('.modal').forEach(modal => modal.classList.remove('show')); } function showConfirm(title, message, onConfirm) { const modal = document.getElementById('confirmModal'); document.getElementById('confirmTitle').textContent = title; document.getElementById('confirmMessage').textContent = message; modal.classList.add('show'); const yesBtn = document.getElementById('confirmYes'); const noBtn = document.getElementById('confirmNo'); const yesHandler = () => { onConfirm(); closeModal(); cleanup(); }; const noHandler = () => { closeModal(); cleanup(); }; const cleanup = () => { yesBtn.removeEventListener('click', yesHandler); noBtn.removeEventListener('click', noHandler); }; yesBtn.addEventListener('click', yesHandler); noBtn.addEventListener('click', noHandler); } function showMessage(message, type = 'info') { const isLight = document.body.classList.contains('light-mode'); const colors = { info: '#60a5fa', success: '#4ade80', error: '#f472b6' }; const msgDiv = document.createElement('div'); Object.assign(msgDiv.style, { position: 'fixed', bottom: '20px', right: '20px', padding: '15px', backgroundColor: isLight ? '#ffffff' : 'rgba(15, 10, 32, 0.8)', backdropFilter: 'blur(10px)', color: colors[type], border: `1px solid ${colors[type]}`, borderRadius: '8px', boxShadow: `0 4px 15px rgba(0,0,0,0.1)`, zIndex: '9999', transition: 'opacity 0.5s' }); msgDiv.textContent = message; document.body.appendChild(msgDiv); setTimeout(() => { msgDiv.style.opacity = '0'; setTimeout(() => msgDiv.remove(), 500); }, 3000); } 

function showDateRangeModal(source = 'dashboard') { 
    dateRangeSource = source;
    document.getElementById('dateRangeModal').classList.add('show'); 
} 

function applyDateRange() { const startDate = document.getElementById('startDate').value; const endDate = document.getElementById('endDate').value; if (!startDate || !endDate) { showMessage('Harap pilih tanggal mulai dan selesai.', 'error'); return; } if (new Date(startDate) > new Date(endDate)) { showMessage('Tanggal mulai tidak boleh setelah tanggal selesai.', 'error'); return; } const rangeObject = { type: 'custom', start: startDate, end: endDate }; if (dateRangeSource === 'dashboard') { masterDateRange = rangeObject; updateActiveButton('master-range-selector', 'custom'); refreshDashboardData(); } else if (dateRangeSource === 'finance') { financeDateRange = rangeObject; filterAndRenderTransactions(); } document.getElementById('dateRangeModal').classList.remove('show'); } 

function setupMasterRangeSelector() { document.querySelectorAll('#master-range-selector .range-btn').forEach(btn => { btn.addEventListener('click', (e) => { const range = e.currentTarget.dataset.range; if (range === 'custom') { showDateRangeModal('dashboard'); } else { updateActiveButton('master-range-selector', range); masterDateRange = range; refreshDashboardData(); } }); }); } function updateActiveButton(selectorId, activeRange) { document.querySelectorAll(`#${selectorId} .range-btn`).forEach(b => b.classList.remove('active')); document.querySelector(`#${selectorId} .range-btn[data-range="${activeRange}"]`).classList.add('active'); } function filterDataByRange(data, range, dateKey) { if (range === 'all') return data.filter(item => item[dateKey] || item.lastModified); let startDate, endDate = new Date(); if (typeof range === 'object' && range.type === 'custom') { startDate = new Date(range.start + 'T00:00:00Z'); endDate = new Date(range.end + 'T23:59:59Z'); } else { startDate = new Date(); if (range === '7d') startDate.setDate(endDate.getDate() - 6); else if (range === '1m') startDate.setDate(endDate.getDate() - 29); else if (range === '3m') startDate.setMonth(endDate.getMonth() - 3); else if (range === '1y') startDate.setFullYear(endDate.getFullYear() - 1); startDate.setHours(0, 0, 0, 0); } return data.filter(item => { const itemDateStr = item[dateKey] || item.lastModified; if (!itemDateStr) return false; const itemDate = new Date(itemDateStr); return itemDate >= startDate && itemDate <= endDate; }); }
function saveToken(tokenResponse) { const expiresAt = Date.now() + (tokenResponse.expires_in * 1000); const tokenData = { access_token: tokenResponse.access_token, expires_at: expiresAt }; localStorage.setItem('googleAuthToken', JSON.stringify(tokenData)); } function loadToken() { const tokenStr = localStorage.getItem('googleAuthToken'); if (!tokenStr) return null; try { return JSON.parse(tokenStr); } catch (e) { return null; } } function clearToken() { localStorage.removeItem('googleAuthToken'); localStorage.removeItem('googleAuthLoggedIn'); } function initGisClient() { try { if (typeof google === 'undefined' || typeof google.accounts === 'undefined') { console.error("Google Identity Services script not loaded yet."); showMessage("Gagal memuat API Google. Coba refresh halaman.", "error"); return; } googleTokenClient = google.accounts.oauth2.initTokenClient({ client_id: GOOGLE_CLIENT_ID, scope: GOOGLE_SCOPES, callback: (tokenResponse) => { if (tokenResponse && tokenResponse.access_token) { googleAccessToken = tokenResponse.access_token; saveToken(tokenResponse); localStorage.setItem('googleAuthLoggedIn', 'true'); updateSigninStatus(true); } else { console.error("Gagal mendapatkan access token:", tokenResponse); showMessage("Gagal melakukan otentikasi.", "error"); clearToken(); } }, }); const savedToken = loadToken(); if (savedToken) { if (Date.now() < savedToken.expires_at) { googleAccessToken = savedToken.access_token; updateSigninStatus(true); verifyToken(googleAccessToken).then(valid => { if (!valid) { console.warn("Token invalid, refreshing..."); googleTokenClient.requestAccessToken({ prompt: '' }); } }); } else { console.log("Token expired, requesting new one..."); googleTokenClient.requestAccessToken({ prompt: '' }); } } else if (localStorage.getItem('googleAuthLoggedIn') === 'true') { googleTokenClient.requestAccessToken({ prompt: '' }); } } catch (error) { console.error("Google Identity Services client gagal dimuat.", error); showMessage("Gagal memuat API Google. Coba refresh halaman.", "error"); } } function handleAuthClick() { if (googleAccessToken) { google.accounts.oauth2.revoke(googleAccessToken, () => { googleAccessToken = null; clearToken(); updateSigninStatus(false); showMessage("Berhasil keluar dari akun Google.", "success"); }); } else { if (googleTokenClient) { googleTokenClient.requestAccessToken({ prompt: 'consent' }); } else { showMessage("Client otentikasi belum siap.", "error"); } } } async function verifyToken(token) { try { const res = await fetch(`https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=${token}`); return res.ok; } catch (e) { console.error("Verifikasi token gagal:", e); return false; } }

// ===================================================================================
// =================== BAGIAN 3: FUNGSI GOOGLE DRIVE (BACKUP & RESTORE) ==============
// ===================================================================================

/**
 * [BARU] Helper untuk mengubah Data URL menjadi Blob.
 * @param {string} dataUrl - String Data URL.
 * @returns {Blob}
 */
function dataURLtoBlob(dataUrl) {
    const arr = dataUrl.split(',');
    const mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
    }
    return new Blob([u8arr], { type: mime });
}

/**
 * [BARU] Helper untuk mengubah Blob menjadi Data URL.
 * @param {Blob} blob - Data Blob.
 * @returns {Promise<string>}
 */
function blobToDataURL(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}


/**
 * [PERUBAHAN BESAR] Fungsi utama untuk menangani klik tombol backup.
 * Sekarang akan membuat file ZIP terstruktur.
 */
async function handleBackupClick() {
    if (!googleAccessToken) {
        showMessage("Otentikasi diperlukan untuk backup.", "error");
        return;
    }

    showMessage("Memulai proses backup... Mengumpulkan data.", "info");
    const authStatus = document.getElementById('auth-status');
    authStatus.innerText = "Memulai proses backup...";

    try {
        const zip = new JSZip();
        const mediaFolder = zip.folder("catatan_media");
        const bgFolder = zip.folder("backgrounds");

        // 1. Kumpulkan data dasar
        let lifeHubData = storage.getAppData();
        let notesData = JSON.parse(localStorage.getItem('notes_v5.5.0') || '[]');
        let finalNotes = [];
        let finalBackgrounds = [];

        // 2. Proses media dari catatan
        authStatus.innerText = "Memproses media catatan...";
        for (const note of notesData) {
            let newContent = note.content;
            let noteMediaArray = [];
            
            // Regex untuk menemukan semua src Data URL
            const regex = /src="(data:(image|video)\/[^;]+;base64,[^"]+)"/g;
            let match;
            let mediaIndex = 0;

            while ((match = regex.exec(note.content)) !== null) {
                const dataUrl = match[1];
                const mimeType = match[2]; // 'image' or 'video'
                const extension = dataUrl.split('/')[1].split(';')[0];
                
                const filename = `note_${note.id}_media_${mediaIndex}.${extension}`;
                const fileBlob = dataURLtoBlob(dataUrl);

                // Tambahkan file ke ZIP
                mediaFolder.file(filename, fileBlob);

                // Ganti Data URL dengan path relatif di konten
                newContent = newContent.replace(dataUrl, `catatan_media/${filename}`);
                
                // Tambahkan metadata ke array media catatan
                noteMediaArray.push({
                    type: mimeType === 'image' ? 'photo' : 'video',
                    filename: filename
                });
                mediaIndex++;
            }

            finalNotes.push({
                ...note,
                content: newContent,
                media: noteMediaArray
            });
        }

        // 3. Proses media background dari IndexedDB
        authStatus.innerText = "Memproses media background...";
        const bgBlob = await getFileFromDB('customBackground');
        const bgType = localStorage.getItem('customBackgroundType');

        if (bgBlob && bgType) {
            const extension = bgType.split('/')[1];
            const filename = `background_1.${extension}`;
            
            bgFolder.file(filename, bgBlob);
            
            finalBackgrounds.push({
                type: bgType.startsWith('image') ? 'image' : 'video',
                filename: filename
            });
        }

        // 4. Buat file data.json
        const finalJsonData = {
            backupInfo: {
                version: "5.5.1",
                timestamp: new Date().toISOString()
            },
            lifeHubData: lifeHubData,
            notes: finalNotes,
            backgrounds: finalBackgrounds
        };

        zip.file("data.json", JSON.stringify(finalJsonData, null, 2));

        // 5. Generate ZIP dan unggah
        authStatus.innerText = "Membuat file ZIP...";
        const zipBlob = await zip.generateAsync({ type: "blob", compression: "DEFLATE" });
        
        const fileName = `Uranuspace_Backup_${new Date().toISOString().replace(/:/g, '-')}.zip`;
        
        authStatus.innerText = `Mengunggah ${fileName}...`;
        const folderId = await findOrCreateFolder(DRIVE_FOLDER_NAME);
        await createFileInFolder(folderId, fileName, 'application/zip', zipBlob);

        authStatus.innerText = `Backup berhasil! File: ${fileName}`;
        showMessage("Backup ZIP ke Google Drive berhasil!", "success");
        listFiles();

    } catch (error) {
        console.error("Error saat proses backup ZIP:", error);
        authStatus.innerText = "Backup gagal. Lihat konsol untuk detail.";
        showMessage(`Backup gagal: ${error.message}`, "error");
    }
}


/**
 * [PERUBAHAN BESAR] Fungsi untuk menangani restore dari file ZIP.
 */
async function restoreFromZip(fileId) {
    showMessage("Memulai restore... Mengunduh file ZIP.", "info");
    const authStatus = document.getElementById('auth-status');
    authStatus.innerText = "Mengunduh file ZIP...";

    try {
        // 1. Unduh dan muat file ZIP
        const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
            headers: new Headers({ 'Authorization': 'Bearer ' + googleAccessToken })
        });
        if (!response.ok) throw new Error("Gagal mengunduh file ZIP.");
        const zipBlob = await response.blob();
        
        const zip = await JSZip.loadAsync(zipBlob);
        authStatus.innerText = "Membaca data.json...";

        // 2. Baca dan parse data.json
        const jsonDataFile = zip.file("data.json");
        if (!jsonDataFile) throw new Error("File data.json tidak ditemukan di dalam ZIP.");
        const jsonContent = await jsonDataFile.async("string");
        const restoredData = JSON.parse(jsonContent);

        // 3. Tampilkan konfirmasi sebelum menimpa
        showConfirm('Timpa Data Lokal?', 'Data dari backup ZIP akan menimpa data lokal Anda. Operasi ini tidak dapat diurungkan. Lanjutkan?', async () => {
            try {
                showMessage("Memulihkan data... Proses ini mungkin memakan waktu.", "info");
                authStatus.innerText = "Memulihkan data...";

                // Hapus semua media lama dari IndexedDB
                await clearAllDataConfirmed();

                // 4. Pulihkan backgrounds
                if (restoredData.backgrounds && restoredData.backgrounds.length > 0) {
                    authStatus.innerText = "Memulihkan background...";
                    const bgInfo = restoredData.backgrounds[0];
                    const bgFile = zip.file(`backgrounds/${bgInfo.filename}`);
                    if (bgFile) {
                        const bgBlob = await bgFile.async("blob");
                        await saveFileToDB('customBackground', bgBlob);
                        localStorage.setItem('customBackgroundType', bgInfo.type.startsWith('image') ? `image/${bgInfo.filename.split('.').pop()}` : `video/${bgInfo.filename.split('.').pop()}`);
                    }
                }

                // 5. Pulihkan catatan dan media-nya
                let finalNotes = [];
                if (restoredData.notes) {
                    authStatus.innerText = "Memulihkan catatan dan media...";
                    for (const note of restoredData.notes) {
                        let newContent = note.content;
                        if (note.media && note.media.length > 0) {
                            for (const mediaInfo of note.media) {
                                const mediaFile = zip.file(`catatan_media/${mediaInfo.filename}`);
                                if (mediaFile) {
                                    const mediaBlob = await mediaFile.async("blob");
                                    const dataUrl = await blobToDataURL(mediaBlob);
                                    // Ganti path relatif dengan Data URL
                                    newContent = newContent.replace(`catatan_media/${mediaInfo.filename}`, dataUrl);
                                }
                            }
                        }
                        finalNotes.push({ ...note, content: newContent });
                    }
                }

                // 6. Simpan data utama ke localStorage
                if (restoredData.lifeHubData) {
                    storage.saveAppData(restoredData.lifeHubData);
                }
                localStorage.setItem('notes_v5.5.0', JSON.stringify(finalNotes));

                authStatus.innerText = "Restore berhasil! Muat ulang...";
                showMessage("Restore berhasil! Memuat ulang aplikasi...", "success");
                setTimeout(() => window.location.reload(), 1500);

            } catch (restoreError) {
                console.error("Error selama proses apply restore:", restoreError);
                authStatus.innerText = "Gagal menerapkan data restore.";
                showMessage(`Gagal menerapkan data restore: ${restoreError.message}`, "error");
            }
        });

    } catch (error) {
        console.error("Error saat restore dari ZIP:", error);
        authStatus.innerText = "Restore gagal.";
        showMessage(`Restore dari ZIP gagal: ${error.message}`, "error");
    }
}
async function findFolderId(folderName) { const query = `mimeType='application/vnd.google-apps.folder' and name='${folderName}' and trashed=false`; const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id, name)`, { headers: new Headers({ 'Authorization': 'Bearer ' + googleAccessToken }) }); if (!response.ok) throw new Error("Gagal mencari folder."); const data = await response.json(); return data.files.length > 0 ? data.files[0].id : null; } 
async function findOrCreateFolder(folderName) { let folderId = await findFolderId(folderName); if (folderId) return folderId; const fileMetadata = { 'name': folderName, 'mimeType': 'application/vnd.google-apps.folder' }; const response = await fetch('https://www.googleapis.com/drive/v3/files', { method: 'POST', headers: new Headers({ 'Authorization': 'Bearer ' + googleAccessToken, 'Content-Type': 'application/json' }), body: JSON.stringify(fileMetadata) }); if (!response.ok) throw new Error("Gagal membuat folder."); const folder = await response.json(); return folder.id; } 
async function createFileInFolder(folderId, fileName, mimeType, content) { const metadata = { 'name': fileName, 'mimeType': mimeType, 'parents': [folderId] }; const form = new FormData(); form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' })); form.append('file', new Blob([content], { type: mimeType })); const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name', { method: 'POST', headers: new Headers({ 'Authorization': 'Bearer ' + googleAccessToken }), body: form }); if (!response.ok) throw new Error("Gagal mengunggah file."); return await response.json(); } 
async function findLatestBackupFile(folderId) { const query = `'${folderId}' in parents and (mimeType='application/zip' or mimeType='text/plain') and name contains 'Uranuspace_Backup_' and trashed=false`; const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,createdTime,mimeType)&orderBy=createdTime desc&pageSize=1`, { headers: new Headers({ 'Authorization': 'Bearer ' + googleAccessToken }) }); if (!response.ok) throw new Error("Gagal mencari file backup."); const data = await response.json(); return data.files.length > 0 ? data.files[0] : null; } 
async function getFileContent(fileId) { const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, { headers: new Headers({ 'Authorization': 'Bearer ' + googleAccessToken }) }); if (!response.ok) throw new Error("Gagal mengunduh konten file."); return await response.text(); } 
async function listFiles() { if (!googleAccessToken) return; const fileListDiv = document.getElementById('file-list'); fileListDiv.innerHTML = '<p class="text-gray-400">Memuat daftar file...</p>'; try { const folderId = await findFolderId(DRIVE_FOLDER_NAME); if (!folderId) { fileListDiv.innerHTML = '<p class="text-gray-500">Folder backup belum dibuat.</p>'; return; } const query = `'${folderId}' in parents and (mimeType='application/zip' or mimeType='text/plain') and name contains 'Uranuspace_Backup_' and trashed=false`; const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,createdTime,mimeType)&pageSize=5&orderBy=createdTime desc`, { headers: new Headers({ 'Authorization': 'Bearer ' + googleAccessToken }) }); if (!response.ok) throw new Error(`Gagal memuat daftar file: ${response.statusText}`); const data = await response.json(); if (data.files && data.files.length > 0) { fileListDiv.innerHTML = "<strong class='block mb-1 text-purple-300'>Backup Terbaru:</strong>" + data.files.map(file => `<div class="p-1"><i class="fas ${file.mimeType === 'application/zip' ? 'fa-file-archive' : 'fa-file-alt'} mr-2 text-purple-400"></i><span>${file.name.substring(0, 35)}...</span><span class="block text-gray-500 text-xs">${new Date(file.createdTime).toLocaleString('id-ID')}</span></div>`).join(''); } else { fileListDiv.innerHTML = '<p class="text-gray-500">Belum ada file backup di Google Drive.</p>'; } } catch (error) { console.error('Error listing files:', error); fileListDiv.innerHTML = `<p class="text-red-500">Gagal memuat daftar file.</p>`; } }

/**
 * [PERUBAHAN] Mengambil semua file backup, memprioritaskan ZIP.
 */
async function listAllBackupFiles() {
    if (!googleAccessToken) return null;
    try {
        const folderId = await findFolderId(DRIVE_FOLDER_NAME);
        if (!folderId) return [];

        const query = `'${folderId}' in parents and (mimeType='application/zip' or mimeType='text/plain') and name contains 'Uranuspace_Backup_' and trashed=false`;
        const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,createdTime,mimeType)&orderBy=createdTime desc`, {
            headers: new Headers({ 'Authorization': 'Bearer ' + googleAccessToken })
        });

        if (!response.ok) throw new Error(`Gagal memuat daftar file: ${response.statusText}`);
        const data = await response.json();
        return data.files || [];
    } catch (error) {
        console.error('Error listing all files:', error);
        throw error;
    }
}

/**
 * [PERUBAHAN] Menampilkan modal untuk memilih mode restore.
 */
function showRestoreOptionsModal() {
    if (!googleAccessToken) {
        showMessage("Otentikasi diperlukan untuk restore.", "error");
        return;
    }

    const content = `
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-semibold text-purple-300">Pilih Mode Restore</h3>
            <button class="closeModal text-gray-400 hover:text-purple-300"><i class="fas fa-times"></i></button>
        </div>
        <p class="text-gray-400 mb-6">Pilih cara Anda ingin memulihkan data dari Google Drive.</p>
        <div class="space-y-4">
            <button id="autoRestoreBtn" class="custom-button w-full text-left !p-4 flex items-center">
                <i class="fas fa-magic mr-4 text-xl"></i>
                <div>
                    <strong class="block">Restore Otomatis (Cepat)</strong>
                    <span class="text-xs font-normal opacity-80">Pulihkan data dari file cadangan terbaru.</span>
                </div>
            </button>
            <button id="manualRestoreBtn" class="custom-button w-full text-left !p-4 flex items-center" style="background: linear-gradient(90deg, #10b981, #059669);">
                <i class="fas fa-list-ul mr-4 text-xl"></i>
                <div>
                    <strong class="block">Restore Manual (Kontrol Penuh)</strong>
                    <span class="text-xs font-normal opacity-80">Lihat semua file cadangan dan pilih satu untuk dipulihkan.</span>
                </div>
            </button>
        </div>
    `;
    showModal(content);

    document.getElementById('autoRestoreBtn').addEventListener('click', handleAutoRestore);
    document.getElementById('manualRestoreBtn').addEventListener('click', handleManualRestore);
}

/**
 * [PERUBAHAN] Menangani logika restore otomatis, sekarang mendukung ZIP.
 */
async function handleAutoRestore() {
    closeModal();
    const authStatus = document.getElementById('auth-status');
    authStatus.innerText = "Memulai proses restore otomatis...";
    showMessage("Mencari file backup terbaru...", "info");

    try {
        const folderId = await findFolderId(DRIVE_FOLDER_NAME);
        if (!folderId) throw new Error(`Folder '${DRIVE_FOLDER_NAME}' tidak ditemukan.`);

        const latestFile = await findLatestBackupFile(folderId);
        if (!latestFile) throw new Error("Tidak ada file backup yang ditemukan.");

        authStatus.innerText = `File terbaru ditemukan: ${latestFile.name}`;
        showMessage(`Mengunduh ${latestFile.name}...`, "info");

        if (latestFile.mimeType === 'application/zip') {
            await restoreFromZip(latestFile.id);
        } else {
            // Fallback untuk backup TXT lama
            const fileContent = await getFileContent(latestFile.id);
            const restoredData = JSON.parse(fileContent);
            confirmAndApplyRestore(restoredData);
        }

    } catch (error) {
        console.error("Error saat restore otomatis:", error);
        authStatus.innerText = "Restore otomatis gagal.";
        showMessage(`Restore otomatis gagal: ${error.message}`, "error");
    }
}

/**
 * [PERUBAHAN] Menangani logika restore manual, sekarang mendukung ZIP.
 */
async function handleManualRestore() {
    closeModal();
    showMessage("Memuat daftar file dari Google Drive...", "info");

    try {
        const files = await listAllBackupFiles();
        if (!files || files.length === 0) {
            showMessage("Tidak ada file cadangan yang ditemukan di Google Drive.", "error");
            return;
        }

        const fileListHTML = files.map(file => `
            <div class="p-3 rounded-md flex justify-between items-center hover:bg-purple-500/10 cursor-pointer border-b border-purple-500/10" data-file-id="${file.id}" data-mime-type="${file.mimeType}">
                <div>
                    <strong class="block text-purple-300"><i class="fas ${file.mimeType === 'application/zip' ? 'fa-file-archive' : 'fa-file-alt'} mr-2"></i>${file.name}</strong>
                    <p class="text-xs text-gray-400">Dibuat: ${new Date(file.createdTime).toLocaleString('id-ID')}</p>
                </div>
                <i class="fas fa-chevron-right text-gray-500"></i>
            </div>
        `).join('');

        const content = `
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-purple-300">Pilih File untuk Restore</h3>
                <button class="closeModal text-gray-400 hover:text-purple-300"><i class="fas fa-times"></i></button>
            </div>
            <p class="text-sm text-gray-400 mb-4">Klik pada salah satu file di bawah ini untuk memulai proses pemulihan.</p>
            <div class="max-h-96 overflow-y-auto">${fileListHTML}</div>
        `;
        showModal(content);

        document.querySelectorAll('[data-file-id]').forEach(item => {
            item.addEventListener('click', async (e) => {
                const fileId = e.currentTarget.dataset.fileId;
                const mimeType = e.currentTarget.dataset.mimeType;
                closeModal();
                showMessage(`Mengunduh file yang dipilih...`, "info");
                try {
                    if (mimeType === 'application/zip') {
                        await restoreFromZip(fileId);
                    } else {
                        const fileContent = await getFileContent(fileId);
                        const restoredData = JSON.parse(fileContent);
                        confirmAndApplyRestore(restoredData);
                    }
                } catch (error) {
                    showMessage(`Gagal memulihkan dari file yang dipilih: ${error.message}`, "error");
                }
            });
        });

    } catch (error) {
        showMessage(`Gagal memuat daftar file: ${error.message}`, "error");
    }
}

/**
 * [MODIFIKASI] Fungsi konfirmasi untuk restore data TXT lama.
 */
function confirmAndApplyRestore(restoredData) {
    showConfirm('Timpa Data Lokal?', 'Data dari Google Drive akan menimpa data lokal Anda. Operasi ini tidak dapat diurungkan. Lanjutkan?', () => {
        if (restoredData.lifeHubData) {
            storage.saveAppData(restoredData.lifeHubData);
        }
        if (restoredData.notesData) {
            localStorage.setItem('notes_v5.5.0', JSON.stringify(restoredData.notesData));
        }
        showMessage("Restore berhasil! Memuat ulang aplikasi...", "success");
        setTimeout(() => window.location.reload(), 1500);
    });
}


// === [PERUBAHAN UTAMA] Fungsi untuk menampilkan status login, profil, dan avatar dinamis ===
async function updateSigninStatus(isSignedIn) {
    const authButton = document.getElementById('auth-button');
    const backupButton = document.getElementById('backup-button');
    const restoreButton = document.getElementById('restore-button');
    const authStatus = document.getElementById('auth-status');
    const fileListDiv = document.getElementById('file-list');
    const authButtonText = authButton.querySelector('span');
    const userProfileDiv = document.getElementById('user-profile');
    const userEmailEl = document.getElementById('user-email');
    const toggleEmailIcon = document.getElementById('toggle-email-visibility');

    if (isSignedIn && googleAccessToken) {
        authButtonText.innerText = 'Putuskan Hubungan Google';
        authButton.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
        backupButton.disabled = false;
        restoreButton.disabled = false;
        authStatus.innerText = "Terhubung ke Google Drive";
        listFiles();

        try {
            const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                headers: new Headers({ 'Authorization': 'Bearer ' + googleAccessToken })
            });
            if (!response.ok) {
                throw new Error('Gagal mengambil info profil.');
            }
            const profile = await response.json();

            const dynamicSeed = Date.now() + Math.random();
            const avatarUrl = `https://api.dicebear.com/8.x/lorelei/svg?seed=${dynamicSeed}&backgroundColor=transparent&hairColor=6a0dad,0d94ea,c084fc&clothingColor=1e1b4b,3b0764&glassesProbability=50`;

            document.getElementById('user-picture').src = avatarUrl;
            document.getElementById('user-name').textContent = profile.name;
            userEmailEl.textContent = profile.email;
            
            // Atur status awal email menjadi blur
            userEmailEl.classList.add('email-blur');
            toggleEmailIcon.classList.remove('fa-eye-slash');
            toggleEmailIcon.classList.add('fa-eye');

            userProfileDiv.classList.remove('hidden');

        } catch (error) {
            console.error("Error fetching user profile:", error);
            showMessage("Gagal memuat profil pengguna.", "error");
            userProfileDiv.classList.add('hidden');
        }

    } else {
        authButtonText.innerText = 'Hubungkan ke Google';
        authButton.style.background = 'linear-gradient(90deg, #3b82f6, #2563eb)';
        backupButton.disabled = true;
        restoreButton.disabled = true;
        authStatus.innerText = "Belum terhubung.";
        fileListDiv.innerHTML = '';
        userProfileDiv.classList.add('hidden');
    }
}

// === [PERBAIKAN] Fungsi untuk toggle visibilitas email ===
function toggleEmailVisibility() {
    const userEmailEl = document.getElementById('user-email');
    const toggleIcon = document.getElementById('toggle-email-visibility');

    const isNowBlurred = userEmailEl.classList.toggle('email-blur');

    if (isNowBlurred) {
        toggleIcon.classList.remove('fa-eye-slash');
        toggleIcon.classList.add('fa-eye');
        toggleIcon.title = "Tampilkan Email";
    } else {
        toggleIcon.classList.remove('fa-eye');
        toggleIcon.classList.add('fa-eye-slash');
        toggleIcon.title = "Sembunyikan Email";
    }
}


// === [BARU] FUNGSI-FUNGSI UNTUK FITUR PORTAL DI SIDEBAR ===

const defaultPortalIcons = [ { label: "Ikon Universal", icons: [ { value: "fas fa-shopping-cart", text: "Belanja: Keranjang" }, { value: "fas fa-shopping-bag", text: "Belanja: Tas" }, { value: "fas fa-store", text: "Belanja: Toko" }, { value: "fas fa-tags", text: "Belanja: Tag Harga" }, { value: "fas fa-car", text: "Transportasi: Mobil" }, { value: "fas fa-motorcycle", text: "Transportasi: Motor" }, { value: "fas fa-plane-departure", text: "Perjalanan: Pesawat" }, { value: "fas fa-ticket-alt", text: "Perjalanan: Tiket" }, { value: "fas fa-bed", text: "Perjalanan: Akomodasi" }, { value: "fas fa-wallet", text: "Keuangan: Dompet" }, { value: "fas fa-credit-card", text: "Keuangan: Kartu Kredit" }, { value: "fas fa-landmark", text: "Keuangan: Bank" }, { value: "fas fa-coins", text: "Keuangan: Koin" }, { value: "fas fa-utensils", text: "Makanan: Peralatan Makan" }, { value: "fas fa-hamburger", text: "Makanan: Burger" }, { value: "fas fa-feather-alt", text: "Produktivitas: Tulis/Catatan" }, { value: "fas fa-check-double", text: "Produktivitas: Tugas Selesai" }, { value: "fas fa-chart-pie", text: "Produktivitas: Laporan" }, { value: "fas fa-film", text: "Hiburan: Film" }, { value: "fas fa-tv", text: "Hiburan: TV" }, { value: "fas fa-headphones", text: "Hiburan: Musik" }, ] }, { label: "Media Sosial (Logo Resmi)", icons: [ { value: "fab fa-facebook", text: "Facebook" }, { value: "fab fa-instagram", text: "Instagram" }, { value: "fab fa-whatsapp", text: "WhatsApp" }, { value: "fab fa-x-twitter", text: "Twitter / X" }, { value: "fab fa-tiktok", text: "TikTok" }, { value: "fab fa-youtube", text: "YouTube" }, { value: "fab fa-telegram", text: "Telegram" }, { value: "fab fa-discord", text: "Discord" }, { value: "fab fa-linkedin", text: "LinkedIn" }, { value: "fab fa-pinterest", text: "Pinterest" }, { value: "fab fa-reddit", text: "Reddit" }, { value: "fab fa-snapchat", text: "Snapchat" }, { value: "fab fa-threads", text: "Threads" }, { value: "fab fa-line", text: "Line" }, { value: "fab fa-weixin", text: "WeChat" }, { value: "fab fa-tumblr", text: "Tumblr" }, { value: "fab fa-vk", text: "VK" }, { value: "fab fa-quora", text: "Quora" }, { value: "fab fa-medium", text: "Medium" }, { value: "fab fa-blogger", text: "Blogger" }, { value: "fab fa-wordpress", text: "WordPress" }, { value: "fab fa-deviantart", text: "DeviantArt" }, { value: "fab fa-dribbble", text: "Dribbble" }, { value: "fab fa-behance", text: "Behance" }, { value: "fab fa-flickr", text: "Flickr" }, { value: "fab fa-meetup", text: "Meetup" }, { value: "fab fa-mastodon", text: "Mastodon" }, { value: "fab fa-vimeo", text: "Vimeo" }, { value: "fab fa-mix", text: "Mix" }, { value: "fab fa-xing", text: "Xing" }, { value: "fab fa-goodreads", text: "GoodReads" }, ] }, { label: "Produktivitas & Kerja (Logo Resmi)", icons: [ { value: "fab fa-google-drive", text: "Google Drive" }, { value: "fab fa-slack", text: "Slack" }, { value: "fab fa-trello", text: "Trello" }, { value: "fab fa-asana", text: "Asana" }, { value: "fab fa-evernote", text: "Evernote" }, { value: "fab fa-microsoft", text: "Microsoft" }, { value: "fab fa-skype", text: "Skype" }, { value: "fab fa-dropbox", text: "Dropbox" }, { value: "fab fa-confluence", text: "Confluence" }, { value: "fab fa-jira", text: "Jira" }, { value: "fab fa-figma", text: "Figma" }, ] }, { label: "E-commerce & Keuangan (Logo Resmi)", icons: [ { value: "fab fa-amazon", text: "Amazon" }, { value: "fab fa-ebay", text: "eBay" }, { value: "fab fa-alibaba", text: "Alibaba" }, { value: "fab fa-etsy", text: "Etsy" }, { value: "fab fa-paypal", text: "PayPal" }, { value: "fab fa-stripe", text: "Stripe" }, { value: "fab fa-cc-wise", text: "Wise" }, { value: "fab fa-google-pay", text: "Google Pay" }, { value: "fab fa-apple-pay", text: "Apple Pay" }, { value: "fab fa-samsung-pay", text: "Samsung Pay" }, { value: "fab fa-bitcoin", text: "Bitcoin" }, ] }, { label: "Hiburan & Streaming (Logo Resmi)", icons: [ { value: "fab fa-spotify", text: "Spotify" }, { value: "fab fa-soundcloud", text: "SoundCloud" }, { value: "fab fa-apple", text: "Apple" }, { value: "fab fa-deezer", text: "Deezer" }, { value: "fab fa-pandora", text: "Pandora" }, { value: "fab fa-bandcamp", text: "Bandcamp" }, { value: "fab fa-mixcloud", text: "Mixcloud" }, { value: "fab fa-twitch", text: "Twitch" }, { value: "fab fa-steam", text: "Steam" }, ] }, { label: "Teknologi & Tools (Logo Resmi)", icons: [ { value: "fab fa-github", text: "GitHub" }, { value: "fab fa-gitlab", text: "GitLab" }, { value: "fab fa-bitbucket", text: "Bitbucket" }, { value: "fab fa-aws", text: "AWS" }, { value: "fab fa-google", text: "Google" }, { value: "fab fa-digital-ocean", text: "DigitalOcean" }, { value: "fab fa-linode", text: "Linode" }, { value: "fab fa-docker", text: "Docker" }, { value: "fab fa-npm", text: "NPM" }, { value: "fab fa-yarn", text: "Yarn" }, { value: "fab fa-android", text: "Android" }, { value: "fab fa-jenkins", text: "Jenkins" }, ] }, { label: "Utility / Umum (Lanjutan)", icons: [ { value: "fas fa-home", text: "Home" }, { value: "fas fa-user", text: "User / Profile" }, { value: "fas fa-cog", text: "Settings" }, { value: "fas fa-phone", text: "Phone" }, { value: "fas fa-globe", text: "Globe / Website" }, { value: "fas fa-link", text: "Link (Default)" }, { value: "fas fa-envelope", text: "Email" }, { value: "fas fa-camera", text: "Camera" }, { value: "fas fa-image", text: "Gallery / Image" }, { value: "fas fa-file", text: "File" }, { value: "fas fa-folder", text: "Folder" }, { value: "fas fa-search", text: "Search" }, { value: "fas fa-map-marker-alt", text: "Location" }, { value: "fas fa-bookmark", text: "Bookmark" }, { value: "fas fa-star", text: "Star / Favorite" }, { value: "fas fa-heart", text: "Heart / Like" }, { value: "fas fa-bell", text: "Bell / Notification" }, { value: "fas fa-lock", text: "Lock / Private" }, { value: "fas fa-upload", text: "Upload" }, { value: "fas fa-download", text: "Download" }, { value: "fas fa-qrcode", text: "QR Code" }, ] } ];

function showPortalModal() {
    const iconOptionsHTML = defaultPortalIcons.map(group => `
        <optgroup label="--- ${group.label} ---">
            ${group.icons.map(icon => `<option value="${icon.value}">${icon.text}</option>`).join('')}
        </optgroup>
    `).join('');
    const finalIconOptions = iconOptionsHTML + `<optgroup label="--- Kustomisasi ---"><option value="custom-icon">Ikon Kustom (URL/Unggah)</option></optgroup>`;

    const colorOptions = [
        '#ff2a6d', '#05d9e8', '#d300c5', '#00ff9d', '#ffcc00', '#ffffff', '#1DA1F2', '#FF5700'
    ].map((color, index) => `<div class="portal-color-option ${index === 1 ? 'selected' : ''}" style="background-color: ${color};" onclick="selectPortalColor(this)"></div>`).join('');

    const content = `
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl text-purple-300" style="font-family: 'Orbitron', sans-serif;">Buat Portal Baru</h3>
            <button class="closeModal text-gray-400 hover:text-purple-300"><i class="fas fa-times"></i></button>
        </div>
        <form id="portalForm" class="space-y-4">
            <div>
                <label class="block mb-2 portal-modal-label uppercase text-sm tracking-wider">Nama Portal</label>
                <input type="text" id="portal-name" class="custom-input" required>
            </div>
            <div>
                <label class="block mb-2 portal-modal-label uppercase text-sm tracking-wider">URL Tujuan</label>
                <input type="url" id="portal-url" class="custom-input" placeholder="https://" required>
            </div>
            <div>
                <label class="block mb-2 portal-modal-label uppercase text-sm tracking-wider">Ikon</label>
                <select id="portal-icon" class="custom-select">${finalIconOptions}</select>
                <div id="custom-icon-options" class="mt-3 hidden">
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                        <div class="flex-1">
                            <label class="block mb-2 text-xs uppercase tracking-wider">Unggah Ikon</label>
                            <input type="file" id="icon-upload" class="custom-input text-xs p-2" accept="image/*">
                        </div>
                        <div class="flex-1">
                            <label class="block mb-2 text-xs uppercase tracking-wider">atau URL Ikon</label>
                            <input type="url" id="icon-url" class="custom-input" placeholder="https://.../icon.png">
                        </div>
                    </div>
                    <div class="mt-4 text-center">
                       <img id="icon-preview" class="hidden w-16 h-16 object-cover mx-auto rounded-lg border-2 border-dashed p-1" src="#" alt="Icon Preview" style="border-color: var(--input-border);">
                    </div>
                </div>
            </div>
            <div>
                <label class="block mb-2 portal-modal-label uppercase text-sm tracking-wider">Warna Ikon (jika bukan kustom)</label>
                <div class="text-center border rounded-lg p-2" style="border-color: var(--input-border);">
                    ${colorOptions}
                    <input type="color" id="portal-custom-color" class="portal-custom-color-input" value="#05d9e8">
                </div>
                <input type="hidden" id="portal-color" value="#05d9e8">
            </div>
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" class="closeModal custom-button custom-button-danger">Batal</button>
                <button type="submit" class="custom-button">Buat Portal</button>
            </div>
        </form>
    `;
    showModal(content);

    document.getElementById('portalForm').addEventListener('submit', handlePortalFormSubmit);
    document.getElementById('portal-icon').addEventListener('change', toggleCustomIconOptions);
    document.getElementById('icon-upload').addEventListener('change', (e) => handleImageUpload(e, document.getElementById('icon-preview')));
    document.getElementById('portal-custom-color').addEventListener('input', (e) => applyCustomPortalColor(e.target.value));
}

function handlePortalFormSubmit(e) {
    e.preventDefault();
    
    const name = document.getElementById('portal-name').value;
    const url = document.getElementById('portal-url').value;
    let icon = document.getElementById('portal-icon').value;
    const color = document.getElementById('portal-color').value;
    
    if (icon === 'custom-icon') {
        const iconUrlInput = document.getElementById('icon-url');
        const iconPreview = document.getElementById('icon-preview');

        if (iconPreview.src && iconPreview.src !== '#' && iconPreview.src.startsWith('data:image')) {
            addPortalToArray(name, url, iconPreview.src, color);
        } else if (iconUrlInput.value) {
            addPortalToArray(name, url, iconUrlInput.value, color);
        } else {
            showMessage('Harap unggah gambar atau masukkan URL untuk ikon kustom.', 'error');
        }
    } else {
        addPortalToArray(name, url, icon, color);
    }
}

function addPortalToArray(name, url, icon, color) {
    let appData = storage.getAppData();
    const newPortal = { id: generateId(), name, url, icon, color };
    appData[currentMode].portals.push(newPortal);
    storage.saveAppData(appData);
    renderPortals();
    closeModal();
    showMessage('Portal berhasil dibuat!', 'success');
}

function renderPortals() {
    const portalsContainer = document.getElementById('sidebar-portals-container');
    const appData = storage.getAppData();
    const portals = appData[currentMode].portals || [];

    portalsContainer.innerHTML = '';
    if (portals.length === 0) {
        portalsContainer.innerHTML = `<p class="text-sm text-center text-gray-500 px-2 py-4">Belum ada portal.</p>`;
        return;
    }

    portals.forEach(portal => {
        const portalColor = portal.color || 'var(--primary-brand)';
        
        const iconHtml = portal.icon.startsWith('data:image') || portal.icon.startsWith('http')
            ? `<img src="${portal.icon}" alt="${portal.name} icon">`
            : `<i class="${portal.icon}" style="color: ${portalColor};"></i>`;

        const linkElement = document.createElement('a');
        linkElement.href = portal.url;
        linkElement.target = '_blank';
        linkElement.className = 'sidebar-portal-item';
        linkElement.title = portal.name;

        linkElement.innerHTML = `
            <div class="portal-icon">${iconHtml}</div>
            <span class="portal-name">${portal.name}</span>
            <button data-id="${portal.id}" class="delete-portal-btn text-xs">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        portalsContainer.appendChild(linkElement);

        linkElement.querySelector('.delete-portal-btn').addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const portalId = e.currentTarget.dataset.id;
            showConfirm('Hapus Portal?', `Yakin ingin menghapus portal "${portal.name}"?`, () => deletePortal(portalId));
        });
    });
}

function deletePortal(portalId) {
    let appData = storage.getAppData();
    appData[currentMode].portals = appData[currentMode].portals.filter(p => p.id !== portalId);
    storage.saveAppData(appData);
    renderPortals();
    showMessage('Portal dihapus.', 'success');
}


// --- Helper Functions untuk Modal Portal ---
function toggleCustomIconOptions() {
    const portalIconSelect = document.getElementById('portal-icon');
    const customIconOptions = document.getElementById('custom-icon-options');
    customIconOptions.classList.toggle('hidden', portalIconSelect.value !== 'custom-icon');
}

function handleImageUpload(event, previewElement) {
    const file = event.target.files[0];
    if (file) {
        document.getElementById('icon-url').value = ''; 
        const reader = new FileReader();
        reader.onload = (e) => {
            previewElement.src = e.target.result;
            previewElement.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }
}

function selectPortalColor(element) {
    const container = element.closest('.text-center');
    container.querySelectorAll('.portal-color-option').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
    const colorValue = element.style.backgroundColor;
    document.getElementById('portal-color').value = colorValue;
    document.getElementById('portal-custom-color').value = rgbToHex(colorValue);
}

function applyCustomPortalColor(color) {
    document.getElementById('portal-color').value = color;
    document.querySelectorAll('.portal-color-option').forEach(el => el.classList.remove('selected'));
}

function rgbToHex(rgb) {
    if (rgb.startsWith('#')) return rgb;
    let sep = rgb.indexOf(",") > -1 ? "," : " ";
    rgb = rgb.substr(4).split(")")[0].split(sep);
    let r = (+rgb[0]).toString(16),
        g = (+rgb[1]).toString(16),
        b = (+rgb[2]).toString(16);
    if (r.length == 1) r = "0" + r;
    if (g.length == 1) g = "0" + g;
    if (b.length == 1) b = "0" + b;
    return "#" + r + g + b;
}
// === AKHIR DARI FUNGSI-FUNGSI PORTAL ===


// ===================================================================================
// =================== BAGIAN 4: FUNGSI EKSPOR PDF & GAMBAR BARU =====================
// ===================================================================================

/**
 * [MODIFIKASI] Fungsi inti untuk mengekspor semua data ke PDF.
 * Kini dapat mengembalikan Blob untuk diproses lebih lanjut atau langsung mengunduh.
 * @param {string} timeRange - Rentang waktu yang dipilih ('all', 'last7days', dll.).
 * @param {string|null} customStartDate - Tanggal mulai kustom.
 * @param {string|null} customEndDate - Tanggal selesai kustom.
 * @param {string} outputType - 'download' (default) atau 'blob'.
 * @returns {Promise<Blob|void>} Mengembalikan Blob jika outputType adalah 'blob'.
 */
async function exportAllToPdf(timeRange = 'all', customStartDate = null, customEndDate = null, outputType = 'download') {
    if (outputType === 'download') {
        showMessage('Memulai pembuatan laporan PDF komprehensif...', 'info');
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: 'p',
        unit: 'mm',
        format: [210, 330] // Ukuran F4
    });

    const bgMediaBlob = await getFileFromDB('customBackground');
    const bgType = localStorage.getItem('customBackgroundType');
    let customBgDataUrl = null;
    if (bgMediaBlob && bgType && bgType.startsWith('image/')) {
        customBgDataUrl = await blobToDataURL(bgMediaBlob);
    }

    let startDate, endDate;
    const now = new Date();
    const endOfToday = new Date(now.getTime());
    endOfToday.setHours(23, 59, 59, 999);
    let dateRangeLabel = "Selamanya";

    switch (timeRange) {
        case 'last7days': startDate = new Date(); startDate.setDate(now.getDate() - 7); startDate.setHours(0, 0, 0, 0); endDate = endOfToday; dateRangeLabel = "7 Hari Terakhir"; break;
        case 'last1month': startDate = new Date(); startDate.setMonth(now.getMonth() - 1); startDate.setHours(0, 0, 0, 0); endDate = endOfToday; dateRangeLabel = "1 Bulan Terakhir"; break;
        case 'last3months': startDate = new Date(); startDate.setMonth(now.getMonth() - 3); startDate.setHours(0, 0, 0, 0); endDate = endOfToday; dateRangeLabel = "3 Bulan Terakhir"; break;
        case 'last1year': startDate = new Date(); startDate.setFullYear(now.getFullYear() - 1); startDate.setHours(0, 0, 0, 0); endDate = endOfToday; dateRangeLabel = "1 Tahun Terakhir"; break;
        case 'custom':
            startDate = customStartDate ? new Date(customStartDate) : null;
            if (startDate) startDate.setHours(0, 0, 0, 0);
            endDate = customEndDate ? new Date(customEndDate) : null;
            if (endDate) endDate.setHours(23, 59, 59, 999);
            if (!startDate || !endDate || startDate > endDate) { showMessage('Rentang tanggal kustom tidak valid.', 'error'); return; }
            dateRangeLabel = `${formatDate(startDate.toISOString())} - ${formatDate(endDate.toISOString())}`;
            break;
        case 'all':
        default: startDate = null; endDate = null; break;
    }

    const isLight = document.body.classList.contains('light-mode');
    const isBlack = document.body.classList.contains('black-mode');
    let pdfTheme;
    if (isLight) { pdfTheme = { bgColor: '#FFFFFF', textColor: '#1f2937', headerColor: '#9333ea', subtleTextColor: '#6b7280', lineColor: '#e5e7eb', tableHeaderBg: '#f3e8ff' }; } 
    else if (isBlack) { pdfTheme = { bgColor: '#111827', textColor: '#FFFFFF', headerColor: '#00f0ff', subtleTextColor: '#9ca3af', lineColor: '#4b5563', tableHeaderBg: '#1f2937' }; } 
    else { pdfTheme = { bgColor: '#1A1033', textColor: '#FFFFFF', headerColor: '#c084fc', subtleTextColor: '#9ca3af', lineColor: '#4A148C', tableHeaderBg: '#2E0B4D' }; }
    
    const margin = 15;
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    let yPos = margin;

    const addBackground = () => {
        if (customBgDataUrl) {
            try {
                const imageType = bgType.split('/')[1].toUpperCase();
                doc.addImage(customBgDataUrl, imageType, 0, 0, pageWidth, pageHeight, '', 'FAST');
            } catch (e) {
                console.error("Gagal menambahkan gambar latar belakang kustom ke PDF:", e);
                doc.setFillColor(pdfTheme.bgColor);
                doc.rect(0, 0, pageWidth, pageHeight, 'F');
            }
        } else {
            doc.setFillColor(pdfTheme.bgColor);
            doc.rect(0, 0, pageWidth, pageHeight, 'F');
        }
    };

    const addHeader = (pageTitle) => { doc.setFontSize(10); doc.setTextColor(pdfTheme.headerColor); doc.text('Laporan Lengkap Uranuspace', margin, margin); doc.text(pageTitle, pageWidth / 2, margin, { align: 'center' }); doc.text(new Date().toLocaleDateString('id-ID'), pageWidth - margin, margin, { align: 'right' }); doc.setDrawColor(pdfTheme.lineColor); doc.line(margin, margin + 5, pageWidth - margin, margin + 5); yPos = margin + 15; };
    const addSectionTitle = (title, size = 16) => { if (checkPageEnd(size / 2 + 10)) { addHeader('Lanjutan...'); } doc.setFontSize(size); doc.setTextColor(pdfTheme.headerColor); doc.text(title, margin, yPos); yPos += (size / 2) + 5; };
    const addPageTitle = (title) => { doc.setFontSize(22); doc.setTextColor(pdfTheme.textColor); doc.text(title, margin, yPos); yPos += 15; };
    const checkPageEnd = (neededHeight = 20) => { if (yPos + neededHeight > pageHeight - margin) { doc.addPage(); addBackground(); yPos = margin; return true; } return false; };
    const addChartToPdf = async (canvasId) => {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return null;
        const chartInstance = window[canvasId + 'Instance'];
        if (!chartInstance) return canvas.toDataURL('image/png', 1.0);
        return canvas.toDataURL('image/png', 1.0);
    };

    addBackground();

    // Halaman 1: Ringkasan Dashboard
    addHeader('Ringkasan Dashboard');
    addPageTitle('Ringkasan Eksekutif');
    
    const appData = storage.getAppData();
    const modeData = appData[currentMode];

    const filterByDate = (item) => {
        if (!startDate || !endDate) return true;
        const itemDateStr = item.date || item.datetime || item.lastModified;
        if (!itemDateStr) return false;
        const itemDate = new Date(itemDateStr);
        return itemDate >= startDate && itemDate <= endDate;
    };

    const filteredTransactions = modeData.transactions.filter(filterByDate);
    const filteredTasks = modeData.tasks.filter(filterByDate);
    const filteredSplitBills = modeData.splitBills.filter(filterByDate);
    const allNotes = storage.get('notes_v5.5.0', []);
    const filteredNotes = allNotes.filter(note => !note.isLocked && filterByDate(note));

    const balance = filteredTransactions.reduce((sum, t) => sum + (t.type === 'income' ? t.amount : -t.amount), 0);
    const todayStr = new Date().toISOString().split('T')[0];
    const todayTasks = modeData.tasks.filter(p => p.datetime && p.datetime.startsWith(todayStr) && !p.completed).length;
    const pendingTasks = filteredTasks.filter(t => !t.completed).length;

    doc.setFontSize(12);
    doc.setTextColor(pdfTheme.textColor);
    doc.text(`Mode Aktif: ${currentMode === 'personal' ? 'Pribadi' : 'Bisnis'}`, margin, yPos); yPos += 8;
    doc.text(`Rentang Waktu Laporan: ${dateRangeLabel}`, margin, yPos); yPos += 8;
    doc.text(`Saldo Total (Selama Periode): ${formatCurrency(balance)}`, margin, yPos); yPos += 8;
    doc.text(`Tugas Hari Ini (Total): ${todayTasks} tugas`, margin, yPos); yPos += 8;
    doc.text(`Tugas Tertunda (Selama Periode): ${pendingTasks} tugas`, margin, yPos); yPos += 15;

    addSectionTitle('Visualisasi Data Dashboard');
    doc.setFontSize(10);
    doc.setTextColor(pdfTheme.subtleTextColor);
    const warningText = doc.splitTextToSize('PENTING: Grafik di bawah ini diambil dari tampilan dashboard saat ini. Pastikan Anda telah memilih rentang waktu yang sama di filter dashboard sebelum mengekspor agar visualisasi data sesuai dengan data tabel dalam laporan ini.', pageWidth - (margin * 2));
    doc.text(warningText, margin, yPos);
    yPos += (warningText.length * 4) + 10;
    
    const chartWidth = (pageWidth - (margin * 3)) / 2;
    const chartHeight = chartWidth * 0.75;

    if (checkPageEnd(chartHeight + 10)) { addHeader('Ringkasan Dashboard'); }
    let chartX = margin;
    
    let cashFlowImg = await addChartToPdf('cashFlowChart');
    if(cashFlowImg) doc.addImage(cashFlowImg, 'PNG', chartX, yPos, chartWidth, chartHeight);
    chartX += chartWidth + margin;

    let productivityImg = await addChartToPdf('productivityChart');
    if(productivityImg) doc.addImage(productivityImg, 'PNG', chartX, yPos, chartWidth, chartHeight);
    yPos += chartHeight + 10;

    if (checkPageEnd(chartHeight + 10)) { addHeader('Ringkasan Dashboard'); }
    addSectionTitle('Analisis Gabungan');
    
    let combinedImg = await addChartToPdf('combinedAnalysisChart');
    const combinedHeight = (pageWidth - margin*2) * 0.7;
    if(combinedImg) doc.addImage(combinedImg, 'PNG', margin, yPos, pageWidth - margin*2, combinedHeight);
    yPos += combinedHeight + 10;

    // Halaman 2: Analisis Grafik Mendalam
    doc.addPage(); addBackground(); addHeader('Analisis Mendalam'); addPageTitle('Detail Analisis Grafik');
    chartX = margin;
    addSectionTitle('Analisis Keuangan');
    let incomeVsExpenseImg = await addChartToPdf('incomeVsExpenseChart');
    if(incomeVsExpenseImg) doc.addImage(incomeVsExpenseImg, 'PNG', chartX, yPos, chartWidth, chartHeight);
    chartX += chartWidth + margin;
    let spendingByCategoryImg = await addChartToPdf('spendingByCategoryChart');
    if(spendingByCategoryImg) doc.addImage(spendingByCategoryImg, 'PNG', chartX, yPos, chartWidth, chartHeight);
    yPos += chartHeight + 15;
    chartX = margin;

    if (checkPageEnd(chartHeight + 20)) { addHeader('Analisis Mendalam'); }
    addSectionTitle('Analisis Produktivitas');
    let taskCompletionTrendImg = await addChartToPdf('taskCompletionTrendChart');
    if(taskCompletionTrendImg) doc.addImage(taskCompletionTrendImg, 'PNG', chartX, yPos, chartWidth, chartHeight);
    chartX += chartWidth + margin;
    let taskPriorityDistributionImg = await addChartToPdf('taskPriorityDistributionChart');
    if(taskPriorityDistributionImg) doc.addImage(taskPriorityDistributionImg, 'PNG', chartX, yPos, chartWidth, chartHeight);
    yPos += chartHeight + 15;
    chartX = margin;

    if (checkPageEnd(chartHeight + 20)) { addHeader('Analisis Mendalam'); }
    addSectionTitle('Analisis Split Bill');
    let splitBillByUserImg = await addChartToPdf('splitBillByUserChart');
    if(splitBillByUserImg) doc.addImage(splitBillByUserImg, 'PNG', chartX, yPos, chartWidth, chartHeight);
    chartX += chartWidth + margin;
    let splitBillFrequencyImg = await addChartToPdf('splitBillFrequencyChart');
    if(splitBillFrequencyImg) doc.addImage(splitBillFrequencyImg, 'PNG', chartX, yPos, chartWidth, chartHeight);
    yPos += chartHeight + 15;
    chartX = margin;

    // [PERUBAHAN] Menambahkan dua grafik catatan berdampingan ke PDF
    if (checkPageEnd(chartHeight + 20)) { addHeader('Analisis Mendalam'); }
    addSectionTitle('Analisis Catatan');
    let diaryEntryFrequencyImg = await addChartToPdf('diaryEntryFrequencyChart');
    if(diaryEntryFrequencyImg) doc.addImage(diaryEntryFrequencyImg, 'PNG', chartX, yPos, chartWidth, chartHeight);
    chartX += chartWidth + margin;
    let noteMoodAnalysisImg = await addChartToPdf('noteMoodAnalysisChart');
    if(noteMoodAnalysisImg) doc.addImage(noteMoodAnalysisImg, 'PNG', chartX, yPos, chartWidth, chartHeight);
    yPos += chartHeight + 10;


    // Halaman 3: Keuangan
    doc.addPage(); addBackground(); addHeader('Keuangan'); addPageTitle('Laporan Keuangan');
    if (filteredTransactions.length > 0) {
        const head = [['Tanggal', 'Deskripsi', 'Kategori', 'Pemasukan', 'Pengeluaran']];
        const body = filteredTransactions.map(t => [formatDate(t.date), t.description, getCategoryName(t.category), t.type === 'income' ? formatCurrency(t.amount) : '', t.type === 'expense' ? formatCurrency(t.amount) : '']);
        doc.autoTable({ head, body, startY: yPos, theme: 'grid', headStyles: { fillColor: pdfTheme.tableHeaderBg, textColor: pdfTheme.textColor }, styles: { textColor: pdfTheme.textColor, cellPadding: 2, fontSize: 9, fillColor: pdfTheme.bgColor }, alternateRowStyles: { fillColor: isLight ? '#fafafa' : isBlack ? '#374151' : '#2E0B4D' } });
        yPos = doc.autoTable.previous.finalY;
        
        const totalIncome = filteredTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
        const totalExpense = filteredTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
        const netResult = totalIncome - totalExpense;

        if (checkPageEnd(40)) { 
            addHeader('Keuangan'); 
        }

        yPos += 15;
        addSectionTitle('Ringkasan Keuangan', 14);

        doc.setFontSize(11);
        doc.setTextColor(pdfTheme.textColor);
        
        const summaryX = margin + 5;
        const valueX = pageWidth - margin - 5;

        doc.text('Total Pemasukan:', summaryX, yPos);
        doc.text(formatCurrency(totalIncome), valueX, yPos, { align: 'right' });
        yPos += 8;

        doc.text('Total Pengeluaran:', summaryX, yPos);
        doc.text(formatCurrency(totalExpense), valueX, yPos, { align: 'right' });
        yPos += 8;

        doc.setDrawColor(pdfTheme.lineColor);
        doc.line(summaryX, yPos, valueX, yPos);
        yPos += 8;

        doc.setFont('helvetica', 'bold');
        doc.text(netResult >= 0 ? 'Laba Bersih:' : 'Rugi Bersih:', summaryX, yPos);
        doc.text(formatCurrency(netResult), valueX, yPos, { align: 'right' });
        doc.setFont('helvetica', 'normal');

    } else { 
        doc.setTextColor(pdfTheme.textColor); 
        doc.text('Tidak ada data transaksi pada rentang waktu yang dipilih.', margin, yPos); 
    }

    // Halaman 4: Rencana & Tugas
    doc.addPage(); addBackground(); addHeader('Manajemen Waktu'); addPageTitle('Daftar Tugas');
    const activeTasks = filteredTasks.filter(t => !t.completed);
    const completedTasks = filteredTasks.filter(t => t.completed);
    if (activeTasks.length > 0) {
        addSectionTitle('Tugas Aktif', 14);
        doc.autoTable({ head: [['Tugas', 'Waktu', 'Prioritas']], body: activeTasks.map(t => [t.title, formatDateTime(t.datetime), t.priority]), startY: yPos, theme: 'grid', headStyles: { fillColor: pdfTheme.tableHeaderBg, textColor: pdfTheme.textColor }, styles: { textColor: pdfTheme.textColor, cellPadding: 2, fontSize: 9, fillColor: pdfTheme.bgColor }, alternateRowStyles: { fillColor: isLight ? '#fafafa' : isBlack ? '#374151' : '#2E0B4D' } });
        yPos = doc.autoTable.previous.finalY + 15;
    } else { doc.setTextColor(pdfTheme.textColor); doc.text('Tidak ada tugas aktif pada rentang waktu yang dipilih.', margin, yPos); yPos += 15; }
    if (completedTasks.length > 0) {
        if(checkPageEnd(30)) { addHeader('Manajemen Waktu'); }
        addSectionTitle('Tugas Selesai', 14);
        doc.autoTable({ head: [['Tugas', 'Waktu', 'Prioritas']], body: completedTasks.map(t => [t.title, formatDateTime(t.datetime), t.priority]), startY: yPos, theme: 'grid', headStyles: { fillColor: pdfTheme.tableHeaderBg, textColor: pdfTheme.textColor }, styles: { textColor: pdfTheme.textColor, cellPadding: 2, fontSize: 9, fillColor: pdfTheme.bgColor }, alternateRowStyles: { fillColor: isLight ? '#fafafa' : isBlack ? '#374151' : '#2E0B4D' } });
    }

    // Halaman 5: Split Bill
    doc.addPage(); addBackground(); addHeader('Split Bill'); addPageTitle('Riwayat Split Bill');
    if (filteredSplitBills.length > 0) {
        filteredSplitBills.forEach(bill => {
            if (checkPageEnd(40)) { addHeader('Split Bill'); }
            doc.setFontSize(12); doc.setTextColor(pdfTheme.textColor); doc.text(`Tanggal: ${formatDate(bill.date)} - Total: ${formatCurrency(bill.totalBill)}`, margin, yPos); yPos += 8;
            doc.autoTable({ head: [['Nama', 'Jumlah Bayar']], body: bill.results.map(r => [r.name, formatCurrency(r.amount)]), startY: yPos, theme: 'striped', headStyles: { fillColor: pdfTheme.tableHeaderBg, textColor: pdfTheme.textColor }, styles: { textColor: pdfTheme.textColor, cellPadding: 2, fontSize: 9, fillColor: pdfTheme.bgColor }, alternateRowStyles: { fillColor: isLight ? '#fafafa' : isBlack ? '#374151' : '#2E0B4D' } });
            yPos = doc.autoTable.previous.finalY + 10;
            doc.setDrawColor(pdfTheme.lineColor); doc.line(margin, yPos, pageWidth - margin, yPos); yPos += 5;
        });
    } else { doc.setTextColor(pdfTheme.textColor); doc.text('Tidak ada riwayat split bill pada rentang waktu yang dipilih.', margin, yPos); }

    // Halaman 6: Catatan
    doc.addPage(); addBackground(); addHeader('Catatan'); addPageTitle('Daftar Catatan');
    if (filteredNotes.length > 0) {
        filteredNotes.forEach(note => {
            if (checkPageEnd(30)) { addHeader('Catatan'); }
            doc.setFontSize(14); doc.setTextColor(pdfTheme.headerColor); doc.text(note.title || 'Tanpa Judul', margin, yPos); yPos += 6;
            doc.setFontSize(9); doc.setTextColor(pdfTheme.subtleTextColor); doc.text(`Tanggal: ${formatDate(note.lastModified)} | Mood: ${note.mood}`, margin, yPos); yPos += 8;
            doc.setFontSize(11); doc.setTextColor(pdfTheme.textColor);
            const tempDiv = document.createElement('div'); tempDiv.innerHTML = note.content;
            const contentText = tempDiv.innerText || tempDiv.textContent || '';
            const splitText = doc.splitTextToSize(contentText, pageWidth - (margin * 2));
            doc.text(splitText, margin, yPos);
            yPos += (splitText.length * 4) + 10;
            doc.setDrawColor(pdfTheme.lineColor); doc.line(margin, yPos, pageWidth - margin, yPos); yPos += 5;
        });
    } else { doc.setTextColor(pdfTheme.textColor); doc.text('Tidak ada catatan pada rentang waktu yang dipilih.', margin, yPos); }

    // [MODIFIKASI] Bagian akhir fungsi
    if (outputType === 'blob') {
        return doc.output('blob');
    } else {
        // Simpan PDF
        const fileName = `Laporan_Uranuspace_${dateRangeLabel.replace(/ /g, '_')}.pdf`;
        doc.save(fileName);
        showMessage('Laporan PDF berhasil dibuat dan diunduh!', 'success');
    }
}

/**
 * [BARU] Fungsi untuk mengekspor laporan sebagai serangkaian gambar 4K dalam file ZIP.
 * @param {string} timeRange - Rentang waktu yang dipilih.
 * @param {string|null} customStartDate - Tanggal mulai kustom.
 * @param {string|null} customEndDate - Tanggal selesai kustom.
 */
async function exportAllToImages(timeRange = 'all', customStartDate = null, customEndDate = null) {
    const exportPdfBtn = document.getElementById('export-pdf-btn');
    const exportImagesBtn = document.getElementById('export-images-btn');
    
    // Nonaktifkan tombol selama proses
    exportPdfBtn.disabled = true;
    exportImagesBtn.disabled = true;

    try {
        showMessage('Memulai ekspor gambar... Menyiapkan PDF di memori.', 'info');

        // 1. Hasilkan PDF di memori sebagai Blob
        const pdfBlob = await exportAllToPdf(timeRange, customStartDate, customEndDate, 'blob');
        if (!pdfBlob) {
            throw new Error("Gagal menghasilkan data PDF di memori.");
        }

        showMessage('PDF berhasil dibuat. Merender halaman menjadi gambar...', 'info');

        // 2. Inisialisasi PDF.js dan JSZip
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
        const zip = new JSZip();

        const pdfData = await pdfBlob.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
        const numPages = pdf.numPages;

        // 3. Loop melalui setiap halaman untuk merendernya
        for (let i = 1; i <= numPages; i++) {
            showMessage(`Memproses halaman ${i} dari ${numPages}...`, 'info');
            const page = await pdf.getPage(i);
            
            // Tentukan skala untuk resolusi 4K (lebar 3840px)
            const viewport = page.getViewport({ scale: 1 });
            const scale = 3840 / viewport.width;
            const scaledViewport = page.getViewport({ scale: scale });

            // Buat canvas dinamis
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = scaledViewport.width;
            canvas.height = scaledViewport.height;

            // Render halaman ke canvas
            const renderContext = {
                canvasContext: context,
                viewport: scaledViewport
            };
            await page.render(renderContext).promise;

            // 4. Konversi canvas ke Blob gambar dan tambahkan ke ZIP
            const imageBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png', 1.0));
            zip.file(`Halaman_${i}.png`, imageBlob);
        }

        // 5. Hasilkan file ZIP dan picu unduhan
        showMessage('Semua halaman diproses. Membuat file ZIP...', 'success');
        const zipBlob = await zip.generateAsync({ type: "blob" });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(zipBlob);
        const dateRangeLabel = timeRange === 'custom' ? `${customStartDate}_to_${customEndDate}` : timeRange;
        link.download = `Laporan_Gambar_Uranuspace_${dateRangeLabel}.zip`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);

        showMessage('File ZIP berhasil dibuat dan diunduh!', 'success');

    } catch (error) {
        console.error("Gagal mengekspor gambar:", error);
        showMessage(`Terjadi kesalahan saat mengekspor gambar: ${error.message}`, 'error');
    } finally {
        // Aktifkan kembali tombol
        exportPdfBtn.disabled = false;
        exportImagesBtn.disabled = false;
    }
}

</script>
</body>
</html>
