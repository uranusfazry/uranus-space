<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeHub v3 - Management Terminal</title>
    
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Memuat Font Awesome untuk ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Memuat Chart.js untuk grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Memuat jsPDF & AutoTable untuk ekspor PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <!-- Gaya Kustom -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        :root {
            --bg-gradient: linear-gradient(135deg, #0F0A20, #1A1033, #2E0B4D, #4A148C);
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --card-bg: rgba(15, 10, 32, 0.4);
            --card-border: rgba(255, 255, 255, 0.05);
            --sidebar-bg: rgba(26, 16, 51, 0.8);
            --sidebar-border: rgba(192, 132, 252, 0.1);
            --input-bg: rgba(15, 10, 32, 0.5);
            --input-border: rgba(192, 132, 252, 0.2);
            --input-focus-border: #c084fc;
            --active-nav-bg: rgba(192, 132, 252, 0.2);
            --active-nav-border: #c084fc;
            --hover-nav-bg: rgba(192, 132, 252, 0.1);
            --hover-nav-border: #a855f7;
            --primary-brand: #c084fc;
        }

        body.light-mode {
            --bg-gradient: linear-gradient(135deg, #f3e8ff, #faf5ff, #f5f3ff);
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --card-bg: rgba(255, 255, 255, 0.8);
            --card-border: rgba(0, 0, 0, 0.1);
            --sidebar-bg: #ffffff;
            --sidebar-border: #e5e7eb;
            --input-bg: #f9fafb;
            --input-border: #d1d5db;
            --input-focus-border: #9333ea;
            --active-nav-bg: rgba(147, 51, 234, 0.1);
            --active-nav-border: #9333ea;
            --hover-nav-bg: rgba(147, 51, 234, 0.05);
            --hover-nav-border: #a855f7;
            --primary-brand: #9333ea;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-primary);
            transition: background 0.5s, color 0.5s;
            overflow-x: hidden; /* Mencegah scroll horizontal */
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .gradient-bg {
            background-size: 400% 400%;
            animation: gradientFlow 15s ease infinite;
        }
        body.light-mode .gradient-bg {
            animation: none;
        }
        
        .glass-effect {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 12px;
            border: 1px solid var(--card-border);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        body.light-mode .glass-effect {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .glass-effect:hover {
            border-color: rgba(192, 132, 252, 0.2);
        }

        .custom-input {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            width: 100%;
            transition: all 0.3s ease;
        }
        .custom-input:focus {
            outline: none;
            border-color: var(--input-focus-border);
            box-shadow: 0 0 10px var(--input-focus-border, 0.3);
        }
        .custom-input::placeholder {
            color: var(--text-secondary);
        }

        .custom-button {
            background: linear-gradient(90deg, #9333ea, #7e22ce);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(147, 51, 234, 0.3);
        }
        .custom-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(147, 51, 234, 0.5);
        }
        .custom-button-danger {
            background: linear-gradient(90deg, #ef4444, #dc2626);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        .custom-button-danger:hover {
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
        }

        .nav-item {
            transition: all 0.3s ease; 
            cursor: pointer; 
            padding: 0.75rem 1rem;
            margin: 0.25rem 0; 
            border-radius: 0.5rem; 
            border-left: 3px solid transparent;
        }
        .nav-item:hover { 
            background-color: var(--hover-nav-bg); 
            border-left-color: var(--hover-nav-border); 
        }
        .nav-item.active { 
            background-color: var(--active-nav-bg); 
            border-left-color: var(--active-nav-border); 
            color: var(--primary-brand); 
            font-weight: 500;
        }
        body.light-mode .nav-item.active {
            color: var(--primary-brand);
        }

        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.7); 
            backdrop-filter: blur(5px);
            z-index: 1000; 
            animation: fadeIn 0.3s ease; 
        }
        .modal.show { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .modal-content {
            max-width: 90vw; 
            max-height: 90vh; 
            overflow-y: auto; 
            animation: modalAppear 0.5s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modalAppear { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        
        .income { border-left: 4px solid #4ade80; }
        .expense { border-left: 4px solid #f472b6; }
        
        .task-item.completed { opacity: 0.6; text-decoration: line-through; }

        .hidden { display: none !important; }

        /* --- PERBAIKAN LAYOUT --- */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            height: 100vh; 
            overflow-y: auto; 
            position: fixed; 
            left: -250px; 
            top: 0; 
            width: 250px;
            background-color: var(--sidebar-bg);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--sidebar-border); 
            z-index: 100; 
            transition: left 0.3s ease, opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .sidebar.open { left: 0; }
        
        .overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.5); 
            z-index: 99; 
        }
        .overlay.show { display: block; }
        
        .main-content { 
            flex-grow: 1; /* Konten utama mengisi sisa ruang */
            width: 100%;
            transition: margin-left 0.3s ease; 
        }
        
        .main-content > .p-6 {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        
        /* Layout untuk Desktop (md dan lebih besar) */
        @media (min-width: 768px) { 
            .sidebar { 
                position: relative; /* Kembali ke alur normal dokumen */
                left: 0; 
                flex-shrink: 0; /* Mencegah sidebar menyusut */
            }
            .main-content {
                width: calc(100% - 250px);
            }
            #mobileMenuBtn, .overlay {
                display: none;
            }
        }
        
        /* Layout untuk Mobile (di bawah md) */
        @media (max-width: 767px) {
            .app-container {
                display: block;
            }
        }
        /* --- AKHIR PERBAIKAN LAYOUT --- */

        #bg-video, #bg-image-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -2;
            display: none;
        }
        #bg-image-layer {
            background-size: cover;
            background-position: center;
        }

        #mobileMenuBtn {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }

        /* Gaya untuk mode pratinjau transparan */
        body.preview-mode .sidebar,
        body.preview-mode .main-content > .p-6,
        body.preview-mode #mobileMenuBtn {
            opacity: 0;
            transform: translateY(15px);
            pointer-events: none;
        }

        /* Gaya untuk tombol rentang waktu chart */
        .range-btn {
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }
        .range-btn:hover {
            background-color: var(--hover-nav-bg);
            color: var(--text-primary);
        }
        .range-btn.active {
            background-color: var(--primary-brand);
            color: white;
            box-shadow: 0 2px 10px rgba(192, 132, 252, 0.4);
        }
        body.light-mode .range-btn.active {
            color: white;
        }

        /* Gaya untuk wadah chart baru */
        .chart-container {
            height: 350px;
            position: relative;
        }
    </style>
</head>
<body class="gradient-bg">
    <!-- Elemen untuk background media -->
    <div id="bg-image-layer"></div>
    <video autoplay loop muted id="bg-video"></video>

    <!-- Mobile Menu Button -->
    <button id="mobileMenuBtn" class="fixed top-4 left-4 z-50 custom-button">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Overlay for mobile -->
    <div id="overlay" class="overlay"></div>

    <div class="app-container">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar">
            <div class="p-6">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center space-x-3">
                        <div id="logo-icon" class="w-10 h-10 bg-gradient-to-br from-purple-700 to-purple-900 rounded-full flex items-center justify-center cursor-pointer" title="Masuk Mode Pratinjau">
                            <i class="fas fa-rocket text-lg text-purple-200"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-purple-300">Uranus Space</h1>
                    </div>
                    <button id="themeToggle" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-purple-500/10 text-purple-300" title="Toggle Theme">
                        <i class="fas fa-sun"></i>
                    </button>
                </div>
                
                <div class="mb-6">
                    <label for="modeSelect" class="block text-sm font-medium mb-2 text-purple-300">Mode Terminal</label>
                    <select id="modeSelect" class="custom-input">
                        <option value="personal">Pribadi</option>
                        <option value="business">Bisnis</option>
                    </select>
                </div>
                
                <nav>
                    <div class="nav-item active" data-section="dashboard"><i class="fas fa-tachometer-alt mr-3 w-5"></i>Dashboard</div>
                    <div class="nav-item" data-section="finance"><i class="fas fa-wallet mr-3 w-5"></i>Keuangan</div>
                    <div class="nav-item" data-section="tasks"><i class="fas fa-tasks mr-3 w-5"></i>Rencana & Tugas</div>
                    <div class="nav-item" data-section="split"><i class="fas fa-receipt mr-3 w-5"></i>Split Bill</div>
                    <div class="nav-item" data-section="diary"><i class="fas fa-book mr-3 w-5"></i>My Diary Elite</div>
                    <div class="nav-item" data-section="settings"><i class="fas fa-cog mr-3 w-5"></i>Pengaturan</div>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="p-6 relative z-10">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="section">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h2 class="text-3xl font-bold text-purple-300">Dashboard</h2>
                        <div id="master-range-selector" class="flex items-center gap-1 bg-purple-900/30 p-1 rounded-md glass-effect">
                            <button data-range="7d" class="range-btn active" title="7 Hari">7H</button>
                            <button data-range="1m" class="range-btn" title="1 Bulan">1B</button>
                            <button data-range="3m" class="range-btn" title="3 Bulan">3B</button>
                            <button data-range="1y" class="range-btn" title="1 Tahun">1T</button>
                            <button data-range="all" class="range-btn" title="Selamanya">âˆž</button>
                            <button data-range="custom" class="range-btn" title="Pilih Rentang"><i class="fas fa-calendar-alt"></i></button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold mb-2 text-pink-400">Saldo Total</h3><p class="text-2xl font-bold" id="totalBalance">Rp 0</p></div>
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold mb-2 text-pink-400">Tugas Hari Ini</h3><p class="text-2xl font-bold" id="todayTasksCount">0</p></div>
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold mb-2 text-pink-400">Tugas Tertunda</h3><p class="text-2xl font-bold" id="pendingTasks">0</p></div>
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold mb-2 text-pink-400">Mode Aktif</h3><p class="text-2xl font-bold" id="activeMode">Pribadi</p></div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold text-blue-400 mb-4">Arus Kas</h3>
                            <canvas id="cashFlowChart"></canvas>
                        </div>
                        <div class="glass-effect p-6">
                             <h3 class="text-xl font-semibold text-pink-400 mb-4">Produktivitas</h3>
                            <canvas id="productivityChart"></canvas>
                        </div>
                    </div>

                    <div class="glass-effect p-6 mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-blue-400">Aktivitas Terkini</h3>
                        <div id="recentActivities" class="space-y-2"></div>
                    </div>

                    <h2 class="text-3xl font-bold mb-6 mt-10 text-purple-300">Analisis Mendalam</h2>
                    <div class="grid grid-cols-1 gap-6">
                        <!-- Analisis Gabungan -->
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold mb-4 text-purple-400">Analisis Gabungan Fitur</h3>
                            <div class="chart-container" style="height: 450px;">
                                <canvas id="combinedAnalysisChart"></canvas>
                            </div>
                        </div>

                        <!-- Analisis Keuangan -->
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold mb-4 text-blue-400">Analisis Keuangan</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-2">
                                    <p class="text-md font-medium text-purple-300 mb-2">Pemasukan vs Pengeluaran</p>
                                    <div class="chart-container h-64">
                                        <canvas id="incomeVsExpenseChart"></canvas>
                                    </div>
                                </div>
                                <div>
                                     <p class="text-md font-medium text-purple-300 mb-2">Alokasi Pengeluaran</p>
                                    <div class="chart-container h-64">
                                        <canvas id="spendingByCategoryChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Analisis Produktivitas -->
                        <div class="glass-effect p-6">
                             <h3 class="text-xl font-semibold mb-4 text-pink-400">Analisis Produktivitas</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-2">
                                    <p class="text-md font-medium text-purple-300 mb-2">Tren Penyelesaian Tugas</p>
                                    <div class="chart-container h-64">
                                        <canvas id="taskCompletionTrendChart"></canvas>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-md font-medium text-purple-300 mb-2">Distribusi Prioritas Tugas</p>
                                    <div class="chart-container h-64">
                                        <canvas id="taskPriorityDistributionChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Analisis Split Bill -->
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold mb-4 text-green-400">Analisis Split Bill</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <p class="text-md font-medium text-purple-300 mb-2">Total Pengeluaran per Orang</p>
                                    <div class="chart-container h-64">
                                        <canvas id="splitBillByUserChart"></canvas>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-md font-medium text-purple-300 mb-2">Frekuensi Split Bill</p>
                                    <div class="chart-container h-64">
                                        <canvas id="splitBillFrequencyChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Analisis Diary -->
                        <div class="glass-effect p-6">
                             <h3 class="text-xl font-semibold mb-4 text-blue-400">Analisis Diary</h3>
                             <p class="text-md font-medium text-purple-300 mb-2">Frekuensi Entri Diary</p>
                             <div class="chart-container h-72">
                                <canvas id="diaryEntryFrequencyChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Finance Section -->
                <div id="finance-section" class="section hidden">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h2 class="text-3xl font-bold text-purple-300">Manajemen Keuangan</h2>
                        <div class="flex gap-2">
                            <button id="addTransactionBtn" class="custom-button"><i class="fas fa-plus mr-2"></i>Tambah</button>
                            <button id="exportFinanceBtn" class="custom-button custom-button-danger"><i class="fas fa-download mr-2"></i>Export PDF</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold text-green-400 mb-2">Pemasukan</h3><p class="text-2xl font-bold" id="totalIncome">Rp 0</p></div>
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold text-pink-400 mb-2">Pengeluaran</h3><p class="text-2xl font-bold" id="totalExpense">Rp 0</p></div>
                        <div class="glass-effect p-6 text-center"><h3 class="text-lg font-semibold text-blue-400 mb-2">Saldo</h3><p class="text-2xl font-bold" id="balance">Rp 0</p></div>
                    </div>

                    <div class="glass-effect p-4 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center">
                            <input type="text" id="searchTransaction" placeholder="Cari transaksi..." class="custom-input">
                            <select id="categoryFilter" class="custom-input"></select>
                            <select id="typeFilter" class="custom-input"></select>
                            <button id="financeDateFilterBtn" class="custom-button"><i class="fas fa-calendar-alt mr-2"></i>Filter Tanggal</button>
                        </div>
                    </div>

                    <div class="glass-effect p-6">
                        <h3 class="text-xl font-semibold mb-4 text-pink-400">Daftar Transaksi</h3>
                        <div id="transactionsList" class="space-y-2"></div>
                    </div>
                </div>
                
                <!-- Tasks & Plans Section -->
                <div id="tasks-section" class="section hidden">
                    <h2 class="text-3xl font-bold mb-6 text-purple-300">Rencana & Tugas</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left Column: Add Task & Pomodoro -->
                        <div class="lg:col-span-1 space-y-6">
                            <div class="glass-effect p-6">
                                <h3 class="text-xl font-semibold mb-4 text-blue-400">Tambah Tugas</h3>
                                <form id="taskForm" class="space-y-4">
                                    <div><label class="block text-sm font-medium mb-1">Tugas</label><input type="text" id="taskTitle" class="custom-input" required></div>
                                    <div><label class="block text-sm font-medium mb-1">Tanggal & Waktu</label><input type="datetime-local" id="taskDateTime" class="custom-input" required></div>
                                    <div><label class="block text-sm font-medium mb-1">Prioritas</label><select id="taskPriority" class="custom-input"><option value="low">Rendah</option><option value="medium">Sedang</option><option value="high">Tinggi</option></select></div>
                                    <button type="submit" class="custom-button w-full">Tambah Tugas</button>
                                </form>
                            </div>
                            <div class="glass-effect p-6 text-center">
                                <h3 class="text-xl font-semibold mb-4 text-pink-400">Pomodoro Timer</h3>
                                <div id="timerDisplay" class="text-5xl font-mono my-4">25:00</div>
                                <div class="flex gap-2 justify-center">
                                    <button id="startTimerBtn" class="custom-button bg-green-600 hover:bg-green-500"><i class="fas fa-play"></i></button>
                                    <button id="pauseTimerBtn" class="custom-button bg-yellow-600 hover:bg-yellow-500"><i class="fas fa-pause"></i></button>
                                    <button id="resetTimerBtn" class="custom-button custom-button-danger"><i class="fas fa-sync"></i></button>
                                </div>
                            </div>
                        </div>
                        <!-- Right Column: Task List & Calendar -->
                        <div class="lg:col-span-2 space-y-6">
                            <div class="glass-effect p-6">
                                 <h3 class="text-xl font-semibold mb-4 text-blue-400">Daftar Tugas</h3>
                                 <div id="taskList" class="space-y-3 max-h-96 overflow-y-auto"></div>
                            </div>
                            <div class="glass-effect p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <button id="prevMonth" class="custom-button !p-3"><i class="fas fa-chevron-left"></i></button>
                                    <span id="currentMonth" class="text-xl font-semibold text-pink-400"></span>
                                    <button id="nextMonth" class="custom-button !p-3"><i class="fas fa-chevron-right"></i></button>
                                </div>
                                <div id="calendar" class="grid grid-cols-7 gap-1"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="market-section" class="section hidden"></div>

                <!-- Split Bill Section -->
                <div id="split-section" class="section hidden">
                    <h2 class="text-3xl font-bold mb-6 text-purple-300">Split Bill</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <div class="glass-effect p-6 mb-6">
                                <h3 class="text-xl font-semibold mb-4 text-blue-400">Kalkulator Bill</h3>
                                <form id="splitBillForm" class="space-y-4">
                                    <div><label class="block text-sm font-medium mb-1">Total Tagihan</label><input type="number" id="totalBill" class="custom-input" required></div>
                                    <div><label class="block text-sm font-medium mb-1">Nama (pisahkan koma)</label><input type="text" id="peopleNames" class="custom-input" placeholder="Zedd, Jett, Omen" required></div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Persentase (opsional, pisahkan koma)</label>
                                        <input type="text" id="splitPercentages" class="custom-input" placeholder="25, 75">
                                        <p class="text-xs text-gray-400 mt-1">Kosongkan untuk membagi rata.</p>
                                    </div>
                                    <button type="submit" class="custom-button w-full">Hitung</button>
                                </form>
                            </div>
                            <div id="splitResultCard" class="glass-effect p-6 hidden">
                                <h3 class="text-xl font-semibold mb-4 text-pink-400">Hasil Pembagian</h3>
                                <div id="splitResult"></div>
                                <button id="exportSplitBtn" class="custom-button custom-button-danger w-full mt-4">Export PDF</button>
                            </div>
                        </div>
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold mb-4 text-blue-400">Riwayat Split Bill</h3>
                            <div id="splitHistory" class="space-y-3 max-h-[600px] overflow-y-auto"></div>
                        </div>
                    </div>
                </div>

                <!-- Diary Section -->
                <div id="diary-section" class="section hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-purple-300">My Diary Elite</h2>
                        <div class="flex gap-2">
                            <button id="newEntryBtn" class="custom-button"><i class="fas fa-plus mr-2"></i>Entri Baru</button>
                            <button id="exportDiaryBtn" class="custom-button custom-button-danger"><i class="fas fa-download mr-2"></i>Export PDF</button>
                        </div>
                    </div>
                    <div class="glass-effect p-4 mb-6">
                        <input type="text" id="searchDiary" placeholder="Cari catatan..." class="custom-input">
                    </div>
                    <div id="diaryEntries" class="space-y-4"></div>
                </div>

                <!-- Settings Section -->
                <div id="settings-section" class="section hidden">
                    <h2 class="text-3xl font-bold mb-6 text-purple-300">Pengaturan</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="glass-effect p-6">
                            <h3 class="text-xl font-semibold mb-4 text-blue-400">Backup & Restore</h3>
                            <div class="space-y-4">
                                <button id="backupData" class="custom-button w-full"><i class="fas fa-download mr-2"></i>Backup Data (.txt)</button>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Restore Data (.txt)</label>
                                    <input type="file" id="restoreFile" accept=".txt" class="custom-input">
                                    <button id="restoreData" class="custom-button custom-button-danger w-full mt-2"><i class="fas fa-upload mr-2"></i>Restore Data</button>
                                </div>
                                <button id="clearAllData" class="custom-button custom-button-danger w-full"><i class="fas fa-trash mr-2"></i>Hapus Semua Data</button>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <div class="glass-effect p-6">
                                <h3 class="text-xl font-semibold mb-4 text-pink-400">Ubah Latar Belakang</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label for="bg-upload-media" class="block text-sm font-medium mb-2">Pilih File (Gambar/Video)</label>
                                        <input type="file" id="bg-upload-media" class="custom-input" accept="image/*,video/*">
                                    </div>
                                    <button id="applyBgMediaBtn" class="custom-button w-full">Terapkan Latar Belakang</button>
                                    <button id="resetBgMediaBtn" class="custom-button custom-button-danger w-full">Reset Latar Belakang</button>
                                    <button id="toggleVideoSoundBtn" class="custom-button w-full" style="background: linear-gradient(90deg, #3b82f6, #2563eb);">
                                        <i class="fas fa-volume-mute mr-2"></i> <span>Aktifkan Suara Video</span>
                                    </button>
                                </div>
                            </div>
                            <div class="glass-effect p-6">
                                <h3 class="text-xl font-semibold mb-4 text-pink-400">Informasi Aplikasi</h3>
                                <div class="space-y-2 text-sm">
                                    <p><strong>Nama:</strong> LifeHub v3</p>
                                    <p><strong>Versi:</strong> 3.15.0-splitbill-percentage</p>
                                    <p><strong>Fitur:</strong> Split Bill Persentase, Prioritas Warna Kalender, Filter Dasbor Utama, Analisis Gabungan & Individual, Keuangan, Tugas, Pomodoro, Diary, Custom BG, Preview Mode</p>
                                    <p><strong>Storage:</strong> LocalStorage (Data terenkripsi di terminal Anda)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="mainModal" class="modal"><div class="modal-content glass-effect p-8 w-full max-w-2xl"></div></div>
    <div id="confirmModal" class="modal">
        <div class="modal-content glass-effect p-8 w-full max-w-sm text-center">
            <h3 id="confirmTitle" class="text-xl font-semibold mb-4 text-pink-400">Konfirmasi</h3>
            <p id="confirmMessage" class="mb-6">Apakah Anda yakin?</p>
            <div class="flex gap-4">
                <button id="confirmYes" class="custom-button flex-1">Ya</button>
                <button id="confirmNo" class="custom-button custom-button-danger flex-1">Tidak</button>
            </div>
        </div>
    </div>
    <div id="dateRangeModal" class="modal">
        <div class="modal-content glass-effect p-8 w-full max-w-md">
            <h3 class="text-xl font-semibold mb-6 text-purple-400">Pilih Rentang Tanggal</h3>
            <div class="space-y-4">
                <div>
                    <label for="startDate" class="block text-sm font-medium mb-1">Tanggal Mulai</label>
                    <input type="date" id="startDate" class="custom-input">
                </div>
                <div>
                    <label for="endDate" class="block text-sm font-medium mb-1">Tanggal Selesai</label>
                    <input type="date" id="endDate" class="custom-input">
                </div>
            </div>
            <div class="flex gap-4 mt-8">
                <button id="applyDateRange" class="custom-button flex-1">Terapkan</button>
                <button id="cancelDateRange" class="custom-button custom-button-danger flex-1">Batal</button>
            </div>
        </div>
    </div>


    <script>
        // --- GLOBAL VARIABLES & STATE MANAGEMENT ---
        let currentSection = 'dashboard';
        let currentDate = new Date();
        let currentMode = 'personal';
        let timerInterval;
        let timerMinutes = 25;
        let timerSeconds = 0;
        let isTimerRunning = false;
        let touchStartX = 0;
        let touchEndX = 0;
        let isDragging = false;
        
        // State untuk rentang waktu
        let masterDateRange = '7d';

        let customDateRange = { start: null, end: null };
        
        // --- DATA STORAGE ---
        const storage = {
            get: (key, defaultValue = null) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch {
                    return defaultValue;
                }
            },
            set: (key, value) => {
                localStorage.setItem(key, JSON.stringify(value));
            },
            getAppData: () => {
                return storage.get('lifeHubData_v3', {
                    currentMode: 'personal',
                    isLightMode: false,
                    isVideoMuted: true,
                    personal: { transactions: [], tasks: [], splitBills: [], diaryEntries: [] },
                    business: { transactions: [], tasks: [], splitBills: [], diaryEntries: [] }
                });
            },
            saveAppData: (data) => {
                storage.set('lifeHubData_v3', data);
            }
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
        });

        function initializeApp() {
            const appData = storage.getAppData();
            currentMode = appData.currentMode || 'personal';
            document.getElementById('modeSelect').value = currentMode;
            
            if (appData.isLightMode) {
                document.body.classList.add('light-mode');
            }
            updateThemeUI(appData.isLightMode);

            document.getElementById('bg-video').muted = appData.isVideoMuted;
            updateVideoSoundUI();
            
            switchSection('dashboard');
        }

        function setupEventListeners() {
            // Navigation & Theme
            document.querySelectorAll('.nav-item').forEach(item => item.addEventListener('click', () => switchSection(item.dataset.section)));
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
            document.getElementById('overlay').addEventListener('click', closeMobileMenu);
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('modeSelect').addEventListener('change', switchMode);
            document.getElementById('logo-icon').addEventListener('click', enterPreviewMode);

            // Finance
            document.getElementById('addTransactionBtn').addEventListener('click', () => showTransactionModal());
            document.getElementById('exportFinanceBtn').addEventListener('click', exportFinancePDF);
            document.getElementById('searchTransaction').addEventListener('input', filterAndRenderTransactions);
            document.getElementById('categoryFilter').addEventListener('change', filterAndRenderTransactions);
            document.getElementById('typeFilter').addEventListener('change', filterAndRenderTransactions);
            document.getElementById('financeDateFilterBtn').addEventListener('click', () => showDateRangeModal('finance'));

            // Tasks & Plans
            document.getElementById('taskForm').addEventListener('submit', saveTask);
            document.getElementById('startTimerBtn').addEventListener('click', startTimer);
            document.getElementById('pauseTimerBtn').addEventListener('click', pauseTimer);
            document.getElementById('resetTimerBtn').addEventListener('click', resetTimer);
            document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
            document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));

            // Split Bill
            document.getElementById('splitBillForm').addEventListener('submit', calculateSplitBill);

            // Diary
            document.getElementById('newEntryBtn').addEventListener('click', () => showDiaryModal());
            document.getElementById('searchDiary').addEventListener('input', renderDiary);
            document.getElementById('exportDiaryBtn').addEventListener('click', exportDiaryPDF);

            // Settings
            document.getElementById('backupData').addEventListener('click', backupData);
            document.getElementById('restoreData').addEventListener('click', restoreData);
            document.getElementById('clearAllData').addEventListener('click', () => {
                showConfirm('Hapus Semua Data?', 'Operasi ini tidak dapat diurungkan. Anda yakin ingin menghapus semua data personal dan bisnis?', clearAllDataConfirmed);
            });
            
            // Background Media Uploader
            document.getElementById('applyBgMediaBtn').addEventListener('click', applyUploadedMedia);
            document.getElementById('resetBgMediaBtn').addEventListener('click', resetBackgroundMedia);
            document.getElementById('toggleVideoSoundBtn').addEventListener('click', toggleVideoSound);

            // Swipe/Drag Listeners
            document.body.addEventListener('touchstart', handleTouchStart, { passive: true });
            document.body.addEventListener('touchend', handleTouchEnd);
            document.body.addEventListener('mousedown', handleMouseDown);
            document.body.addEventListener('mouseup', handleMouseUp);
            
            // Setup untuk Master Filter
            setupMasterRangeSelector();

            // Event listeners untuk modal rentang tanggal
            document.getElementById('applyDateRange').addEventListener('click', applyDateRange);
            document.getElementById('cancelDateRange').addEventListener('click', () => document.getElementById('dateRangeModal').classList.remove('show'));
        }

        // --- PREVIEW MODE LOGIC ---
        function enterPreviewMode() { document.body.classList.add('preview-mode'); }
        function handleGestureEnd() {
            const swipeThreshold = 70;
            const deltaX = touchEndX - touchStartX;
            if (document.querySelector('.modal.show')) return;
            if (deltaX < -swipeThreshold) {
                document.body.classList.remove('preview-mode');
            }
        }
        function handleTouchStart(e) { touchStartX = e.changedTouches[0].screenX; }
        function handleTouchEnd(e) { touchEndX = e.changedTouches[0].screenX; handleGestureEnd(); }
        function handleMouseDown(e) {
            if (e.button !== 0 || e.target.closest('button, input, select, textarea, a, .modal')) return;
            isDragging = true;
            touchStartX = e.screenX;
        }
        function handleMouseUp(e) {
            if (!isDragging) return;
            isDragging = false;
            touchEndX = e.screenX;
            handleGestureEnd();
        }

        // --- UI, THEME & NAVIGATION ---
        function switchSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(section + '-section').classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`[data-section="${section}"]`).classList.add('active');
            currentSection = section;

            switch(section) {
                case 'dashboard': loadDashboard(); break;
                case 'finance': loadFinancePage(); break;
                case 'tasks': loadTasksPage(); break;
                case 'split': loadSplitPage(); break;
                case 'diary': renderDiary(); break;
            }
            closeMobileMenu();
        }
        
        function switchMode(e) {
            currentMode = e.target.value;
            let appData = storage.getAppData();
            appData.currentMode = currentMode;
            storage.saveAppData(appData);
            switchSection(currentSection);
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            let appData = storage.getAppData();
            appData.isLightMode = isLight;
            storage.saveAppData(appData);
            updateThemeUI(isLight);
        }

        function updateThemeUI(isLight) {
            const icon = document.querySelector('#themeToggle i');
            icon.classList.toggle('fa-sun', !isLight);
            icon.classList.toggle('fa-moon', isLight);
            
            if (currentSection === 'dashboard') {
                refreshDashboardData();
            }
        }

        function toggleMobileMenu() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('overlay').classList.toggle('show'); }
        function closeMobileMenu() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('overlay').classList.remove('show'); }

        // --- DASHBOARD ---
        function loadDashboard() {
            const appData = storage.getAppData();
            const modeData = appData[currentMode];
            
            const balance = modeData.transactions.reduce((sum, t) => sum + (t.type === 'income' ? t.amount : -t.amount), 0);
            const today = new Date().toISOString().split('T')[0];
            const todayTasks = modeData.tasks.filter(p => p.datetime && p.datetime.startsWith(today) && !p.completed).length;
            const pendingTasks = modeData.tasks.filter(t => !t.completed).length;

            document.getElementById('totalBalance').textContent = formatCurrency(balance);
            document.getElementById('todayTasksCount').textContent = todayTasks;
            document.getElementById('pendingTasks').textContent = pendingTasks;
            document.getElementById('activeMode').textContent = currentMode === 'personal' ? 'Pribadi' : 'Bisnis';
            
            refreshDashboardData();
        }
        
        function refreshDashboardData() {
            updateDashboardCharts();
            loadAnalysisCharts();
            loadRecentActivities();
        }

        function loadRecentActivities() {
            const appData = storage.getAppData();
            const modeData = appData[currentMode];
            const activities = [];

            const filteredTransactions = filterDataByRange(modeData.transactions, masterDateRange, 'date');
            const filteredTasks = filterDataByRange(modeData.tasks, masterDateRange, 'datetime');
            const filteredSplits = filterDataByRange(modeData.splitBills, masterDateRange, 'date');
            const filteredDiary = filterDataByRange(modeData.diaryEntries, masterDateRange, 'date');

            filteredTransactions.forEach(t => activities.push({ type: 'transaction', icon: t.type === 'income' ? 'fa-arrow-up text-green-500' : 'fa-arrow-down text-pink-500', text: `${t.type === 'income' ? 'Pemasukan' : 'Pengeluaran'}: ${formatCurrency(t.amount)}`, time: t.date }));
            filteredTasks.forEach(p => activities.push({ type: 'task', icon: 'fa-calendar-check text-blue-500', text: `Tugas: ${p.title}`, time: p.datetime }));
            filteredSplits.forEach(s => activities.push({ type: 'split', icon: 'fa-receipt text-green-500', text: `Split Bill: ${formatCurrency(s.totalBill)}`, time: s.date }));
            filteredDiary.forEach(d => activities.push({ type: 'diary', icon: 'fa-book text-purple-500', text: `Diary: ${d.title}`, time: d.date }));

            activities.sort((a, b) => new Date(b.time) - new Date(a.time));
            const container = document.getElementById('recentActivities');
            container.innerHTML = activities.length > 0 ? activities.slice(0, 15).map(activity => `<div class="flex items-center justify-between p-2 hover:bg-purple-500/10 rounded"><div class="flex items-center"><i class="fas ${activity.icon} mr-3"></i><span>${activity.text}</span></div><span class="text-sm text-gray-400">${formatDate(activity.time)}</span></div>`).join('') : '<p class="text-gray-500">Tidak ada aktivitas dalam rentang waktu ini.</p>';
        }

        // --- FINANCE ---
        function loadFinancePage() {
            populateFinanceFilters();
            filterAndRenderTransactions();
            updateFinanceSummary();
        }
        
        function updateFinanceSummary() {
            const appData = storage.getAppData();
            const transactions = appData[currentMode].transactions;
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            document.getElementById('totalIncome').textContent = formatCurrency(income);
            document.getElementById('totalExpense').textContent = formatCurrency(expense);
            document.getElementById('balance').textContent = formatCurrency(income - expense);
        }

        function filterAndRenderTransactions() {
            const appData = storage.getAppData();
            let transactions = appData[currentMode].transactions;
            
            const search = document.getElementById('searchTransaction').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const type = document.getElementById('typeFilter').value;
            
            if (search) transactions = transactions.filter(t => t.description.toLowerCase().includes(search));
            if (category) transactions = transactions.filter(t => t.category === category);
            if (type) transactions = transactions.filter(t => t.type === type);
            
            if (customDateRange.start && customDateRange.end) {
                transactions = transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate >= new Date(customDateRange.start) && tDate <= new Date(customDateRange.end);
                });
            }
            
            displayTransactions(transactions);
        }

        function displayTransactions(transactions) {
            const container = document.getElementById('transactionsList');
            if (transactions.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">Belum ada transmisi data</p>';
                return;
            }
            container.innerHTML = [...transactions].reverse().map(t => `
                <div class="p-4 rounded-md flex justify-between items-center hover:bg-purple-500/10 cursor-pointer ${t.type}" onclick="showTransactionModal('${t.id}')">
                    <div class="flex items-center">
                        <i class="fas ${getTransactionIcon(t.category)} mr-4 text-xl"></i>
                        <div>
                            <h4 class="font-semibold">${t.description}</h4>
                            <p class="text-sm text-gray-400">${getCategoryName(t.category)} â€¢ ${formatDate(t.date)}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold font-mono ${t.type === 'income' ? 'text-green-500' : 'text-pink-500'}">${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}</p>
                        <button onclick="confirmDeleteTransaction('${t.id}', event)" class="text-red-500 hover:text-red-400 ml-2 text-xs"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`).join('');
        }

        function showTransactionModal(id = null) {
            const appData = storage.getAppData();
            const transaction = id ? appData[currentMode].transactions.find(t => t.id === id) : null;
            const content = `
                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold text-purple-600">${id ? 'Edit' : 'Tambah'} Transaksi</h3><button class="closeModal text-gray-400 hover:text-purple-600"><i class="fas fa-times"></i></button></div>
                <form id="transactionForm" class="space-y-4">
                    <input type="hidden" id="transactionId" value="${id || ''}">
                    <div><label class="block text-sm font-medium mb-1">Tipe</label><select id="transactionType" class="custom-input" required>${['income', 'expense'].map(o => `<option value="${o}" ${transaction?.type === o ? 'selected' : ''}>${o === 'income' ? 'Pemasukan' : 'Pengeluaran'}</option>`).join('')}</select></div>
                    <div><label class="block text-sm font-medium mb-1">Jumlah</label><input type="number" id="transactionAmount" class="custom-input" value="${transaction?.amount || ''}" required></div>
                    <div><label class="block text-sm font-medium mb-1">Kategori</label><select id="transactionCategory" class="custom-input" required>${Object.keys(getCategoryName()).map(c => `<option value="${c}" ${transaction?.category === c ? 'selected' : ''}>${getCategoryName(c)}</option>`).join('')}</select></div>
                    <div><label class="block text-sm font-medium mb-1">Deskripsi</label><input type="text" id="transactionDescription" class="custom-input" value="${transaction?.description || ''}" required></div>
                    <div><label class="block text-sm font-medium mb-1">Tanggal</label><input type="date" id="transactionDate" class="custom-input" value="${transaction?.date || new Date().toISOString().split('T')[0]}" required></div>
                    <div class="flex gap-2 mt-6"><button type="submit" class="custom-button flex-1">Simpan</button><button type="button" class="closeModal custom-button custom-button-danger">Batal</button></div>
                </form>`;
            showModal(content);
            document.getElementById('transactionForm').addEventListener('submit', saveTransaction);
        }

        function saveTransaction(e) {
            e.preventDefault();
            const id = document.getElementById('transactionId').value || generateId();
            const newTransaction = {
                id,
                type: document.getElementById('transactionType').value,
                amount: parseFloat(document.getElementById('transactionAmount').value),
                category: document.getElementById('transactionCategory').value,
                description: document.getElementById('transactionDescription').value,
                date: document.getElementById('transactionDate').value,
            };

            let appData = storage.getAppData();
            if (document.getElementById('transactionId').value) {
                const index = appData[currentMode].transactions.findIndex(t => t.id === id);
                if (index > -1) appData[currentMode].transactions[index] = newTransaction;
            } else {
                appData[currentMode].transactions.push(newTransaction);
            }
            storage.saveAppData(appData);
            loadFinancePage();
            closeModal();
            showMessage("Transaksi disimpan!", "success");
        }

        function confirmDeleteTransaction(id, event) {
            event.stopPropagation();
            showConfirm('Hapus Transaksi?', 'Yakin ingin menghapus transmisi data ini?', () => deleteTransaction(id));
        }

        function deleteTransaction(id) {
            let appData = storage.getAppData();
            appData[currentMode].transactions = appData[currentMode].transactions.filter(t => t.id !== id);
            storage.saveAppData(appData);
            loadFinancePage();
        }

        function populateFinanceFilters() {
            const appData = storage.getAppData();
            const categories = [...new Set(appData[currentMode].transactions.map(t => t.category))];
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="">Semua Kategori</option>' + categories.map(c => `<option value="${c}">${getCategoryName(c)}</option>`).join('');
            
            const typeFilter = document.getElementById('typeFilter');
            typeFilter.innerHTML = '<option value="">Semua Tipe</option><option value="income">Pemasukan</option><option value="expense">Pengeluaran</option>';
        }

        // --- TASKS & PLANS ---
        function loadTasksPage() {
            renderTasks();
            generateCalendar();
        }

        function renderTasks() {
            const appData = storage.getAppData();
            const tasks = appData[currentMode].tasks;
            const list = document.getElementById('taskList');
            list.innerHTML = '';
            
            const sortedTasks = [...tasks].sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
            
            if (sortedTasks.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center">Tidak ada tugas. Waktunya bersantai!</p>';
                return;
            }

            sortedTasks.forEach(task => {
                const item = document.createElement('div');
                item.className = `task-item p-3 rounded-lg flex justify-between items-center hover:bg-purple-500/10 ${task.completed ? 'completed' : ''}`;
                const priorityColor = { high: '#f472b6', medium: '#fbbf24', low: '#4ade80' };
                
                item.innerHTML = `
                    <div class="flex items-center">
                        <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask('${task.id}')" class="w-5 h-5 rounded bg-purple-900/50 border-purple-400 text-purple-600 focus:ring-purple-500">
                        <div class="ml-4">
                            <strong class="block">${task.title}</strong>
                            <small class="text-gray-400">${formatDateTime(task.datetime)} | <span style="color: ${priorityColor[task.priority]}">â—</span> ${task.priority}</small>
                        </div>
                    </div>
                    <button onclick="confirmDeleteTask('${task.id}')" class="text-red-500 hover:text-red-400"><i class="fas fa-trash"></i></button>
                `;
                list.appendChild(item);
            });
        }

        function saveTask(e) {
            e.preventDefault();
            const task = {
                id: generateId(),
                title: document.getElementById('taskTitle').value,
                datetime: document.getElementById('taskDateTime').value,
                priority: document.getElementById('taskPriority').value,
                completed: false,
            };
            
            let appData = storage.getAppData();
            appData[currentMode].tasks.push(task);
            storage.saveAppData(appData);
            
            renderTasks();
            generateCalendar();
            document.getElementById('taskForm').reset();
            showMessage("Tugas ditambahkan!", "success");
        }

        function toggleTask(id) {
            let appData = storage.getAppData();
            const task = appData[currentMode].tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                storage.saveAppData(appData);
                renderTasks();
                generateCalendar();
            }
        }
        
        function confirmDeleteTask(id) {
            showConfirm('Hapus Tugas?', 'Yakin ingin menghapus tugas ini?', () => deleteTask(id));
        }

        function deleteTask(id) {
            let appData = storage.getAppData();
            appData[currentMode].tasks = appData[currentMode].tasks.filter(t => t.id !== id);
            storage.saveAppData(appData);
            renderTasks();
            generateCalendar();
        }

        // --- CALENDAR ---
        function generateCalendar() {
            const calendar = document.getElementById('calendar');
            document.getElementById('currentMonth').textContent = new Intl.DateTimeFormat('id-ID', { month: 'long', year: 'numeric' }).format(currentDate);
            calendar.innerHTML = '';
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const appData = storage.getAppData();
            const tasks = appData[currentMode].tasks;

            const days = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
            days.forEach(day => calendar.innerHTML += `<div class="text-center font-bold text-purple-400 text-sm">${day}</div>`);
            
            for (let i = 0; i < firstDay; i++) calendar.innerHTML += '<div></div>';
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayTasks = tasks.filter(t => t.datetime && t.datetime.startsWith(dateStr));
                const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
                
                let dayClass = 'text-center p-2 border border-transparent rounded-md transition-colors duration-300 relative';
                if (isToday) dayClass += ' border-purple-400 bg-purple-500/10';

                let priorityIndicator = '';
                if (dayTasks.length > 0) {
                    const hasHigh = dayTasks.some(t => t.priority === 'high' && !t.completed);
                    const hasMedium = dayTasks.some(t => t.priority === 'medium' && !t.completed);
                    const hasLow = dayTasks.some(t => t.priority === 'low' && !t.completed);

                    let indicatorColor = '';
                    if (hasHigh) indicatorColor = '#f472b6';
                    else if (hasMedium) indicatorColor = '#fbbf24';
                    else if (hasLow) indicatorColor = '#4ade80';
                    
                    if (indicatorColor) {
                        priorityIndicator = `<span class="absolute top-1 right-1 h-2 w-2 rounded-full" style="background-color: ${indicatorColor};"></span>`;
                    }
                }

                calendar.innerHTML += `<div class="${dayClass}">${day}${priorityIndicator}</div>`;
            }
        }
        
        function changeMonth(dir) {
            currentDate.setMonth(currentDate.getMonth() + dir);
            generateCalendar();
        }

        // --- POMODORO TIMER ---
        function startTimer() {
            if (isTimerRunning) return;
            isTimerRunning = true;
            timerInterval = setInterval(() => {
                if (timerSeconds === 0) {
                    if (timerMinutes === 0) {
                        resetTimer();
                        showMessage("Pomodoro Selesai!", "success");
                        return;
                    }
                    timerMinutes--;
                    timerSeconds = 59;
                } else {
                    timerSeconds--;
                }
                updateTimerDisplay();
            }, 1000);
        }

        function pauseTimer() { isTimerRunning = false; clearInterval(timerInterval); }
        function resetTimer() { pauseTimer(); timerMinutes = 25; timerSeconds = 0; updateTimerDisplay(); }
        function updateTimerDisplay() { document.getElementById('timerDisplay').textContent = `${String(timerMinutes).padStart(2, '0')}:${String(timerSeconds).padStart(2, '0')}`; }

        // --- SPLIT BILL ---
        function loadSplitPage() { renderSplitHistory(); }

        function calculateSplitBill(e) {
            e.preventDefault();
            const totalBill = parseFloat(document.getElementById('totalBill').value);
            const peopleNames = document.getElementById('peopleNames').value.split(',').map(name => name.trim()).filter(name => name);
            const percentagesStr = document.getElementById('splitPercentages').value;
            const percentages = percentagesStr ? percentagesStr.split(',').map(p => parseFloat(p.trim())) : [];

            if (peopleNames.length === 0) {
                showMessage('Harap masukkan setidaknya satu nama.', 'error');
                return;
            }

            let results;

            if (percentages.length > 0) {
                if (percentages.length !== peopleNames.length) {
                    showMessage('Jumlah nama dan persentase harus sama.', 'error');
                    return;
                }
                const totalPercentage = percentages.reduce((sum, p) => sum + p, 0);
                if (Math.round(totalPercentage) !== 100) {
                    showMessage(`Total persentase harus 100%, bukan ${totalPercentage}%.`, 'error');
                    return;
                }
                if (percentages.some(isNaN)) {
                    showMessage('Mohon masukkan persentase yang valid.', 'error');
                    return;
                }

                results = peopleNames.map((name, index) => ({
                    name,
                    amount: (totalBill * percentages[index]) / 100,
                    percentage: percentages[index]
                }));

            } else {
                const amountPerPerson = totalBill / peopleNames.length;
                results = peopleNames.map(name => ({
                    name,
                    amount: amountPerPerson
                }));
            }
            
            const splitBill = { id: generateId(), totalBill, results, date: new Date().toISOString().split('T')[0], type: percentages.length > 0 ? 'custom' : 'equal' };
            let appData = storage.getAppData();
            appData[currentMode].splitBills.push(splitBill);
            storage.saveAppData(appData);

            displaySplitResults(results, totalBill);
            renderSplitHistory();
            document.getElementById('splitBillForm').reset();
        }

        function displaySplitResults(results, totalBill) {
            const resultDiv = document.getElementById('splitResult');
            resultDiv.innerHTML = `<h4 class="font-bold mb-2">Total: ${formatCurrency(totalBill)}</h4>` + results.map(r => `
                <div class="flex justify-between p-2 border-b border-purple-900/50">
                    <span>${r.name} ${r.percentage ? `(${r.percentage}%)` : ''}</span>
                    <strong>${formatCurrency(r.amount)}</strong>
                </div>
            `).join('');
            document.getElementById('splitResultCard').classList.remove('hidden');
            document.getElementById('exportSplitBtn').onclick = () => exportSplitBillPDF(results, totalBill);
        }

        function renderSplitHistory() {
            const appData = storage.getAppData();
            const history = appData[currentMode].splitBills;
            const container = document.getElementById('splitHistory');
            container.innerHTML = [...history].reverse().map(split => `
                <div class="p-3 rounded-md border border-purple-900/50 hover:bg-purple-500/10">
                    <div class="flex justify-between items-center">
                        <div>
                            <strong class="block text-blue-400">${formatCurrency(split.totalBill)}</strong>
                            <small class="text-gray-400">${formatDate(split.date)} | ${split.results.length} orang | <span class="font-semibold ${split.type === 'custom' ? 'text-pink-400' : 'text-green-400'}">${split.type === 'custom' ? 'Kustom' : 'Merata'}</span></small>
                        </div>
                        <button onclick="confirmDeleteSplit('${split.id}')" class="text-red-500 hover:text-red-400"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`).join('') || '<p class="text-gray-500 text-center">Tidak ada riwayat.</p>';
        }
        
        function confirmDeleteSplit(id) {
            showConfirm('Hapus Riwayat?', 'Yakin ingin menghapus riwayat split bill ini?', () => deleteSplit(id));
        }

        function deleteSplit(id) {
            let appData = storage.getAppData();
            appData[currentMode].splitBills = appData[currentMode].splitBills.filter(s => s.id !== id);
            storage.saveAppData(appData);
            renderSplitHistory();
        }

        // --- DIARY ---
        function renderDiary() {
            const appData = storage.getAppData();
            let entries = appData[currentMode].diaryEntries;
            const query = document.getElementById('searchDiary').value.toLowerCase();
            if (query) {
                entries = entries.filter(e => e.title.toLowerCase().includes(query) || e.content.toLowerCase().includes(query));
            }
            
            const container = document.getElementById('diaryEntries');
            container.innerHTML = [...entries].reverse().map(entry => `
                <div class="glass-effect p-6 cursor-pointer hover:border-pink-400/20" onclick="showDiaryModal('${entry.id}')">
                    <h4 class="text-xl font-bold text-pink-400">${entry.title}</h4>
                    <p class="text-sm text-gray-400 mb-2">${formatDate(entry.date)}</p>
                    <p class="truncate">${entry.content}</p>
                    ${entry.image ? '<i class="fas fa-image text-blue-400 mt-2"></i>' : ''}
                </div>`).join('') || '<p class="text-gray-500 text-center">Belum ada entri diary.</p>';
        }

        function showDiaryModal(id = null) {
            const appData = storage.getAppData();
            const entry = id ? appData[currentMode].diaryEntries.find(e => e.id === id) : null;
            const content = `
                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold text-purple-600">${id ? 'Edit' : 'Tambah'} Entri Diary</h3><button class="closeModal text-gray-400 hover:text-purple-600"><i class="fas fa-times"></i></button></div>
                <form id="diaryForm" class="space-y-4">
                    <input type="hidden" id="diaryId" value="${id || ''}">
                    ${entry?.image ? `<img src="${entry.image}" class="max-w-full rounded-md mb-4 max-h-48">` : ''}
                    <div><label class="block text-sm font-medium mb-1">Judul</label><input type="text" id="diaryTitle" class="custom-input" value="${entry?.title || ''}" required></div>
                    <div><label class="block text-sm font-medium mb-1">Tanggal</label><input type="date" id="diaryDate" class="custom-input" value="${entry?.date || new Date().toISOString().split('T')[0]}" required></div>
                    <div><label class="block text-sm font-medium mb-1">Konten</label><textarea id="diaryContent" class="custom-input" rows="6" required>${entry?.content || ''}</textarea></div>
                    <div><label class="block text-sm font-medium mb-1">Gambar</label><input type="file" id="diaryImage" class="custom-input" accept="image/*"></div>
                    <div class="flex gap-2 mt-6">
                        ${id ? `<button type="button" id="deleteDiaryBtn" class="custom-button custom-button-danger">Hapus</button>` : ''}
                        <button type="submit" class="custom-button flex-1">Simpan</button>
                        <button type="button" class="closeModal custom-button custom-button-danger">Batal</button>
                    </div>
                </form>`;
            showModal(content);
            document.getElementById('diaryForm').addEventListener('submit', saveDiaryEntry);
            if (id) {
                document.getElementById('deleteDiaryBtn').addEventListener('click', () => confirmDeleteDiary(id));
            }
        }

        function saveDiaryEntry(e) {
            e.preventDefault();
            const id = document.getElementById('diaryId').value || generateId();
            const imageFile = document.getElementById('diaryImage').files[0];
            
            const entryData = {
                id,
                title: document.getElementById('diaryTitle').value,
                date: document.getElementById('diaryDate').value,
                content: document.getElementById('diaryContent').value,
            };

            const processSave = (imageData) => {
                if (imageData) entryData.image = imageData;
                let appData = storage.getAppData();
                if (document.getElementById('diaryId').value) {
                    const index = appData[currentMode].diaryEntries.findIndex(e => e.id === id);
                    const existingImage = appData[currentMode].diaryEntries[index].image;
                    entryData.image = imageData || existingImage;
                    if (index > -1) appData[currentMode].diaryEntries[index] = entryData;
                } else {
                    appData[currentMode].diaryEntries.push(entryData);
                }
                storage.saveAppData(appData);
                renderDiary();
                closeModal();
                showMessage("Entri diary disimpan!", "success");
            };

            if (imageFile) {
                const reader = new FileReader();
                reader.onload = (e) => processSave(e.target.result);
                reader.readAsDataURL(imageFile);
            } else {
                processSave(null);
            }
        }
        
        function confirmDeleteDiary(id) {
            showConfirm('Hapus Entri?', 'Yakin ingin menghapus entri diary ini?', () => deleteDiaryEntry(id));
        }

        function deleteDiaryEntry(id) {
            let appData = storage.getAppData();
            appData[currentMode].diaryEntries = appData[currentMode].diaryEntries.filter(e => e.id !== id);
            storage.saveAppData(appData);
            renderDiary();
            closeModal();
        }

        // --- SETTINGS & DATA MANAGEMENT ---
        function backupData() {
            const data = storage.get('lifeHubData_v3');
            if (!data) {
                showMessage("Tidak ada data untuk di-backup.", "error");
                return;
            }
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lifehub-backup-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showMessage("Backup berhasil!", "success");
        }

        function restoreData() {
            const file = document.getElementById('restoreFile').files[0];
            if (!file) {
                showMessage("Pilih file untuk restore.", "error");
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.personal && data.business) {
                        storage.saveAppData(data);
                        initializeApp();
                        showMessage("Restore berhasil!", "success");
                    } else {
                        throw new Error("Invalid file structure");
                    }
                } catch (err) {
                    showMessage("File backup korup atau tidak valid.", "error");
                }
            };
            reader.readAsText(file);
        }

        function clearAllDataConfirmed() {
            localStorage.removeItem('lifeHubData_v3');
            initializeApp();
            showMessage("Semua data telah dihapus.", "success");
        }
        
        // --- BACKGROUND MEDIA ---
        function applyUploadedMedia() {
            const bgUploadMediaInput = document.getElementById('bg-upload-media');
            const selectedMediaFile = bgUploadMediaInput.files[0];

            if (!selectedMediaFile) {
                showMessage('Silakan pilih file terlebih dahulu!', 'error');
                return;
            }
            
            const appData = storage.getAppData();
            const fileUrl = URL.createObjectURL(selectedMediaFile);
            const bgVideo = document.getElementById('bg-video');
            const bgImageLayer = document.getElementById('bg-image-layer');

            resetBackgrounds();

            if (selectedMediaFile.type.startsWith('image/')) {
                bgImageLayer.style.backgroundImage = `url('${fileUrl}')`;
                bgImageLayer.style.display = 'block';
                document.body.classList.remove('gradient-bg');
                showMessage('Gambar diterapkan sebagai background.', 'success');
            } else if (selectedMediaFile.type.startsWith('video/')) {
                bgVideo.src = fileUrl;
                bgVideo.muted = appData.isVideoMuted;
                bgVideo.style.display = 'block';
                bgVideo.play().catch(e => console.error("Gagal memutar video:", e));
                document.body.classList.remove('gradient-bg');
                showMessage('Video diterapkan sebagai background.', 'success');
            } else {
                showMessage('Format file tidak didukung. Harap pilih gambar atau video.', 'error');
            }
        }
        
        function resetBackgroundMedia() {
            resetBackgrounds();
            document.getElementById('bg-upload-media').value = '';
            document.body.classList.add('gradient-bg');
            showMessage('Background direset.', 'info');
        }

        function resetBackgrounds() {
            const bgVideo = document.getElementById('bg-video');
            const bgImageLayer = document.getElementById('bg-image-layer');
            
            bgVideo.pause();
            bgVideo.removeAttribute('src');
            bgVideo.style.display = 'none';

            bgImageLayer.style.backgroundImage = 'none';
            bgImageLayer.style.display = 'none';
        }

        function toggleVideoSound() {
            const video = document.getElementById('bg-video');
            video.muted = !video.muted;
            
            let appData = storage.getAppData();
            appData.isVideoMuted = video.muted;
            storage.saveAppData(appData);

            updateVideoSoundUI();
            showMessage(video.muted ? 'Suara video dimatikan.' : 'Suara video diaktifkan.', 'info');
        }

        function updateVideoSoundUI() {
            const appData = storage.getAppData();
            const btn = document.getElementById('toggleVideoSoundBtn');
            const icon = btn.querySelector('i');
            const text = btn.querySelector('span');

            if (appData.isVideoMuted) {
                icon.classList.remove('fa-volume-up');
                icon.classList.add('fa-volume-mute');
                text.textContent = 'Aktifkan Suara Video';
            } else {
                icon.classList.remove('fa-volume-mute');
                icon.classList.add('fa-volume-up');
                text.textContent = 'Matikan Suara Video';
            }
        }

        // --- PDF EXPORT ---
        function exportFinancePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const appData = storage.getAppData();
            const transactions = appData[currentMode].transactions;

            doc.setFontSize(20);
            doc.text('Laporan Keuangan', 20, 20);
            doc.setFontSize(12);
            doc.text(`Mode: ${currentMode === 'personal' ? 'Pribadi' : 'Bisnis'}`, 20, 30);
            doc.text(`Tanggal: ${formatDate(new Date().toISOString())}`, 20, 40);

            const tableData = transactions.map(t => [
                formatDate(t.date),
                t.description,
                getCategoryName(t.category),
                t.type === 'income' ? formatCurrency(t.amount) : '',
                t.type === 'expense' ? formatCurrency(t.amount) : ''
            ]);
            
            doc.autoTable({
                head: [['Tanggal', 'Deskripsi', 'Kategori', 'Pemasukan', 'Pengeluaran']],
                body: tableData,
                startY: 50
            });

            doc.save(`laporan-keuangan-${currentMode}.pdf`);
        }
        
        function exportSplitBillPDF(results, totalBill) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text('Laporan Split Bill', 20, 20);
            doc.text(`Total Tagihan: ${formatCurrency(totalBill)}`, 20, 30);
            
            const tableData = results.map(r => [r.name, formatCurrency(r.amount)]);
            doc.autoTable({
                head: [['Nama', 'Jumlah Bayar']],
                body: tableData,
                startY: 40
            });
            doc.save('split-bill.pdf');
        }
        
        function exportDiaryPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const appData = storage.getAppData();
            const entries = appData[currentMode].diaryEntries;
            
            doc.text('Ekspor Diary', 20, 20);
            let y = 30;
            
            entries.forEach(entry => {
                if (y > 250) { doc.addPage(); y = 20; }
                doc.setFontSize(14);
                doc.text(entry.title, 20, y);
                y += 7;
                doc.setFontSize(10);
                doc.text(formatDate(entry.date), 20, y);
                y += 10;
                doc.setFontSize(12);
                const lines = doc.splitTextToSize(entry.content, 170);
                doc.text(lines, 20, y);
                y += (lines.length * 5) + 10;
            });
            
            doc.save(`diary-${currentMode}.pdf`);
        }

        // --- CHARTS ---
        function getChartColors() {
            const isLight = document.body.classList.contains('light-mode');
            return {
                gridColor: isLight ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)',
                tickColor: isLight ? '#4b5563' : '#d1d5db',
                legendColor: isLight ? '#1f2937' : '#d1d5db',
                incomeColor: isLight ? '#22c55e' : '#4ade80',
                expenseColor: isLight ? '#ec4899' : '#f472b6',
                taskColor: isLight ? '#3b82f6' : '#60a5fa',
                incomeBg: isLight ? 'rgba(34, 197, 94, 0.2)' : 'rgba(74, 222, 128, 0.2)',
                expenseBg: isLight ? 'rgba(236, 72, 153, 0.2)' : 'rgba(244, 114, 182, 0.2)',
                taskBg: isLight ? 'rgba(59, 130, 246, 0.7)' : 'rgba(96, 165, 250, 0.7)',
            };
        }

        function updateDashboardCharts() {
            updateCashFlowChart();
            updateProductivityChart();
        }

        function updateCashFlowChart() {
            const ctx = document.getElementById('cashFlowChart')?.getContext('2d');
            if (!ctx) return;
            if (window.cashFlowChartInstance) window.cashFlowChartInstance.destroy();

            const colors = getChartColors();
            const appData = storage.getAppData();
            let transactions = filterDataByRange(appData[currentMode].transactions, masterDateRange, 'date');
            
            const { labels, dataPoints } = getDateRangeAndLabels(masterDateRange, customDateRange, transactions.map(t => ({date: t.date})));
            const incomeData = new Array(labels.length).fill(0);
            const expenseData = new Array(labels.length).fill(0);

            transactions.forEach(t => {
                const tDate = new Date(t.date + 'T00:00:00'); 
                const dateStr = t.date;
                const index = dataPoints.findIndex(dp => {
                    if (dp instanceof Date) { 
                        const dpEnd = new Date(dp);
                        if (getGroupingUnit(masterDateRange, customDateRange) === 'week') dpEnd.setDate(dp.getDate() + 7);
                        else if (getGroupingUnit(masterDateRange, customDateRange) === 'month') dpEnd.setMonth(dp.getMonth() + 1);
                        return tDate >= dp && tDate < dpEnd;
                    }
                    return dp === dateStr; 
                });

                if (index !== -1) {
                    if (t.type === 'income') incomeData[index] += t.amount;
                    else expenseData[index] += t.amount;
                }
            });

            window.cashFlowChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'Pemasukan', data: incomeData, borderColor: colors.incomeColor, backgroundColor: colors.incomeBg, tension: 0.3, fill: true },
                        { label: 'Pengeluaran', data: expenseData, borderColor: colors.expenseColor, backgroundColor: colors.expenseBg, tension: 0.3, fill: true }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { color: colors.tickColor } },
                        x: { grid: { color: colors.gridColor }, ticks: { color: colors.tickColor } }
                    },
                    plugins: { legend: { labels: { color: colors.legendColor } } }
                }
            });
        }

        function updateProductivityChart() {
            const ctx = document.getElementById('productivityChart')?.getContext('2d');
            if (!ctx) return;
            if (window.productivityChartInstance) window.productivityChartInstance.destroy();

            const colors = getChartColors();
            const appData = storage.getAppData();
            const tasks = filterDataByRange(appData[currentMode].tasks, masterDateRange, 'datetime');

            const { labels, dataPoints } = getDateRangeAndLabels(masterDateRange, customDateRange, tasks.map(t => ({date: t.datetime})));
            const completedCounts = new Array(labels.length).fill(0);
            
            tasks.filter(t => t.completed && t.datetime).forEach(t => {
                const tDate = new Date(t.datetime);
                const dateStr = t.datetime.split('T')[0];
                const index = dataPoints.findIndex(dp => {
                     if (dp instanceof Date) {
                        const dpEnd = new Date(dp);
                        if (getGroupingUnit(masterDateRange, customDateRange) === 'week') dpEnd.setDate(dp.getDate() + 7);
                        else if (getGroupingUnit(masterDateRange, customDateRange) === 'month') dpEnd.setMonth(dp.getMonth() + 1);
                        return tDate >= dp && tDate < dpEnd;
                    }
                    return dp === dateStr;
                });

                if (index !== -1) completedCounts[index]++;
            });

            window.productivityChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Tugas Selesai',
                        data: completedCounts,
                        backgroundColor: colors.taskBg,
                        borderColor: colors.taskColor,
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1, color: colors.tickColor }, grid: { color: colors.gridColor } },
                        x: { ticks: { color: colors.tickColor }, grid: { color: colors.gridColor } }
                    },
                    plugins: { legend: { labels: { color: colors.legendColor } } }
                }
            });
        }

        // --- FUNGSI UNTUK HALAMAN ANALISIS DATA ---
        function loadAnalysisCharts() {
            const appData = storage.getAppData();
            const modeData = appData[currentMode];
            const colors = getChartColors();

            Chart.defaults.color = colors.legendColor;
            Chart.defaults.font.family = "'Poppins', 'sans-serif'";

            const chartIds = ['combinedAnalysisChart', 'incomeVsExpenseChart', 'spendingByCategoryChart', 'taskCompletionTrendChart', 'taskPriorityDistributionChart', 'splitBillByUserChart', 'splitBillFrequencyChart', 'diaryEntryFrequencyChart'];
            chartIds.forEach(id => {
                if (window[id + 'Instance']) window[id + 'Instance'].destroy();
            });
            
            // 1. Analisis Gabungan
            const filteredPersonalTransactions = filterDataByRange(appData.personal.transactions, masterDateRange, 'date');
            const filteredPersonalTasks = filterDataByRange(appData.personal.tasks, masterDateRange, 'datetime');
            const filteredPersonalSplits = filterDataByRange(appData.personal.splitBills, masterDateRange, 'date');
            const filteredPersonalDiary = filterDataByRange(appData.personal.diaryEntries, masterDateRange, 'date');
            
            const filteredBusinessTransactions = filterDataByRange(appData.business.transactions, masterDateRange, 'date');
            const filteredBusinessTasks = filterDataByRange(appData.business.tasks, masterDateRange, 'datetime');
            const filteredBusinessSplits = filterDataByRange(appData.business.splitBills, masterDateRange, 'date');
            const filteredBusinessDiary = filterDataByRange(appData.business.diaryEntries, masterDateRange, 'date');

            const personalData = {
                finance: filteredPersonalTransactions.length, tasks: filteredPersonalTasks.length,
                splitBill: filteredPersonalSplits.length, diary: filteredPersonalDiary.length,
            };
            const businessData = {
                finance: filteredBusinessTransactions.length, tasks: filteredBusinessTasks.length,
                splitBill: filteredBusinessSplits.length, diary: filteredBusinessDiary.length,
            };

            const combinedCtx = document.getElementById('combinedAnalysisChart').getContext('2d');
            window.combinedAnalysisChartInstance = new Chart(combinedCtx, {
                type: 'radar',
                data: {
                    labels: ['Keuangan', 'Tugas', 'Split Bill', 'Diary'],
                    datasets: [
                        { label: 'Pribadi', data: [personalData.finance, personalData.tasks, personalData.splitBill, personalData.diary], backgroundColor: 'rgba(0, 136, 255, 0.2)', borderColor: '#0088ff', borderWidth: 2, pointBackgroundColor: '#0088ff', pointRadius: 4, },
                        { label: 'Bisnis', data: [businessData.finance, businessData.tasks, businessData.splitBill, businessData.diary], backgroundColor: 'rgba(255, 0, 110, 0.2)', borderColor: '#ff006e', borderWidth: 2, pointBackgroundColor: '#ff006e', pointRadius: 4, }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20, font: { size: 14 } } } },
                    scales: { r: { angleLines: { color: colors.gridColor }, grid: { color: colors.gridColor }, pointLabels: { font: { size: 14, weight: '600' }, color: colors.tickColor }, ticks: { backdropColor: 'rgba(0,0,0,0.5)', color: colors.tickColor, stepSize: 5 }, suggestedMin: 0 } }
                }
            });

            // 2. Analisis Keuangan
            const filteredFinance = filterDataByRange(modeData.transactions, masterDateRange, 'date');
            const incomeVsExpenseCtx = document.getElementById('incomeVsExpenseChart').getContext('2d');
            const { labels: monthLabels, data: financialData } = processMonthlyFinancials(filteredFinance, masterDateRange);
            window.incomeVsExpenseChartInstance = new Chart(incomeVsExpenseCtx, {
                type: 'bar', data: { labels: monthLabels, datasets: [ { label: 'Pemasukan', data: financialData.income, backgroundColor: 'rgba(74, 222, 128, 0.7)' }, { label: 'Pengeluaran', data: financialData.expense, backgroundColor: 'rgba(244, 114, 182, 0.7)' } ] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { grid: { color: colors.gridColor } } } }
            });

            const spendingCtx = document.getElementById('spendingByCategoryChart').getContext('2d');
            const { labels: categoryLabels, data: spendingData } = processSpendingByCategory(filteredFinance);
            window.spendingByCategoryChartInstance = new Chart(spendingCtx, {
                type: 'doughnut', data: { labels: categoryLabels, datasets: [{ data: spendingData, backgroundColor: ['#f472b6', '#60a5fa', '#fbbf24', '#4ade80', '#c084fc', '#a1a1aa', '#f87171', '#818cf8'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            // 3. Analisis Produktivitas
            const filteredTasks = filterDataByRange(modeData.tasks, masterDateRange, 'datetime');
            const taskTrendCtx = document.getElementById('taskCompletionTrendChart').getContext('2d');
            const { labels: taskMonthLabels, data: taskData } = processMonthlyTasks(filteredTasks, masterDateRange);
            window.taskCompletionTrendChartInstance = new Chart(taskTrendCtx, {
                type: 'line', data: { labels: taskMonthLabels, datasets: [ { label: 'Dibuat', data: taskData.created, borderColor: '#60a5fa', tension: 0.3 }, { label: 'Selesai', data: taskData.completed, borderColor: '#4ade80', tension: 0.3 } ] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { stepSize: 1 } } } }
            });

            const taskPriorityCtx = document.getElementById('taskPriorityDistributionChart').getContext('2d');
            const { labels: priorityLabels, data: priorityData } = processTaskPriorities(filteredTasks);
            window.taskPriorityDistributionChartInstance = new Chart(taskPriorityCtx, {
                type: 'pie', data: { labels: priorityLabels, datasets: [{ data: priorityData, backgroundColor: ['#f472b6', '#fbbf24', '#4ade80'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            // 4. Analisis Split Bill
            const filteredSplits = filterDataByRange(modeData.splitBills, masterDateRange, 'date');
            const splitByUserCtx = document.getElementById('splitBillByUserChart').getContext('2d');
            const { labels: userLabels, data: userSpendingData } = processSplitBillByUser(filteredSplits);
            window.splitBillByUserChartInstance = new Chart(splitByUserCtx, {
                type: 'bar', data: { labels: userLabels, datasets: [{ label: 'Total Pengeluaran', data: userSpendingData, backgroundColor: 'rgba(74, 222, 128, 0.7)', borderRadius: 5 }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { grid: { color: colors.gridColor } }, y: { grid: { display: false } } }, plugins: { legend: { display: false } } }
            });

            const splitFreqCtx = document.getElementById('splitBillFrequencyChart').getContext('2d');
            const { labels: splitMonthLabels, data: splitFreqData } = processSplitBillFrequency(filteredSplits, masterDateRange);
            window.splitBillFrequencyChartInstance = new Chart(splitFreqCtx, {
                type: 'line', data: { labels: splitMonthLabels, datasets: [{ label: 'Jumlah Split Bill', data: splitFreqData, borderColor: '#22d3ee', tension: 0.3, fill: true, backgroundColor: 'rgba(34, 211, 238, 0.2)' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { stepSize: 1 } } } }
            });

            // 5. Analisis Diary
            const filteredDiary = filterDataByRange(modeData.diaryEntries, masterDateRange, 'date');
            const diaryCtx = document.getElementById('diaryEntryFrequencyChart').getContext('2d');
            const { labels: diaryMonthLabels, data: diaryData } = processMonthlyDiaryEntries(filteredDiary, masterDateRange);
            window.diaryEntryFrequencyChartInstance = new Chart(diaryCtx, {
                type: 'bar', data: { labels: diaryMonthLabels, datasets: [{ label: 'Jumlah Entri', data: diaryData, backgroundColor: 'rgba(192, 132, 252, 0.7)', borderRadius: 5 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { stepSize: 1 } } } }
            });
        }

        // --- FUNGSI PEMROSESAN DATA UNTUK ANALISIS ---
        function processMonthlyFinancials(transactions, range) {
            const { labels, dataPoints } = getDateRangeAndLabels(range, customDateRange, transactions.map(t => ({date: t.date})));
            const income = new Array(labels.length).fill(0);
            const expense = new Array(labels.length).fill(0);
            
            transactions.forEach(t => {
                const tDate = new Date(t.date);
                const index = dataPoints.findIndex(dp => tDate >= dp && tDate < new Date(dp).setMonth(dp.getMonth()+1));
                if(index > -1) {
                    if (t.type === 'income') income[index] += t.amount;
                    else expense[index] += t.amount;
                }
            });
            return { labels, data: { income, expense } };
        }

        function processSpendingByCategory(transactions) {
            const spending = {};
            transactions.filter(t => t.type === 'expense').forEach(t => {
                const categoryName = getCategoryName(t.category);
                spending[categoryName] = (spending[categoryName] || 0) + t.amount;
            });
            const sortedSpending = Object.entries(spending).sort(([,a],[,b]) => b-a);
            return {
                labels: sortedSpending.map(([label]) => label),
                data: sortedSpending.map(([,data]) => data)
            };
        }

        function processMonthlyTasks(tasks, range) {
            const { labels, dataPoints } = getDateRangeAndLabels(range, customDateRange, tasks.map(t => ({date: t.datetime})));
            const created = new Array(labels.length).fill(0);
            const completed = new Array(labels.length).fill(0);

            tasks.forEach(t => {
                if(!t.datetime) return;
                const tDate = new Date(t.datetime);
                const index = dataPoints.findIndex(dp => tDate >= dp && tDate < new Date(dp).setMonth(dp.getMonth()+1));
                if (index > -1) {
                    created[index]++;
                    if (t.completed) completed[index]++;
                }
            });
            return { labels, data: { created, completed } };
        }

        function processTaskPriorities(tasks) {
            const priorities = { high: 0, medium: 0, low: 0 };
            tasks.filter(t => !t.completed).forEach(t => {
                priorities[t.priority]++;
            });
            return {
                labels: ['Tinggi', 'Sedang', 'Rendah'],
                data: [priorities.high, priorities.medium, priorities.low]
            };
        }
        
        function processMonthlyDiaryEntries(entries, range) {
             const { labels, dataPoints } = getDateRangeAndLabels(range, customDateRange, entries.map(e => ({date: e.date})));
            const data = new Array(labels.length).fill(0);
            entries.forEach(e => {
                const eDate = new Date(e.date);
                const index = dataPoints.findIndex(dp => eDate >= dp && eDate < new Date(dp).setMonth(dp.getMonth()+1));
                if (index > -1) data[index]++;
            });
            return { labels, data };
        }

        function processSplitBillByUser(splitBills) {
            const userTotals = {};
            splitBills.forEach(bill => {
                bill.results.forEach(person => {
                    userTotals[person.name] = (userTotals[person.name] || 0) + person.amount;
                });
            });
            const sortedUsers = Object.entries(userTotals).sort(([,a],[,b]) => b-a);
            return {
                labels: sortedUsers.map(([label]) => label),
                data: sortedUsers.map(([,data]) => data)
            };
        }

        function processSplitBillFrequency(splitBills, range) {
            const { labels, dataPoints } = getDateRangeAndLabels(range, customDateRange, splitBills.map(s => ({date: s.date})));
            const data = new Array(labels.length).fill(0);

            splitBills.forEach(bill => {
                const billDate = new Date(bill.date);
                const index = dataPoints.findIndex(dp => billDate >= dp && billDate < new Date(dp).setMonth(dp.getMonth()+1));
                if (index > -1) data[index]++;
            });
            return { labels, data };
        }


        // --- UTILITY & HELPER FUNCTIONS ---
        function getGroupingUnit(range, customRange) {
            const currentRange = (typeof range === 'object' && range.type === 'custom') ? range : { type: 'preset', value: range };
            
            if (currentRange.type === 'custom') {
                const diffTime = Math.abs(new Date(currentRange.end) - new Date(currentRange.start));
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays > 90) return 'month';
                if (diffDays > 30) return 'week';
                return 'day';
            }
            if (['7d', '1m'].includes(currentRange.value)) return 'day';
            if (currentRange.value === '3m') return 'week';
            if (['1y', 'all', '6m'].includes(currentRange.value)) return 'month';
        }

        function getDateRangeAndLabels(range, customRange, data) {
            const labels = [];
            const dataPoints = [];
            const now = new Date();
            now.setHours(23, 59, 59, 999);
            
            const currentRange = (typeof range === 'object' && range.type === 'custom') ? range : { type: 'preset', value: range };

            if (currentRange.type === 'custom') {
                const start = new Date(currentRange.start);
                const end = new Date(currentRange.end);
                const unit = getGroupingUnit(range, customRange);
                let current = new Date(start);

                if (unit === 'day') {
                    while (current <= end) {
                        labels.push(current.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' }));
                        dataPoints.push(current.toISOString().split('T')[0]);
                        current.setDate(current.getDate() + 1);
                    }
                } else if (unit === 'week') {
                     while (current <= end) {
                        labels.push(`W${getWeekNumber(current)}`);
                        dataPoints.push(new Date(current));
                        current.setDate(current.getDate() + 7);
                    }
                } else if (unit === 'month') {
                    current = new Date(start.getFullYear(), start.getMonth(), 1);
                    while (current <= end) {
                        labels.push(current.toLocaleDateString('id-ID', { month: 'short', year: '2-digit' }));
                        dataPoints.push(new Date(current));
                        current.setMonth(current.getMonth() + 1);
                    }
                }
                return { labels, dataPoints };
            }

            switch (currentRange.value) {
                case '7d':
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date(); date.setDate(now.getDate() - i);
                        labels.push(date.toLocaleDateString('id-ID', { weekday: 'short' }));
                        dataPoints.push(date.toISOString().split('T')[0]);
                    }
                    return { labels, dataPoints };

                case '1m':
                    for (let i = 29; i >= 0; i--) {
                        const date = new Date(); date.setDate(now.getDate() - i);
                        labels.push(date.toLocaleDateString('id-ID', { day: 'numeric' }));
                        dataPoints.push(date.toISOString().split('T')[0]);
                    }
                    return { labels, dataPoints };

                case '3m':
                case '6m':
                case '1y':
                case 'all':
                    const months = {'3m': 3, '6m': 6, '1y': 12};
                    let firstDate = new Date();
                    if(currentRange.value === 'all') {
                        const validData = data.filter(d => d.date);
                        if(validData.length === 0) firstDate = new Date();
                        else firstDate = new Date(validData.reduce((min, p) => (p.date && p.date < min) ? p.date : min, validData[0].date));
                    } else {
                        firstDate.setMonth(now.getMonth() - (months[currentRange.value]));
                    }
                    
                    let currentDateIter = new Date(firstDate.getFullYear(), firstDate.getMonth(), 1);
                    while (currentDateIter <= now) {
                        labels.push(currentDateIter.toLocaleDateString('id-ID', { month: 'short', year: '2-digit' }));
                        dataPoints.push(new Date(currentDateIter));
                        currentDateIter.setMonth(currentDateIter.getMonth() + 1);
                    }
                    return { labels, dataPoints };
            }
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }

        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
        function formatCurrency(amount) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount); }
        function formatDate(dateString) { return dateString ? new Date(dateString + 'T00:00:00').toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' }) : ''; }
        function formatDateTime(dateString) { return dateString ? new Date(dateString).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }) : ''; }
        function getTransactionIcon(category) { const icons = { food: 'fa-utensils', transport: 'fa-car', entertainment: 'fa-gamepad', shopping: 'fa-shopping-bag', bills: 'fa-file-invoice', salary: 'fa-money-bill-wave', business: 'fa-briefcase', investment: 'fa-chart-line', other: 'fa-question' }; return icons[category] || 'fa-question'; }
        function getCategoryName(category = null) { const names = { food: 'Makanan', transport: 'Transport', entertainment: 'Hiburan', shopping: 'Belanja', bills: 'Tagihan', salary: 'Gaji', business: 'Bisnis', investment: 'Investasi', other: 'Lainnya' }; return category ? names[category] : names; }
        
        function showModal(content) {
            const modal = document.getElementById('mainModal');
            modal.querySelector('.modal-content').innerHTML = content;
            modal.classList.add('show');
            modal.querySelectorAll('.closeModal').forEach(btn => btn.addEventListener('click', closeModal));
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => modal.classList.remove('show'));
        }

        function showConfirm(title, message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            modal.classList.add('show');
            
            const yesBtn = document.getElementById('confirmYes');
            const noBtn = document.getElementById('confirmNo');

            const yesHandler = () => { onConfirm(); closeModal(); cleanup(); };
            const noHandler = () => { closeModal(); cleanup(); };
            const cleanup = () => {
                yesBtn.removeEventListener('click', yesHandler);
                noBtn.removeEventListener('click', noHandler);
            };

            yesBtn.addEventListener('click', yesHandler);
            noBtn.addEventListener('click', noHandler);
        }

        function showMessage(message, type = 'info') {
            const isLight = document.body.classList.contains('light-mode');
            const colors = { info: '#60a5fa', success: '#4ade80', error: '#f472b6' };
            const msgDiv = document.createElement('div');
            Object.assign(msgDiv.style, {
                position: 'fixed', bottom: '20px', right: '20px', padding: '15px',
                backgroundColor: isLight ? '#ffffff' : 'rgba(15, 10, 32, 0.8)',
                backdropFilter: 'blur(10px)', color: colors[type], border: `1px solid ${colors[type]}`,
                borderRadius: '8px', boxShadow: `0 4px 15px rgba(0,0,0,0.1)`, zIndex: '9999',
                transition: 'opacity 0.5s'
            });
            msgDiv.textContent = message;
            document.body.appendChild(msgDiv);
            setTimeout(() => {
                msgDiv.style.opacity = '0';
                setTimeout(() => msgDiv.remove(), 500);
            }, 3000);
        }

        function showDateRangeModal() {
            document.getElementById('dateRangeModal').classList.add('show');
        }

        function applyDateRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                showMessage('Harap pilih tanggal mulai dan selesai.', 'error');
                return;
            }
            if (new Date(startDate) > new Date(endDate)) {
                showMessage('Tanggal mulai tidak boleh setelah tanggal selesai.', 'error');
                return;
            }

            const rangeObject = { type: 'custom', start: startDate, end: endDate };
            masterDateRange = rangeObject;
            updateActiveButton('master-range-selector', 'custom');
            refreshDashboardData();
            
            document.getElementById('dateRangeModal').classList.remove('show');
        }

        function setupMasterRangeSelector() {
            document.querySelectorAll('#master-range-selector .range-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const range = e.currentTarget.dataset.range;
                    if (range === 'custom') {
                        showDateRangeModal();
                    } else {
                        updateActiveButton('master-range-selector', range);
                        masterDateRange = range;
                        customDateRange = {}; 
                        refreshDashboardData();
                    }
                });
            });
        }

        function updateActiveButton(selectorId, activeRange) {
            document.querySelectorAll(`#${selectorId} .range-btn`).forEach(b => b.classList.remove('active'));
            document.querySelector(`#${selectorId} .range-btn[data-range="${activeRange}"]`).classList.add('active');
        }

        function filterDataByRange(data, range, dateKey) {
            const currentRange = (typeof range === 'object' && range.type === 'custom') ? range : { type: 'preset', value: range };

            if (currentRange.value === 'all') return data;
            
            let startDate;
            if(currentRange.type === 'custom') {
                startDate = new Date(currentRange.start);
            } else {
                const now = new Date();
                startDate = new Date();
                if (currentRange.value === '7d') startDate.setDate(now.getDate() - 7);
                else if (currentRange.value === '1m') startDate.setMonth(now.getMonth() - 1);
                else if (currentRange.value === '3m') startDate.setMonth(now.getMonth() - 3);
                else if (currentRange.value === '6m') startDate.setMonth(now.getMonth() - 6);
                else if (currentRange.value === '1y') startDate.setFullYear(now.getFullYear() - 1);
            }
            
            const endDate = (currentRange.type === 'custom') ? new Date(currentRange.end) : new Date();

            return data.filter(item => {
                if (!item[dateKey]) return false;
                const itemDate = new Date(item[dateKey]);
                return itemDate >= startDate && itemDate <= endDate;
            });
        }

    </script>
</body>
</html>
